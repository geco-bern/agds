<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 9 Supervised machine learning | Applied Geodata Science</title>
  <meta name="description" content="This course prepares you to benefit from the general data richness in environmental and geo-sciences." />
  <meta name="generator" content="bookdown 0.31 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 9 Supervised machine learning | Applied Geodata Science" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This course prepares you to benefit from the general data richness in environmental and geo-sciences." />
  <meta name="github-repo" content="stineb/agsd" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 9 Supervised machine learning | Applied Geodata Science" />
  
  <meta name="twitter:description" content="This course prepares you to benefit from the general data richness in environmental and geo-sciences." />
  

<meta name="author" content="Benjamin Stocker (lead), Koen Hufkens (contributing), Pepa Aran (contributing), Pascal Schneider (contributing)" />


<meta name="date" content="2023-01-19" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="regression_classification.html"/>
<link rel="next" href="random_forest.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Applied Geodata Science</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About this book</a>
<ul>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#target-readers-of-this-book"><i class="fa fa-check"></i><b>0.1</b> Target readers of this book</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a>
<ul>
<li class="chapter" data-level="0.2" data-path="introduction.html"><a href="introduction.html#what-is-applied-geodata-science"><i class="fa fa-check"></i><b>0.2</b> What is Applied Geodata Science?</a></li>
<li class="chapter" data-level="0.3" data-path="introduction.html"><a href="introduction.html#data-science-workflow"><i class="fa fa-check"></i><b>0.3</b> The (data) science workflow</a></li>
<li class="chapter" data-level="0.4" data-path="introduction.html"><a href="introduction.html#data-rich-era"><i class="fa fa-check"></i><b>0.4</b> Why now?</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="getting_started.html"><a href="getting_started.html"><i class="fa fa-check"></i><b>1</b> Getting started</a>
<ul>
<li class="chapter" data-level="1.1" data-path="getting_started.html"><a href="getting_started.html#learning-objectives"><i class="fa fa-check"></i><b>1.1</b> Learning objectives</a></li>
<li class="chapter" data-level="1.2" data-path="getting_started.html"><a href="getting_started.html#tutorial"><i class="fa fa-check"></i><b>1.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="getting_started.html"><a href="getting_started.html#working-with-r-and-rstudio"><i class="fa fa-check"></i><b>1.2.1</b> Working with R and RStudio</a></li>
<li class="chapter" data-level="1.2.2" data-path="getting_started.html"><a href="getting_started.html#r-objects"><i class="fa fa-check"></i><b>1.2.2</b> R objects</a></li>
<li class="chapter" data-level="1.2.3" data-path="getting_started.html"><a href="getting_started.html#r-scripts"><i class="fa fa-check"></i><b>1.2.3</b> R scripts</a></li>
<li class="chapter" data-level="1.2.4" data-path="getting_started.html"><a href="getting_started.html#workspace-management"><i class="fa fa-check"></i><b>1.2.4</b> Workspace management</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="getting_started.html"><a href="getting_started.html#exercises"><i class="fa fa-check"></i><b>1.3</b> Exercises</a></li>
<li class="chapter" data-level="1.4" data-path="getting_started.html"><a href="getting_started.html#solutions"><i class="fa fa-check"></i><b>1.4</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="programming_primers.html"><a href="programming_primers.html"><i class="fa fa-check"></i><b>2</b> Programming primers</a>
<ul>
<li class="chapter" data-level="2.1" data-path="programming_primers.html"><a href="programming_primers.html#learning-objectives-1"><i class="fa fa-check"></i><b>2.1</b> Learning objectives</a></li>
<li class="chapter" data-level="2.2" data-path="programming_primers.html"><a href="programming_primers.html#tutorial-1"><i class="fa fa-check"></i><b>2.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="programming_primers.html"><a href="programming_primers.html#libraries"><i class="fa fa-check"></i><b>2.2.1</b> Libraries</a></li>
<li class="chapter" data-level="2.2.2" data-path="programming_primers.html"><a href="programming_primers.html#programming-basics"><i class="fa fa-check"></i><b>2.2.2</b> Programming basics</a></li>
<li class="chapter" data-level="2.2.3" data-path="programming_primers.html"><a href="programming_primers.html#working-with-data-frames"><i class="fa fa-check"></i><b>2.2.3</b> Working with data frames</a></li>
<li class="chapter" data-level="2.2.4" data-path="programming_primers.html"><a href="programming_primers.html#where-to-find-help"><i class="fa fa-check"></i><b>2.2.4</b> Where to find help</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="programming_primers.html"><a href="programming_primers.html#exercises-1"><i class="fa fa-check"></i><b>2.3</b> Exercises</a></li>
<li class="chapter" data-level="2.4" data-path="programming_primers.html"><a href="programming_primers.html#solutions-1"><i class="fa fa-check"></i><b>2.4</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="data_wrangling.html"><a href="data_wrangling.html"><i class="fa fa-check"></i><b>3</b> Data wrangling</a>
<ul>
<li class="chapter" data-level="3.1" data-path="data_wrangling.html"><a href="data_wrangling.html#learning-objectives-2"><i class="fa fa-check"></i><b>3.1</b> Learning objectives</a></li>
<li class="chapter" data-level="3.2" data-path="data_wrangling.html"><a href="data_wrangling.html#tutorial-2"><i class="fa fa-check"></i><b>3.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="data_wrangling.html"><a href="data_wrangling.html#example-data"><i class="fa fa-check"></i><b>3.2.1</b> Example data</a></li>
<li class="chapter" data-level="3.2.2" data-path="data_wrangling.html"><a href="data_wrangling.html#required-libraries"><i class="fa fa-check"></i><b>3.2.2</b> Required libraries</a></li>
<li class="chapter" data-level="3.2.3" data-path="data_wrangling.html"><a href="data_wrangling.html#tidyverse"><i class="fa fa-check"></i><b>3.2.3</b> Tidyverse</a></li>
<li class="chapter" data-level="3.2.4" data-path="data_wrangling.html"><a href="data_wrangling.html#tabular-data"><i class="fa fa-check"></i><b>3.2.4</b> Tabular data</a></li>
<li class="chapter" data-level="3.2.5" data-path="data_wrangling.html"><a href="data_wrangling.html#variable-selection"><i class="fa fa-check"></i><b>3.2.5</b> Variable selection</a></li>
<li class="chapter" data-level="3.2.6" data-path="data_wrangling.html"><a href="data_wrangling.html#time-objects"><i class="fa fa-check"></i><b>3.2.6</b> Time objects</a></li>
<li class="chapter" data-level="3.2.7" data-path="data_wrangling.html"><a href="data_wrangling.html#variable-re--definition"><i class="fa fa-check"></i><b>3.2.7</b> Variable (re-) definition</a></li>
<li class="chapter" data-level="3.2.8" data-path="data_wrangling.html"><a href="data_wrangling.html#axes-of-variation"><i class="fa fa-check"></i><b>3.2.8</b> Axes of variation</a></li>
<li class="chapter" data-level="3.2.9" data-path="data_wrangling.html"><a href="data_wrangling.html#tidy-data"><i class="fa fa-check"></i><b>3.2.9</b> Tidy data</a></li>
<li class="chapter" data-level="3.2.10" data-path="data_wrangling.html"><a href="data_wrangling.html#aggregating-data"><i class="fa fa-check"></i><b>3.2.10</b> Aggregating data</a></li>
<li class="chapter" data-level="3.2.11" data-path="data_wrangling.html"><a href="data_wrangling.html#data-cleaning"><i class="fa fa-check"></i><b>3.2.11</b> Data cleaning</a></li>
<li class="chapter" data-level="3.2.12" data-path="data_wrangling.html"><a href="data_wrangling.html#combining-relational-data"><i class="fa fa-check"></i><b>3.2.12</b> Combining relational data</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="data_wrangling.html"><a href="data_wrangling.html#extra-material"><i class="fa fa-check"></i><b>3.3</b> Extra material</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="data_wrangling.html"><a href="data_wrangling.html#functional-programming-i"><i class="fa fa-check"></i><b>3.3.1</b> Functional programming I</a></li>
<li class="chapter" data-level="3.3.2" data-path="data_wrangling.html"><a href="data_wrangling.html#strings"><i class="fa fa-check"></i><b>3.3.2</b> Strings</a></li>
<li class="chapter" data-level="3.3.3" data-path="data_wrangling.html"><a href="data_wrangling.html#functional-programming-ii"><i class="fa fa-check"></i><b>3.3.3</b> Functional programming II</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="data_wrangling.html"><a href="data_wrangling.html#exercises-2"><i class="fa fa-check"></i><b>3.4</b> Exercises</a></li>
<li class="chapter" data-level="3.5" data-path="data_wrangling.html"><a href="data_wrangling.html#solutions-2"><i class="fa fa-check"></i><b>3.5</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data_vis.html"><a href="data_vis.html"><i class="fa fa-check"></i><b>4</b> Data visualisation</a>
<ul>
<li class="chapter" data-level="4.1" data-path="data_vis.html"><a href="data_vis.html#learning-objectives-3"><i class="fa fa-check"></i><b>4.1</b> Learning objectives</a></li>
<li class="chapter" data-level="4.2" data-path="data_vis.html"><a href="data_vis.html#required-packages"><i class="fa fa-check"></i><b>4.2</b> Required packages</a></li>
<li class="chapter" data-level="4.3" data-path="data_vis.html"><a href="data_vis.html#tutorial-3"><i class="fa fa-check"></i><b>4.3</b> Tutorial</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="data_vis.html"><a href="data_vis.html#the-grammar-of-graphics"><i class="fa fa-check"></i><b>4.3.1</b> The grammar of graphics</a></li>
<li class="chapter" data-level="4.3.2" data-path="data_vis.html"><a href="data_vis.html#every-data-has-its-representation"><i class="fa fa-check"></i><b>4.3.2</b> Every data has its representation</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="data_vis.html"><a href="data_vis.html#exercises-3"><i class="fa fa-check"></i><b>4.4</b> Exercises</a></li>
<li class="chapter" data-level="4.5" data-path="data_vis.html"><a href="data_vis.html#solutions-3"><i class="fa fa-check"></i><b>4.5</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data_variety.html"><a href="data_variety.html"><i class="fa fa-check"></i><b>5</b> Data variety</a>
<ul>
<li class="chapter" data-level="5.1" data-path="data_variety.html"><a href="data_variety.html#learning-objectives-4"><i class="fa fa-check"></i><b>5.1</b> Learning objectives</a></li>
<li class="chapter" data-level="5.2" data-path="data_variety.html"><a href="data_variety.html#tutorial-4"><i class="fa fa-check"></i><b>5.2</b> Tutorial</a></li>
<li class="chapter" data-level="5.3" data-path="data_variety.html"><a href="data_variety.html#files-and-file-formats"><i class="fa fa-check"></i><b>5.3</b> Files and file formats</a>
<ul>
<li class="chapter" data-level="5.3.1" data-path="data_variety.html"><a href="data_variety.html#file-extensions"><i class="fa fa-check"></i><b>5.3.1</b> File extensions</a></li>
<li class="chapter" data-level="5.3.2" data-path="data_variety.html"><a href="data_variety.html#file-formats"><i class="fa fa-check"></i><b>5.3.2</b> File formats</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="data_variety.html"><a href="data_variety.html#meta-data"><i class="fa fa-check"></i><b>5.4</b> Meta-data</a></li>
<li class="chapter" data-level="5.5" data-path="data_variety.html"><a href="data_variety.html#spatial-data-representation"><i class="fa fa-check"></i><b>5.5</b> Spatial data representation</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="data_variety.html"><a href="data_variety.html#raster-data-model"><i class="fa fa-check"></i><b>5.5.1</b> Raster data model</a></li>
<li class="chapter" data-level="5.5.2" data-path="data_variety.html"><a href="data_variety.html#vector-data-model"><i class="fa fa-check"></i><b>5.5.2</b> Vector data model</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="data_variety.html"><a href="data_variety.html#data-sources"><i class="fa fa-check"></i><b>5.6</b> Data sources</a>
<ul>
<li class="chapter" data-level="5.6.1" data-path="data_variety.html"><a href="data_variety.html#direct-downloads"><i class="fa fa-check"></i><b>5.6.1</b> Direct downloads</a></li>
<li class="chapter" data-level="5.6.2" data-path="data_variety.html"><a href="data_variety.html#apis"><i class="fa fa-check"></i><b>5.6.2</b> APIs</a></li>
</ul></li>
<li class="chapter" data-level="5.7" data-path="data_variety.html"><a href="data_variety.html#exercises-4"><i class="fa fa-check"></i><b>5.7</b> Exercises</a>
<ul>
<li class="chapter" data-level="5.7.1" data-path="data_variety.html"><a href="data_variety.html#files-and-file-formats-1"><i class="fa fa-check"></i><b>5.7.1</b> Files and file formats</a></li>
<li class="chapter" data-level="5.7.2" data-path="data_variety.html"><a href="data_variety.html#api-use"><i class="fa fa-check"></i><b>5.7.2</b> API use</a></li>
<li class="chapter" data-level="5.7.3" data-path="data_variety.html"><a href="data_variety.html#get-1"><i class="fa fa-check"></i><b>5.7.3</b> GET</a></li>
<li class="chapter" data-level="5.7.4" data-path="data_variety.html"><a href="data_variety.html#dedicated-library"><i class="fa fa-check"></i><b>5.7.4</b> Dedicated library</a></li>
</ul></li>
<li class="chapter" data-level="5.8" data-path="data_variety.html"><a href="data_variety.html#solutions-4"><i class="fa fa-check"></i><b>5.8</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="code_mgmt.html"><a href="code_mgmt.html"><i class="fa fa-check"></i><b>6</b> Code management</a>
<ul>
<li class="chapter" data-level="6.1" data-path="code_mgmt.html"><a href="code_mgmt.html#learning-objectives-5"><i class="fa fa-check"></i><b>6.1</b> Learning objectives</a></li>
<li class="chapter" data-level="6.2" data-path="code_mgmt.html"><a href="code_mgmt.html#tutorial-5"><i class="fa fa-check"></i><b>6.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="code_mgmt.html"><a href="code_mgmt.html#git-and-local-version-control"><i class="fa fa-check"></i><b>6.2.1</b> Git and local version control</a></li>
<li class="chapter" data-level="6.2.2" data-path="code_mgmt.html"><a href="code_mgmt.html#remote-version-control"><i class="fa fa-check"></i><b>6.2.2</b> Remote version control</a></li>
<li class="chapter" data-level="6.2.3" data-path="code_mgmt.html"><a href="code_mgmt.html#location-based-code-management---github-templates"><i class="fa fa-check"></i><b>6.2.3</b> Location based code management - github templates</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="code_mgmt.html"><a href="code_mgmt.html#exercises-5"><i class="fa fa-check"></i><b>6.3</b> Exercises</a></li>
<li class="chapter" data-level="6.4" data-path="code_mgmt.html"><a href="code_mgmt.html#solutions-5"><i class="fa fa-check"></i><b>6.4</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="open_science.html"><a href="open_science.html"><i class="fa fa-check"></i><b>7</b> Open science practices</a>
<ul>
<li class="chapter" data-level="7.1" data-path="open_science.html"><a href="open_science.html#learning-objectives-6"><i class="fa fa-check"></i><b>7.1</b> Learning objectives</a></li>
<li class="chapter" data-level="7.2" data-path="open_science.html"><a href="open_science.html#tutorial-6"><i class="fa fa-check"></i><b>7.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="open_science.html"><a href="open_science.html#project-structure"><i class="fa fa-check"></i><b>7.2.1</b> Project structure</a></li>
<li class="chapter" data-level="7.2.2" data-path="open_science.html"><a href="open_science.html#managing-workflows"><i class="fa fa-check"></i><b>7.2.2</b> Managing workflows</a></li>
<li class="chapter" data-level="7.2.3" data-path="open_science.html"><a href="open_science.html#capturing-your-session-state"><i class="fa fa-check"></i><b>7.2.3</b> Capturing your session state</a></li>
<li class="chapter" data-level="7.2.4" data-path="open_science.html"><a href="open_science.html#capturing-a-system-state"><i class="fa fa-check"></i><b>7.2.4</b> Capturing a system state</a></li>
<li class="chapter" data-level="7.2.5" data-path="open_science.html"><a href="open_science.html#readable-reporting-using-rmarkdown"><i class="fa fa-check"></i><b>7.2.5</b> Readable reporting using Rmarkdown</a></li>
<li class="chapter" data-level="7.2.6" data-path="open_science.html"><a href="open_science.html#data-retention"><i class="fa fa-check"></i><b>7.2.6</b> Data retention</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="open_science.html"><a href="open_science.html#exercises-6"><i class="fa fa-check"></i><b>7.3</b> Exercises</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="open_science.html"><a href="open_science.html#data-and-code-management"><i class="fa fa-check"></i><b>7.3.1</b> Data and code management</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="open_science.html"><a href="open_science.html#references"><i class="fa fa-check"></i><b>7.4</b> References</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="regression_classification.html"><a href="regression_classification.html"><i class="fa fa-check"></i><b>8</b> Regression and classification</a>
<ul>
<li class="chapter" data-level="8.1" data-path="regression_classification.html"><a href="regression_classification.html#learning-objectives-7"><i class="fa fa-check"></i><b>8.1</b> Learning objectives</a></li>
<li class="chapter" data-level="8.2" data-path="regression_classification.html"><a href="regression_classification.html#tutorial-7"><i class="fa fa-check"></i><b>8.2</b> Tutorial</a></li>
<li class="chapter" data-level="8.3" data-path="regression_classification.html"><a href="regression_classification.html#exercises-7"><i class="fa fa-check"></i><b>8.3</b> Exercises</a></li>
<li class="chapter" data-level="8.4" data-path="regression_classification.html"><a href="regression_classification.html#solutions-6"><i class="fa fa-check"></i><b>8.4</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="supervised_ml.html"><a href="supervised_ml.html"><i class="fa fa-check"></i><b>9</b> Supervised machine learning</a>
<ul>
<li class="chapter" data-level="9.1" data-path="supervised_ml.html"><a href="supervised_ml.html#learning-objectives-8"><i class="fa fa-check"></i><b>9.1</b> Learning objectives</a></li>
<li class="chapter" data-level="9.2" data-path="supervised_ml.html"><a href="supervised_ml.html#tutorial-8"><i class="fa fa-check"></i><b>9.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="supervised_ml.html"><a href="supervised_ml.html#required-packages-1"><i class="fa fa-check"></i><b>9.2.1</b> Required packages</a></li>
<li class="chapter" data-level="9.2.2" data-path="supervised_ml.html"><a href="supervised_ml.html#overfitting"><i class="fa fa-check"></i><b>9.2.2</b> Overfitting</a></li>
<li class="chapter" data-level="9.2.3" data-path="supervised_ml.html"><a href="supervised_ml.html#data-and-the-modelling-challenge"><i class="fa fa-check"></i><b>9.2.3</b> Data and the modelling challenge</a></li>
<li class="chapter" data-level="9.2.4" data-path="supervised_ml.html"><a href="supervised_ml.html#k-nearest-neighbours"><i class="fa fa-check"></i><b>9.2.4</b> K-nearest neighbours</a></li>
<li class="chapter" data-level="9.2.5" data-path="supervised_ml.html"><a href="supervised_ml.html#model-formulation"><i class="fa fa-check"></i><b>9.2.5</b> Model formulation</a></li>
<li class="chapter" data-level="9.2.6" data-path="supervised_ml.html"><a href="supervised_ml.html#data-splitting"><i class="fa fa-check"></i><b>9.2.6</b> Data splitting</a></li>
<li class="chapter" data-level="9.2.7" data-path="supervised_ml.html"><a href="supervised_ml.html#preprocessing"><i class="fa fa-check"></i><b>9.2.7</b> Pre-processing</a></li>
<li class="chapter" data-level="9.2.8" data-path="supervised_ml.html"><a href="supervised_ml.html#putting-it-all-together-half-way"><i class="fa fa-check"></i><b>9.2.8</b> Putting it all together (half-way)</a></li>
<li class="chapter" data-level="9.2.9" data-path="supervised_ml.html"><a href="supervised_ml.html#training"><i class="fa fa-check"></i><b>9.2.9</b> Model training</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="supervised_ml.html"><a href="supervised_ml.html#exercises-8"><i class="fa fa-check"></i><b>9.3</b> Exercises</a></li>
<li class="chapter" data-level="9.4" data-path="supervised_ml.html"><a href="supervised_ml.html#solutions-7"><i class="fa fa-check"></i><b>9.4</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="random_forest.html"><a href="random_forest.html"><i class="fa fa-check"></i><b>10</b> Random forest</a>
<ul>
<li class="chapter" data-level="10.1" data-path="random_forest.html"><a href="random_forest.html#learning-objectives-9"><i class="fa fa-check"></i><b>10.1</b> Learning objectives</a></li>
<li class="chapter" data-level="10.2" data-path="random_forest.html"><a href="random_forest.html#tutorial-9"><i class="fa fa-check"></i><b>10.2</b> Tutorial</a></li>
<li class="chapter" data-level="10.3" data-path="random_forest.html"><a href="random_forest.html#exercises-9"><i class="fa fa-check"></i><b>10.3</b> Exercises</a></li>
<li class="chapter" data-level="10.4" data-path="random_forest.html"><a href="random_forest.html#solutions-8"><i class="fa fa-check"></i><b>10.4</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="neural_nets.html"><a href="neural_nets.html"><i class="fa fa-check"></i><b>11</b> Neural networks</a>
<ul>
<li class="chapter" data-level="11.1" data-path="neural_nets.html"><a href="neural_nets.html#learning-objectives-10"><i class="fa fa-check"></i><b>11.1</b> Learning objectives</a></li>
<li class="chapter" data-level="11.2" data-path="neural_nets.html"><a href="neural_nets.html#tutorial-10"><i class="fa fa-check"></i><b>11.2</b> Tutorial</a></li>
<li class="chapter" data-level="11.3" data-path="neural_nets.html"><a href="neural_nets.html#exercises-10"><i class="fa fa-check"></i><b>11.3</b> Exercises</a></li>
<li class="chapter" data-level="11.4" data-path="neural_nets.html"><a href="neural_nets.html#solutions-9"><i class="fa fa-check"></i><b>11.4</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="interpretable_ml.html"><a href="interpretable_ml.html"><i class="fa fa-check"></i><b>12</b> Interpretable machine learning</a>
<ul>
<li class="chapter" data-level="12.1" data-path="interpretable_ml.html"><a href="interpretable_ml.html#learning-objectives-11"><i class="fa fa-check"></i><b>12.1</b> Learning objectives</a></li>
<li class="chapter" data-level="12.2" data-path="interpretable_ml.html"><a href="interpretable_ml.html#tutorial-11"><i class="fa fa-check"></i><b>12.2</b> Tutorial</a></li>
<li class="chapter" data-level="12.3" data-path="interpretable_ml.html"><a href="interpretable_ml.html#exercises-11"><i class="fa fa-check"></i><b>12.3</b> Exercises</a></li>
<li class="chapter" data-level="12.4" data-path="interpretable_ml.html"><a href="interpretable_ml.html#solutions-10"><i class="fa fa-check"></i><b>12.4</b> Solutions</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references-1.html"><a href="references-1.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Applied Geodata Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="supervised_ml" class="section level1 hasAnchor" number="9">
<h1><span class="header-section-number">Chapter 9</span> Supervised machine learning<a href="supervised_ml.html#supervised_ml" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p><strong>Chapter lead author: Benjamin Stocker</strong></p>
<ul>
<li>Lecture (Beni): Overfitting, training, and cross-validation (<a href="https://stineb.github.io/ml4ec_workshop/introduction.html#overfitting">link</a>)</li>
<li>K nearest neighbour models</li>
<li>Data splitting</li>
<li>Preprocessing, standardization, imputation, dimension reduction, as part of the model training workflow</li>
<li>formula notation, recipes, generic train()</li>
<li>Training and loss function</li>
<li>Hyperparameters</li>
<li>Resampling</li>
<li>Performance assessment: Exercise comparing performance on test set of linear regression and KNN with different hyperparameter choices (like <a href="https://stineb.github.io/ml4ec_workshop/solutions.html">this</a>), discuss link to overfitting example</li>
</ul>
<div id="learning-objectives-8" class="section level2 hasAnchor" number="9.1">
<h2><span class="header-section-number">9.1</span> Learning objectives<a href="supervised_ml.html#learning-objectives-8" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this Chapter, we use ecosystem flux data and parallel measurements of meteorological variables to model ecosystem gross primary production (the ecosystem-level CO2 uptake by photosynthesis). These data and prediction task is used to introduce fundamental methods of machine learning (data preprocessing, data splitting, model formulation, and model training) and their implementations in R. After this course, you will …</p>
<ul>
<li>Understand how overfitting models can happen and how it can be avoided.</li>
<li>Implement a typical workflow using a machine learning model for a supervised regression problem.</li>
<li>Evaluate the power of the model.</li>
</ul>
<p>Contents of this Chapter are inspired by the excellent book <a href="https://bradleyboehmke.github.io/HOML/">Hands-On Machine Learning in R by Boehmke &amp; Greenwell</a>.</p>
</div>
<div id="tutorial-8" class="section level2 hasAnchor" number="9.2">
<h2><span class="header-section-number">9.2</span> Tutorial<a href="supervised_ml.html#tutorial-8" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="required-packages-1" class="section level3 hasAnchor" number="9.2.1">
<h3><span class="header-section-number">9.2.1</span> Required packages<a href="supervised_ml.html#required-packages-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb300-1"><a href="supervised_ml.html#cb300-1" aria-hidden="true" tabindex="-1"></a>use_pkgs <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;dplyr&quot;</span>, <span class="st">&quot;tidyr&quot;</span>, <span class="st">&quot;readr&quot;</span>, <span class="st">&quot;ggplot2&quot;</span>, <span class="st">&quot;caret&quot;</span>, <span class="st">&quot;yardstick&quot;</span>, <span class="st">&quot;lubridate&quot;</span>, <span class="st">&quot;rsample&quot;</span>, <span class="st">&quot;recipes&quot;</span>, <span class="st">&quot;modelr&quot;</span>, <span class="st">&quot;forcats&quot;</span>)</span>
<span id="cb300-2"><a href="supervised_ml.html#cb300-2" aria-hidden="true" tabindex="-1"></a>new_pkgs <span class="ot">&lt;-</span> use_pkgs[<span class="sc">!</span>(use_pkgs <span class="sc">%in%</span> <span class="fu">installed.packages</span>()[, <span class="st">&quot;Package&quot;</span>])]</span>
<span id="cb300-3"><a href="supervised_ml.html#cb300-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(new_pkgs) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="fu">install.packages</span>(new_pkgs)</span></code></pre></div>
<pre><code>## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/caret_6.0-93.tgz&#39; ...
##  OK [downloaded 3.4 Mb in 0.9 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/e1071_1.7-12.tgz&#39; ...
##  OK [downloaded 656.4 Kb in 0.5 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/proxy_0.4-27.tgz&#39; ...
##  OK [downloaded 186 Kb in 0.3 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/foreach_1.5.2.tgz&#39; ...
##  OK [downloaded 133.1 Kb in 0.3 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/iterators_1.0.14.tgz&#39; ...
##  OK [downloaded 337.3 Kb in 0.4 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/ModelMetrics_1.2.2.2.tgz&#39; ...
##  OK [downloaded 544.6 Kb in 1.5 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/plyr_1.8.8.tgz&#39; ...
##  OK [downloaded 991.5 Kb in 0.4 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/pROC_1.18.0.tgz&#39; ...
##  OK [downloaded 1.1 Mb in 0.5 secs]
## Retrieving &#39;https://packagemanager.rstudio.com/cran/latest/src/contrib/recipes_1.0.4.tar.gz&#39; ...
##  OK [downloaded 782.1 Kb in 0.9 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/clock_0.6.1.tgz&#39; ...
##  OK [downloaded 8.1 Mb in 0.7 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/gower_1.0.1.tgz&#39; ...
##  OK [downloaded 209.3 Kb in 0.3 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/hardhat_1.2.0.tgz&#39; ...
##  OK [downloaded 776.7 Kb in 0.4 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/ipred_0.9-13.tgz&#39; ...
##  OK [downloaded 376 Kb in 0.5 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/prodlim_2019.11.13.tgz&#39; ...
##  OK [downloaded 412.5 Kb in 0.4 secs]
## Retrieving &#39;https://packagemanager.rstudio.com/cran/latest/src/contrib/lava_1.7.1.tar.gz&#39; ...
##  OK [downloaded 1.2 Mb in 0.8 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/future.apply_1.10.0.tgz&#39; ...
##  OK [downloaded 149.1 Kb in 0.3 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/globals_0.16.2.tgz&#39; ...
##  OK [downloaded 102.7 Kb in 0.2 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/future_1.30.0.tgz&#39; ...
##  OK [downloaded 612.1 Kb in 0.4 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/listenv_0.9.0.tgz&#39; ...
##  OK [downloaded 102.5 Kb in 0.3 secs]
## Retrieving &#39;https://packagemanager.rstudio.com/cran/latest/src/contrib/parallelly_1.34.0.tar.gz&#39; ...
##  OK [downloaded 133.4 Kb in 0.7 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/numDeriv_2016.8-1.1.tgz&#39; ...
##  OK [downloaded 110.6 Kb in 0.3 secs]
## Retrieving &#39;https://packagemanager.rstudio.com/cran/latest/src/contrib/progressr_0.13.0.tar.gz&#39; ...
##  OK [downloaded 204.4 Kb in 0.8 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/SQUAREM_2021.1.tgz&#39; ...
##  OK [downloaded 172.4 Kb in 0.6 secs]
## Retrieving &#39;https://packagemanager.rstudio.com/cran/latest/src/contrib/timeDate_4022.108.tar.gz&#39; ...
##  OK [downloaded 284.5 Kb in 0.8 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/reshape2_1.4.4.tgz&#39; ...
##  OK [downloaded 325.6 Kb in 0.4 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/yardstick_1.1.0.tgz&#39; ...
##  OK [downloaded 829.6 Kb in 0.7 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/rsample_1.1.1.tgz&#39; ...
##  OK [downloaded 485.6 Kb in 0.4 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/furrr_0.3.1.tgz&#39; ...
##  OK [downloaded 994.3 Kb in 0.5 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/slider_0.3.0.tgz&#39; ...
##  OK [downloaded 357.9 Kb in 0.4 secs]
## Retrieving &#39;https://mran.microsoft.com/snapshot/2023-01-08/bin/macosx/contrib/4.2/warp_0.2.0.tgz&#39; ...
##  OK [downloaded 101.1 Kb in 0.3 secs]
## Installing proxy [0.4-27] ...
##  OK [installed binary]
## Moving proxy [0.4-27] into the cache ...
##  OK [moved to cache in 1.4 milliseconds]
## Installing e1071 [1.7-12] ...
##  OK [installed binary]
## Moving e1071 [1.7-12] into the cache ...
##  OK [moved to cache in 1.4 milliseconds]
## Installing iterators [1.0.14] ...
##  OK [installed binary]
## Moving iterators [1.0.14] into the cache ...
##  OK [moved to cache in 1.4 milliseconds]
## Installing foreach [1.5.2] ...
##  OK [installed binary]
## Moving foreach [1.5.2] into the cache ...
##  OK [moved to cache in 1.4 milliseconds]
## Installing ModelMetrics [1.2.2.2] ...
##  OK [installed binary]
## Moving ModelMetrics [1.2.2.2] into the cache ...
##  OK [moved to cache in 1.4 milliseconds]
## Installing plyr [1.8.8] ...
##  OK [installed binary]
## Moving plyr [1.8.8] into the cache ...
##  OK [moved to cache in 1.4 milliseconds]
## Installing pROC [1.18.0] ...
##  OK [installed binary]
## Moving pROC [1.18.0] into the cache ...
##  OK [moved to cache in 1.4 milliseconds]
## Installing clock [0.6.1] ...
##  OK [installed binary]
## Moving clock [0.6.1] into the cache ...
##  OK [moved to cache in 1.9 milliseconds]
## Installing gower [1.0.1] ...
##  OK [installed binary]
## Moving gower [1.0.1] into the cache ...
##  OK [moved to cache in 1.4 milliseconds]
## Installing hardhat [1.2.0] ...
##  OK [installed binary]
## Moving hardhat [1.2.0] into the cache ...
##  OK [moved to cache in 1.5 milliseconds]
## Installing globals [0.16.2] ...
##  OK [installed binary]
## Moving globals [0.16.2] into the cache ...
##  OK [moved to cache in 2.4 milliseconds]
## Installing listenv [0.9.0] ...
##  OK [installed binary]
## Moving listenv [0.9.0] into the cache ...
##  OK [moved to cache in 1.4 milliseconds]
## Installing parallelly [1.34.0] ...
##  OK [built from source]
## Moving parallelly [1.34.0] into the cache ...
##  OK [moved to cache in 1.5 milliseconds]
## Installing future [1.30.0] ...
##  OK [installed binary]
## Moving future [1.30.0] into the cache ...
##  OK [moved to cache in 1.5 milliseconds]
## Installing future.apply [1.10.0] ...
##  OK [installed binary]
## Moving future.apply [1.10.0] into the cache ...
##  OK [moved to cache in 1.4 milliseconds]
## Installing numDeriv [2016.8-1.1] ...
##  OK [installed binary]
## Moving numDeriv [2016.8-1.1] into the cache ...
##  OK [moved to cache in 1.7 milliseconds]
## Installing progressr [0.13.0] ...
##  OK [built from source]
## Moving progressr [0.13.0] into the cache ...
##  OK [moved to cache in 1.4 milliseconds]
## Installing SQUAREM [2021.1] ...
##  OK [installed binary]
## Moving SQUAREM [2021.1] into the cache ...
##  OK [moved to cache in 2.2 milliseconds]
## Installing lava [1.7.1] ...
##  OK [built from source]
## Moving lava [1.7.1] into the cache ...
##  OK [moved to cache in 1.4 milliseconds]
## Installing prodlim [2019.11.13] ...
##  OK [installed binary]
## Moving prodlim [2019.11.13] into the cache ...
##  OK [moved to cache in 1.4 milliseconds]
## Installing ipred [0.9-13] ...
##  OK [installed binary]
## Moving ipred [0.9-13] into the cache ...
##  OK [moved to cache in 1.9 milliseconds]
## Installing timeDate [4022.108] ...
##  OK [built from source]
## Moving timeDate [4022.108] into the cache ...
##  OK [moved to cache in 1.5 milliseconds]
## Installing recipes [1.0.4] ...
##  OK [built from source]
## Moving recipes [1.0.4] into the cache ...
##  OK [moved to cache in 1.4 milliseconds]
## Installing reshape2 [1.4.4] ...
##  OK [installed binary]
## Moving reshape2 [1.4.4] into the cache ...
##  OK [moved to cache in 1.5 milliseconds]
## Installing caret [6.0-93] ...
##  OK [installed binary]
## Moving caret [6.0-93] into the cache ...
##  OK [moved to cache in 1.4 milliseconds]
## Installing yardstick [1.1.0] ...
##  OK [installed binary]
## Moving yardstick [1.1.0] into the cache ...
##  OK [moved to cache in 1.8 milliseconds]
## Installing furrr [0.3.1] ...
##  OK [installed binary]
## Moving furrr [0.3.1] into the cache ...
##  OK [moved to cache in 1.4 milliseconds]
## Installing warp [0.2.0] ...
##  OK [installed binary]
## Moving warp [0.2.0] into the cache ...
##  OK [moved to cache in 2.6 milliseconds]
## Installing slider [0.3.0] ...
##  OK [installed binary]
## Moving slider [0.3.0] into the cache ...
##  OK [moved to cache in 1.4 milliseconds]
## Installing rsample [1.1.1] ...
##  OK [installed binary]
## Moving rsample [1.1.1] into the cache ...
##  OK [moved to cache in 1.8 milliseconds]</code></pre>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb302-1"><a href="supervised_ml.html#cb302-1" aria-hidden="true" tabindex="-1"></a><span class="fu">invisible</span>(<span class="fu">lapply</span>(use_pkgs, require, <span class="at">character.only =</span> <span class="cn">TRUE</span>))</span></code></pre></div>
</div>
<div id="overfitting" class="section level3 hasAnchor" number="9.2.2">
<h3><span class="header-section-number">9.2.2</span> Overfitting<a href="supervised_ml.html#overfitting" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><em>This example is based on <a href="https://scikit-learn.org/stable/auto_examples/model_selection/plot_underfitting_overfitting.html">this example from scikit-learn</a>.</em></p>
<p>Machine learning (ML) may appear magical. The ability of ML algorithms to detect patterns and make predictions is fascinating. However, several challenges have to be met in the process of formulating, training, and evaluating the models. In this tutorial we will discuss some basics of supervised ML and how to achieve best predictive results.</p>
<p>In general, the aim of supervised ML is to find a model <span class="math inline">\(\hat{y} = f(x)\)</span> that is <em>trained</em> (calibrated) using observed relationships between a set of <em>features</em> (also known as <em>predictors</em>, or <em>labels</em>, or <em>independent variables</em>) <span class="math inline">\(x\)</span> and the <em>target</em> variable <span class="math inline">\(y\)</span>. Note, that <span class="math inline">\(y\)</span> is observed. The hat on <span class="math inline">\(\hat{y}\)</span> denotes an estimate. Some algorithms can even handle predictions of multiple target variables simultaneously (e.g., neural networks). ML algorithms consist of (more or less) flexible mathematical models with a certain structure and set of parameters. At the simple extreme end of the model spectrum is the bivariate linear regression. You may not want to call this a ML algorithm because there is no iterative learning involved. Nevertheless, also bivariate linear regression provides a prediction <span class="math inline">\(\hat{y} = f(x)\)</span>, just like other (proper) ML algorithms do. The functional form of a linear regression is not particularly flexible (just a straight line for the best fit between predictors and targets) and it has only two parameters (slope and intercept). At the other extreme end are, for example, deep neural networks. They are extremely flexible, can learn highly non-linear relationships and deal with interactions between a large number of predictors. They also contain very large numbers of parameters, typically on the order of <span class="math inline">\(10^4 - 10^5\)</span> . You can imagine that this allows these types of algorithms to very effectively learn from the data, but also bears the risk of <em>overfitting</em>.</p>
<p>What is overfitting? The following example illustrates it. Let’s assume that there is some true underlying relationship between a single predictor <span class="math inline">\(x\)</span> and the target variable <span class="math inline">\(y\)</span>. We don’t know this relationship (in the code below, this is <code>true_fun()</code>) and the observations contain a (normally distributed) error (<code>y = true_fun(x) + 0.1 * rnorm(n_samples)</code>). Based on our training data (<code>df_train</code>), we fit three polynomial models of degree 1, 4, and 15 to the observations. A polynomial of degree <span class="math inline">\(N\)</span> is given by: <span class="math display">\[
y = \sum_{n=0}^N a_n x^n
\]</span> <span class="math inline">\(a_n\)</span> are the coefficients, i.e., model parameters. The goal of the training is to find the coefficients <span class="math inline">\(a_n\)</span> so that the predicted <span class="math inline">\(\hat{y}\)</span> fits observed <span class="math inline">\(y\)</span> best. From the above definition, the polynomial of degree 15 has 16 parameters, while the polynomial of degree 1 has two parameters (and corresponds to a simple bivariate linear regression). You can imagine that the polynomial of degree 15 is much more flexible and should thus yield the closest fit to the training data. This is indeed the case.</p>
<p><img src="_main_files/figure-html/unnamed-chunk-149-1.png" width="672" /></p>
<p>We can use the same fitted models on data that was not used for model fitting - the <em>validation data</em>. This is what’s done below. Again, the same true underlying relationship is used, but we sample a new set of data points <span class="math inline">\(x\)</span> and add a new sample of errors on top of the true relationship.</p>
<p><img src="_main_files/figure-html/unnamed-chunk-150-1.png" width="672" /></p>
<p>You see that, using the validation set, we find that “poly4” actually performs the best - it has a much lower RMSE that “poly15”. Apparently, “poly15” was overfitted. Apparently, it indeed used its flexibility to fit not only the shape of the true underlying relationship, but also the observation errors on top of it. This has obviously the implication that, when this model is used to make predictions for data that was not used for training (calibration), it will yield misguided predictions that are affected by the errors in the training set. In the above pictures we can also conclude that “poly1” was underfitted.</p>
<p>It gets even worse when applying the fitted polynomial models to data that extends beyond the range in <span class="math inline">\(x\)</span> that was used for model training. Here, we’re extending just 20% to the right.</p>
<p><img src="_main_files/figure-html/unnamed-chunk-151-1.png" width="672" /></p>
<p>You see that the RMSE for “poly15” literally explodes. The model is hopelessly overfitted and completely useless for prediction, although it looked like it fit the data best when we considered only the training results. This is a fundamental challenge in ML - finding the model with the best <em>generalisability</em>. That is, a model that not only fits the training data well, but also performs well on unseen data.</p>
<p>The phenomenon of fitting and overfitting as a function of the <em>model complexity</em> is also referred to as the <em>bias-variance trade-off</em>. The bias describes how well a model matches the training set (average error). A model with low bias will match the data set closely and vice versa. The variance describes how much a model changes when you train it using different portions of your data set. “poly15” has a high variance, but much of its variance is the result of misled training on observation errors. On the other extreme, “poly1” has a high bias. It’s not affected by the noise in observations, but its predictions are also far off the observations. In ML, we are challenged to balance this trade-off.</p>
<p>This chapter introduces the methods to achieve the best model <em>generalisability</em> and find the sweet spot between high bias and high variance. The steps to get there include the <em>preprocessing</em> of data, <em>splitting</em> the data into training and testing sets, and <em>model training</em> that “steers” the model towards what is considered a good model fit in terms of its generalisability to data that was not used during training. In this chapter, you learn how all these steps can be implemented in R. Depending on your application or research question, it may also be of interest to evaluate the relationships embodied in <span class="math inline">\(f(x)\)</span> or to quantify the <em>importance</em> of different predictors in our model. This is referred to as <em>model interpretation</em> and is introduced in Chapter @ref(interpretable_ml).</p>
<p>Of course, a plethora of algorithms exist that do the job of <span class="math inline">\(y = f(x)\)</span>. Each of them has its own strengths and limitations. It is beyond the scope of this course to introduce a larger number of ML algorithms. Subsequent Chapters will focus primarily on the Random Forest algorithm and Neural Networks (NN). For illustration purposes in this chapter, we will use and introduce the K-nearest-Neighbors (KNN) algorithm and compare its performance to a multivariate linear regression for illustration purposes.</p>
</div>
<div id="data-and-the-modelling-challenge" class="section level3 hasAnchor" number="9.2.3">
<h3><span class="header-section-number">9.2.3</span> Data and the modelling challenge<a href="supervised_ml.html#data-and-the-modelling-challenge" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We’re returning to ecosystem flux data that we’ve used Chapters @ref(data_wrangling) and @ref(data_vis). Here, we’re using daily data from the evergreen site in Davos, Switzerland (CH-Dav) to avoid effects of seasonally varying foliage cover for which the data does not contain information. To address such additional effects, we would have to, for example, combine the flux and meteorological data with remotely sensed surface greenness data.</p>
<p>The data set <code>FLX_CH-Dav_FLUXNET2015_FULLSET_DD_1997-2014_1-3.csv</code> contains a time series of the ecosystem gross primary production (GPP) and a range of meteorological variables, measured in parallel. In this chapter, we formulate a model for predicting GPP from a set of <em>covariates</em> (other variables that vary in parallel, here the meteorological variables). This is to say that <code>GPP_NT_VUT_REF</code> is the <em>target</em> variable, and other variables that are available in our dataset are the <em>predictors.</em></p>
<p>Let’s read the data, select suitable variables, and interpret missing value codes, and select only good-quality data (where at least 80% of the underlying half-hourly data was good quality measured data, and not gap-filled).</p>
<div class="sourceCode" id="cb303"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb303-1"><a href="supervised_ml.html#cb303-1" aria-hidden="true" tabindex="-1"></a>ddf <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">&quot;./data/FLX_CH-Dav_FLUXNET2015_FULLSET_DD_1997-2014_1-3.csv&quot;</span>) <span class="sc">|&gt;</span>  </span>
<span id="cb303-2"><a href="supervised_ml.html#cb303-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb303-3"><a href="supervised_ml.html#cb303-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># select only the variables we are interested in</span></span>
<span id="cb303-4"><a href="supervised_ml.html#cb303-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(TIMESTAMP,</span>
<span id="cb303-5"><a href="supervised_ml.html#cb303-5" aria-hidden="true" tabindex="-1"></a>                GPP_NT_VUT_REF,    <span class="co"># the target</span></span>
<span id="cb303-6"><a href="supervised_ml.html#cb303-6" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ends_with</span>(<span class="st">&quot;_QC&quot;</span>),  <span class="co"># quality control info</span></span>
<span id="cb303-7"><a href="supervised_ml.html#cb303-7" aria-hidden="true" tabindex="-1"></a>                <span class="fu">ends_with</span>(<span class="st">&quot;_F&quot;</span>),   <span class="co"># includes all all meteorological covariates</span></span>
<span id="cb303-8"><a href="supervised_ml.html#cb303-8" aria-hidden="true" tabindex="-1"></a>                <span class="sc">-</span><span class="fu">contains</span>(<span class="st">&quot;JSB&quot;</span>)   <span class="co"># weird useless variable</span></span>
<span id="cb303-9"><a href="supervised_ml.html#cb303-9" aria-hidden="true" tabindex="-1"></a>                ) <span class="sc">|&gt;</span></span>
<span id="cb303-10"><a href="supervised_ml.html#cb303-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-11"><a href="supervised_ml.html#cb303-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># convert to a nice date object</span></span>
<span id="cb303-12"><a href="supervised_ml.html#cb303-12" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">TIMESTAMP =</span> <span class="fu">ymd</span>(TIMESTAMP)) <span class="sc">|&gt;</span></span>
<span id="cb303-13"><a href="supervised_ml.html#cb303-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-14"><a href="supervised_ml.html#cb303-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># set all -9999 to NA</span></span>
<span id="cb303-15"><a href="supervised_ml.html#cb303-15" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">na_if</span>(<span class="sc">-</span><span class="dv">9999</span>) <span class="sc">|&gt;</span></span>
<span id="cb303-16"><a href="supervised_ml.html#cb303-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb303-17"><a href="supervised_ml.html#cb303-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># retain only data based on &gt;=80% good-quality measurements</span></span>
<span id="cb303-18"><a href="supervised_ml.html#cb303-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># overwrite bad data with NA (not dropping rows)</span></span>
<span id="cb303-19"><a href="supervised_ml.html#cb303-19" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">GPP_NT_VUT_REF =</span> <span class="fu">ifelse</span>(NEE_VUT_REF_QC <span class="sc">&lt;</span> <span class="fl">0.8</span>, <span class="cn">NA</span>, GPP_NT_VUT_REF),</span>
<span id="cb303-20"><a href="supervised_ml.html#cb303-20" aria-hidden="true" tabindex="-1"></a>                <span class="at">TA_F           =</span> <span class="fu">ifelse</span>(TA_F_QC        <span class="sc">&lt;</span> <span class="fl">0.8</span>, <span class="cn">NA</span>, TA_F),</span>
<span id="cb303-21"><a href="supervised_ml.html#cb303-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">SW_IN_F        =</span> <span class="fu">ifelse</span>(SW_IN_F_QC     <span class="sc">&lt;</span> <span class="fl">0.8</span>, <span class="cn">NA</span>, SW_IN_F),</span>
<span id="cb303-22"><a href="supervised_ml.html#cb303-22" aria-hidden="true" tabindex="-1"></a>                <span class="at">LW_IN_F        =</span> <span class="fu">ifelse</span>(LW_IN_F_QC     <span class="sc">&lt;</span> <span class="fl">0.8</span>, <span class="cn">NA</span>, LW_IN_F),</span>
<span id="cb303-23"><a href="supervised_ml.html#cb303-23" aria-hidden="true" tabindex="-1"></a>                <span class="at">VPD_F          =</span> <span class="fu">ifelse</span>(VPD_F_QC       <span class="sc">&lt;</span> <span class="fl">0.8</span>, <span class="cn">NA</span>, VPD_F),</span>
<span id="cb303-24"><a href="supervised_ml.html#cb303-24" aria-hidden="true" tabindex="-1"></a>                <span class="at">PA_F           =</span> <span class="fu">ifelse</span>(PA_F_QC        <span class="sc">&lt;</span> <span class="fl">0.8</span>, <span class="cn">NA</span>, PA_F),</span>
<span id="cb303-25"><a href="supervised_ml.html#cb303-25" aria-hidden="true" tabindex="-1"></a>                <span class="at">P_F            =</span> <span class="fu">ifelse</span>(P_F_QC         <span class="sc">&lt;</span> <span class="fl">0.8</span>, <span class="cn">NA</span>, P_F),</span>
<span id="cb303-26"><a href="supervised_ml.html#cb303-26" aria-hidden="true" tabindex="-1"></a>                <span class="at">WS_F           =</span> <span class="fu">ifelse</span>(WS_F_QC        <span class="sc">&lt;</span> <span class="fl">0.8</span>, <span class="cn">NA</span>, WS_F)) <span class="sc">|&gt;</span> </span>
<span id="cb303-27"><a href="supervised_ml.html#cb303-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-28"><a href="supervised_ml.html#cb303-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># drop QC variables (no longer needed)</span></span>
<span id="cb303-29"><a href="supervised_ml.html#cb303-29" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">ends_with</span>(<span class="st">&quot;_QC&quot;</span>))</span></code></pre></div>
<p>The steps above are considered data <em>wrangling</em> and are <em>not</em> part of the modelling process. After completing this tutorial, you will understand this distinction. (-&gt; exercise explain the distinction)</p>
</div>
<div id="k-nearest-neighbours" class="section level3 hasAnchor" number="9.2.4">
<h3><span class="header-section-number">9.2.4</span> K-nearest neighbours<a href="supervised_ml.html#k-nearest-neighbours" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Before we start with the model training workflow, let’s introduce the K-nearest neighbour (KNN) algorithm which is used here for demonstration purposes. It serves the purpose of demonstrating the bias-variance trade-off (see below). As the name suggests, KNN uses the <span class="math inline">\(k\)</span> observations that are “nearest” to the new record for which we want to make a prediction. It then calculates their average (for regression) or most frequent value (for classification) and uses it as the prediction of the target value. “Nearest” is determined by some distance metric evaluated based on the values of the predictors. In our example (<code>GPP_NT_VUT_REF ~ .</code>), KNN would determine the <span class="math inline">\(k\)</span> days where conditions, given by our set of predictors, were most similar (nearest) to the day for which we seek a prediction. Then, it calculates the prediction as the average (mean) GPP value of these days. Determining “nearest” neighbors is commonly based on either the <em>Euclidean</em> or <em>Manhattan</em> distances between two data points <span class="math inline">\(x_a\)</span> and <span class="math inline">\(x_b\)</span>, considering all <span class="math inline">\(P\)</span> predictors <span class="math inline">\(j\)</span>.</p>
<p>Euclidean distance:
<span class="math display">\[
\sqrt{ \sum_{j=1}^P (x_{a,j} - x_{b,j})^2  } \\
\]</span></p>
<p>Manhattan distance:
<span class="math display">\[
\sum_{j=1}^P | x_{a,j} - x_{b,j} |
\]</span>
In two-dimensional space, the Euclidean distance measures the length of a straight line between two points (remember Pythagoras!). The Manhattan distance is called this way because it measures the distance you would have to walk to get from point <span class="math inline">\(a\)</span> to point <span class="math inline">\(b\)</span> in Manhattan, New York, where you cannot cut corners but have to follow a rectangular grid of streets. <span class="math inline">\(|x|\)</span> is the absolute value of <span class="math inline">\(x\)</span> ( <span class="math inline">\(|-x| = x\)</span>).</p>
<p>KNN is a simple algorithm that uses knowledge of the “local” data structure for prediction. A drawback is that the model training has to be done for each prediction step and the computation time of the training increases with <span class="math inline">\(x \times p\)</span>. KNNs are used, for example, to impute values (fill missing values) and have the advantage that predicted values are always within the range of observed values of the target variable.</p>
</div>
<div id="model-formulation" class="section level3 hasAnchor" number="9.2.5">
<h3><span class="header-section-number">9.2.5</span> Model formulation<a href="supervised_ml.html#model-formulation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The aim of supervised ML is to find a model <span class="math inline">\(\hat{y} = f(x)\)</span> so that <span class="math inline">\(\hat{y}\)</span> agrees well with observations <span class="math inline">\(y\)</span>. We typically start with a research question where <span class="math inline">\(y\)</span> is given - naturally - by the problem we are addressing and we have a data set at hand where one or multiple predictors (or “features”) <span class="math inline">\(x\)</span> are recorded along with <span class="math inline">\(y\)</span>. From our data, we have information about how GPP (ecosystem-level photosynthesis) depends on set of abiotic factors, mostly meteorological measurements.</p>
<div id="formula-notation" class="section level4 hasAnchor" number="9.2.5.1">
<h4><span class="header-section-number">9.2.5.1</span> Formula notation<a href="supervised_ml.html#formula-notation" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>In R, it is common to use the <em>formula</em> notation to specify the target and predictor variables. You have encountered formulas before, e.g., for a linear regression using the <code>lm()</code> function. To specify a linear regression model for <code>GPP_NT_VUT_REF</code> with three predictors <code>SW_F_IN</code>, <code>VPD_F</code>, and <code>TA_F</code>, to be fitted to data <code>ddf</code>, we write:</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb304-1"><a href="supervised_ml.html#cb304-1" aria-hidden="true" tabindex="-1"></a><span class="fu">lm</span>(GPP_NT_VUT_REF <span class="sc">~</span> SW_F_IN <span class="sc">+</span> VPD_F <span class="sc">+</span> TA_F, <span class="at">data =</span> ddf)</span></code></pre></div>
</div>
<div id="the-generic-train" class="section level4 hasAnchor" number="9.2.5.2">
<h4><span class="header-section-number">9.2.5.2</span> The generic <code>train()</code><a href="supervised_ml.html#the-generic-train" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The way we formulate a model can be understood as being independent of the algorithm, or <em>engine</em>, that takes care of fitting <span class="math inline">\(f(x)\)</span>. The R package <a href="https://topepo.github.io/caret/"><em>caret</em></a> provides a unified interface for using different ML algorithms implemented in separate packages. In other words, it acts as a <em>wrapper</em> for multiple different model fitting, or ML algorithms. This has the advantage that it unifies the interface - the way arguments are provided and outputs are returned. <em>caret</em> also provides implementations for a set of commonly used tools for data processing, model training, and evaluation. We’ll use <em>caret</em> here for model training with the function <code>train()</code>. Note however, that using a specific algorithm, which is implemented in a specific package outside <em>caret</em>, also requires that the respective package be installed and loaded. Using <em>caret</em> for specifying the same linear regression model as above, the base-R <code>lm()</code> function, can be done with caret in a generalized form as:</p>
<div class="sourceCode" id="cb305"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb305-1"><a href="supervised_ml.html#cb305-1" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">train</span>(</span>
<span id="cb305-2"><a href="supervised_ml.html#cb305-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">form =</span> GPP_NT_VUT_REF <span class="sc">~</span> SW_IN_F <span class="sc">+</span> VPD_F <span class="sc">+</span> TA_F, </span>
<span id="cb305-3"><a href="supervised_ml.html#cb305-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ddf <span class="sc">|&gt;</span> <span class="fu">drop_na</span>(),  <span class="co"># drop missing values</span></span>
<span id="cb305-4"><a href="supervised_ml.html#cb305-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> caret<span class="sc">::</span><span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;none&quot;</span>),  <span class="co"># no resampling</span></span>
<span id="cb305-5"><a href="supervised_ml.html#cb305-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">&quot;lm&quot;</span></span>
<span id="cb305-6"><a href="supervised_ml.html#cb305-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Linear Regression 
## 
## 2729 samples
##    3 predictor
## 
## No pre-processing
## Resampling: None</code></pre>
<p>Note the argument specified as <code>trControl = trainControl(method = "none")</code>. This suppresses the default approach to model fitting in <em>caret</em> - to <em>resample</em> using <em>bootstrapping.</em> More on that below. Note also that we dropped all rows that contained at least one missing value - necessary to apply the least squares method for the linear regression model fitting. It’s advisable to apply this data removal step only at the very last point of the data processing and modelling workflow. Alternative algorithms may be able to deal with missing values and we want to avoid losing information along the workflow.</p>
<p>Of course, it is an overkill compared to write this as in the chunk above compared to just writing <code>lm(...)</code>. But the advantage of the unified interface is that we can simply replace the <code>method</code> argument to use a different model fitting algorithm. For example, to use KNN, we just can write:</p>
<div class="sourceCode" id="cb307"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb307-1"><a href="supervised_ml.html#cb307-1" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">train</span>(</span>
<span id="cb307-2"><a href="supervised_ml.html#cb307-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">form =</span> GPP_NT_VUT_REF <span class="sc">~</span> SW_IN_F <span class="sc">+</span> VPD_F <span class="sc">+</span> TA_F, </span>
<span id="cb307-3"><a href="supervised_ml.html#cb307-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ddf <span class="sc">|&gt;</span> <span class="fu">drop_na</span>(), </span>
<span id="cb307-4"><a href="supervised_ml.html#cb307-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> caret<span class="sc">::</span><span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;none&quot;</span>),</span>
<span id="cb307-5"><a href="supervised_ml.html#cb307-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">&quot;knn&quot;</span></span>
<span id="cb307-6"><a href="supervised_ml.html#cb307-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## k-Nearest Neighbors 
## 
## 2729 samples
##    3 predictor
## 
## No pre-processing
## Resampling: None</code></pre>
</div>
</div>
<div id="data-splitting" class="section level3 hasAnchor" number="9.2.6">
<h3><span class="header-section-number">9.2.6</span> Data splitting<a href="supervised_ml.html#data-splitting" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The introductory example demonstrated the importance of validating the fitted model with data that was <em>not</em> used for training. Thus, we can test the model’s <em>generalisability</em> to new (“unseen”) data. The essential step that enables us to assess the model’s <em>generalization error</em> is to hold out part of the data from training and set it aside (leaving it absolutely untouched!) for <em>testing</em>.</p>
<p>There is no fixed rule for how much data are to be used for training and testing, respectively. We have to balance a trade-off:</p>
<ul>
<li>Spending too much data for training will leave us with too little data for testing and the test results may not be robust. In this case, the sample size for getting robust validation statistics is not sufficiently large and we don’t know for sure whether we are safe from an over-fit model.</li>
<li>Spending too much data for validation will leave us with too little data for training. In this case, the ML algorithm may not be successful at finding real relationships due to insufficient amounts of training data.</li>
</ul>
<p>Typical splits are between 60-80% for training. However, in cases where the number of data points is very large, the gains from having more training data are marginal, but come at the cost of adding to the already high computational burden of model training.</p>
<p>In environmental sciences, the number of predictors is often smaller than the sample size (<span class="math inline">\(p &lt; n\)</span>), because it is typically easier to collect repeated observations of a particular variable than to expand the set of variables being observed. Nevertheless, in cases where the number <span class="math inline">\(p\)</span> gets large, it is important, and for some algorithms mandatory, to maintain <span class="math inline">\(p &lt; n\)</span> for model training.</p>
<p>An important aspect to consider when splitting the data is to make sure that all “states” of the system for which we have data are well represented in training and testing sets. A particularly challenging case is posed when it is of particular interest that the algorithm learns relationships <span class="math inline">\(f(x)\)</span> under rare conditions <span class="math inline">\(x\)</span>, for example meteorological extreme events. If not addressed with particular measures, model training tends to achieve good model performance for the most common conditions. A simple way to put more emphasis for model training on extreme conditions is to compensate by sampling overly proportional from such cases for the training data set.</p>
<p>Several alternative functions for the data splitting step are available from different packages in R. We use the the <em>rsample</em> package here as it allows to additionally make sure that data from the full range of a given variable’s values (<code>VPD_F</code> in the example below) are well covered in both training and testing sets.</p>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb309-1"><a href="supervised_ml.html#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)  <span class="co"># for reproducibility</span></span>
<span id="cb309-2"><a href="supervised_ml.html#cb309-2" aria-hidden="true" tabindex="-1"></a>split <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">initial_split</span>(ddf, <span class="at">prop =</span> <span class="fl">0.7</span>, <span class="at">strata =</span> <span class="st">&quot;VPD_F&quot;</span>)</span>
<span id="cb309-3"><a href="supervised_ml.html#cb309-3" aria-hidden="true" tabindex="-1"></a>ddf_train <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">training</span>(split)</span>
<span id="cb309-4"><a href="supervised_ml.html#cb309-4" aria-hidden="true" tabindex="-1"></a>ddf_test <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">testing</span>(split)</span></code></pre></div>
<p>Plot the distribution of values in the training and testing sets.</p>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb310-1"><a href="supervised_ml.html#cb310-1" aria-hidden="true" tabindex="-1"></a>ddf_train <span class="sc">|&gt;</span> </span>
<span id="cb310-2"><a href="supervised_ml.html#cb310-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">split =</span> <span class="st">&quot;train&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb310-3"><a href="supervised_ml.html#cb310-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(ddf_test <span class="sc">|&gt;</span> </span>
<span id="cb310-4"><a href="supervised_ml.html#cb310-4" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">split =</span> <span class="st">&quot;test&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb310-5"><a href="supervised_ml.html#cb310-5" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">9</span>, <span class="at">names_to =</span> <span class="st">&quot;variable&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;value&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb310-6"><a href="supervised_ml.html#cb310-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value, <span class="at">y =</span> ..density.., <span class="at">color =</span> split)) <span class="sc">+</span></span>
<span id="cb310-7"><a href="supervised_ml.html#cb310-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb310-8"><a href="supervised_ml.html#cb310-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>variable, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-157-1.png" width="672" /></p>
</div>
<div id="preprocessing" class="section level3 hasAnchor" number="9.2.7">
<h3><span class="header-section-number">9.2.7</span> Pre-processing<a href="supervised_ml.html#preprocessing" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Data pre-processing is aimed at preparing the data for use in a specific model fitting procedure and at improving the effectiveness of model training. The splitting of the data into a training and test set makes sure that no information from the test set is used during or before model training. It is important that absolutely no information from the test set finds its way into the training set (<em>data leakage</em>).</p>
<p>In a general sense, pre-processing involve data transformations where the transformation functions use parameters that are determined on the data itself. Consider, for example, the <em>standardization</em>. That is, the linear transformation of a vector of values to have zero mean (data is <em>centered</em>, <span class="math inline">\(\mu = 0\)</span>) and a standard deviation of 1 (data is <em>scaled</em> to <span class="math inline">\(\sigma = 1\)</span>). In order to avoid data leakage, the mean and standard deviation have to be determined on the training set only. Then, the normalization of the training and the test sets both use set of (<span class="math inline">\(\mu, \sigma\)</span>) determined on the training set. Data leakage would occur if the (<span class="math inline">\(\mu, \sigma\)</span>) would be determined on data containing values from the test set.</p>
<p>Often, multiple splits of the data are considered during model training. Hence, an even larger number of data transformation parameters (<span class="math inline">\(\mu, \sigma\)</span> in the example of normalization) have to be determined and transformations applied to the multiple splits of the data. <em>caret</em> deals with this for you and the transformations do not have to be “manually” applied before applying the <code>train()</code> function call. Instead, the data pre-processing is considered an integral step of model training and instructions are specified as part of the <code>train()</code> function call and along with the un-transformed data.</p>
<p>The <a href="https://recipes.tidymodels.org/"><em>recipes</em></a> package provides an even more powerful way for specifying the <em>formula</em> and pre-processing steps in one go. It is compatible with the <code>train()</code> function of {caret}. For the same formula as above, and an example where the data <code>ddf_train</code> is to be normalized (centered and scaled), we can specify a “recipe” using the pipe operator as:</p>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb311-1"><a href="supervised_ml.html#cb311-1" aria-hidden="true" tabindex="-1"></a>pp <span class="ot">&lt;-</span> recipes<span class="sc">::</span><span class="fu">recipe</span>(GPP_NT_VUT_REF <span class="sc">~</span> SW_IN_F <span class="sc">+</span> VPD_F <span class="sc">+</span> TA_F, <span class="at">data =</span> ddf_train) <span class="sc">|&gt;</span> </span>
<span id="cb311-2"><a href="supervised_ml.html#cb311-2" aria-hidden="true" tabindex="-1"></a>  recipes<span class="sc">::</span><span class="fu">step_center</span>(<span class="fu">all_numeric</span>(), <span class="sc">-</span><span class="fu">all_outcomes</span>()) <span class="sc">|&gt;</span></span>
<span id="cb311-3"><a href="supervised_ml.html#cb311-3" aria-hidden="true" tabindex="-1"></a>  recipes<span class="sc">::</span><span class="fu">step_scale</span>(<span class="fu">all_numeric</span>(), <span class="sc">-</span><span class="fu">all_outcomes</span>())</span></code></pre></div>
<p>The first line with the <code>recipe()</code> function call assigns <em>roles</em> to the different variables. <code>GPP_NT_VUT_REF</code> is an <em>outcome</em> (in “{recipes} speak”). Then, we used selectors to apply the recipe step to several variables at once. The first selector, <code>all_numeric()</code>, selects all variables that are either integers or real values. The second selector, <code>-all_outcomes()</code> removes any outcome (target) variables from this recipe step. The returned object <code>pp</code> does <em>not</em> contain a normalized version of the data frame <code>ddf_train</code>, but rather the information that allows us to apply a specific set of pre-processing steps also to any data set.</p>
<p>The object <code>pp</code> can then be supplied to <code>train()</code> as its first argument:</p>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb312-1"><a href="supervised_ml.html#cb312-1" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">train</span>(</span>
<span id="cb312-2"><a href="supervised_ml.html#cb312-2" aria-hidden="true" tabindex="-1"></a>  pp, </span>
<span id="cb312-3"><a href="supervised_ml.html#cb312-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ddf_train, </span>
<span id="cb312-4"><a href="supervised_ml.html#cb312-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">&quot;knn&quot;</span>,</span>
<span id="cb312-5"><a href="supervised_ml.html#cb312-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> caret<span class="sc">::</span><span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;none&quot;</span>)</span>
<span id="cb312-6"><a href="supervised_ml.html#cb312-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>The example above showed data standardization as a data pre-processing step. Data pre-processing may be done with different aims, as described in sub-sections below.</p>
<div id="standardization" class="section level4 hasAnchor" number="9.2.7.1">
<h4><span class="header-section-number">9.2.7.1</span> Standardization<a href="supervised_ml.html#standardization" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Several algorithms explicitly require data to be standardized so that values of all predictors vary within a comparable range. The necessity of this step becomes obvious when considering KNN, where the magnitude of the distance is strongly influenced by the order of magnitude of the predictor values. To get a quick overview of the distribution of all variables (columns) in our data frame, we can use the {skimr} package.</p>
<div class="sourceCode" id="cb313"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb313-1"><a href="supervised_ml.html#cb313-1" aria-hidden="true" tabindex="-1"></a>skimr<span class="sc">::</span><span class="fu">skim</span>(ddf)</span></code></pre></div>
<table>
<caption><span id="tab:unnamed-chunk-160">Table 9.1: </span>Data summary</caption>
<tbody>
<tr class="odd">
<td align="left">Name</td>
<td align="left">ddf</td>
</tr>
<tr class="even">
<td align="left">Number of rows</td>
<td align="left">6574</td>
</tr>
<tr class="odd">
<td align="left">Number of columns</td>
<td align="left">9</td>
</tr>
<tr class="even">
<td align="left">_______________________</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Column type frequency:</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">Date</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">numeric</td>
<td align="left">8</td>
</tr>
<tr class="even">
<td align="left">________________________</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Group variables</td>
<td align="left">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: Date</strong></p>
<table>
<colgroup>
<col width="17%" />
<col width="12%" />
<col width="17%" />
<col width="13%" />
<col width="13%" />
<col width="13%" />
<col width="11%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="left">min</th>
<th align="left">max</th>
<th align="left">median</th>
<th align="right">n_unique</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">TIMESTAMP</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">1997-01-01</td>
<td align="left">2014-12-31</td>
<td align="left">2005-12-31</td>
<td align="right">6574</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table style="width:100%;">
<colgroup>
<col width="16%" />
<col width="10%" />
<col width="15%" />
<col width="7%" />
<col width="6%" />
<col width="7%" />
<col width="7%" />
<col width="7%" />
<col width="7%" />
<col width="7%" />
<col width="6%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">mean</th>
<th align="right">sd</th>
<th align="right">p0</th>
<th align="right">p25</th>
<th align="right">p50</th>
<th align="right">p75</th>
<th align="right">p100</th>
<th align="left">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">GPP_NT_VUT_REF</td>
<td align="right">395</td>
<td align="right">0.94</td>
<td align="right">3.22</td>
<td align="right">2.76</td>
<td align="right">-4.23</td>
<td align="right">0.77</td>
<td align="right">2.87</td>
<td align="right">5.45</td>
<td align="right">12.26</td>
<td align="left">▁▇▆▃▁</td>
</tr>
<tr class="even">
<td align="left">TA_F</td>
<td align="right">265</td>
<td align="right">0.96</td>
<td align="right">3.57</td>
<td align="right">6.62</td>
<td align="right">-21.92</td>
<td align="right">-1.47</td>
<td align="right">3.51</td>
<td align="right">8.72</td>
<td align="right">20.69</td>
<td align="left">▁▂▇▇▂</td>
</tr>
<tr class="odd">
<td align="left">SW_IN_F</td>
<td align="right">232</td>
<td align="right">0.96</td>
<td align="right">149.84</td>
<td align="right">84.95</td>
<td align="right">3.30</td>
<td align="right">77.84</td>
<td align="right">135.02</td>
<td align="right">213.81</td>
<td align="right">365.89</td>
<td align="left">▆▇▆▅▂</td>
</tr>
<tr class="even">
<td align="left">LW_IN_F</td>
<td align="right">3706</td>
<td align="right">0.44</td>
<td align="right">273.53</td>
<td align="right">44.10</td>
<td align="right">138.12</td>
<td align="right">243.16</td>
<td align="right">278.67</td>
<td align="right">307.91</td>
<td align="right">364.91</td>
<td align="left">▁▃▆▇▃</td>
</tr>
<tr class="odd">
<td align="left">VPD_F</td>
<td align="right">265</td>
<td align="right">0.96</td>
<td align="right">2.86</td>
<td align="right">2.41</td>
<td align="right">0.00</td>
<td align="right">0.96</td>
<td align="right">2.23</td>
<td align="right">4.06</td>
<td align="right">16.57</td>
<td align="left">▇▃▁▁▁</td>
</tr>
<tr class="even">
<td align="left">PA_F</td>
<td align="right">247</td>
<td align="right">0.96</td>
<td align="right">83.57</td>
<td align="right">0.72</td>
<td align="right">80.37</td>
<td align="right">83.16</td>
<td align="right">83.68</td>
<td align="right">84.07</td>
<td align="right">85.63</td>
<td align="left">▁▁▅▇▁</td>
</tr>
<tr class="odd">
<td align="left">P_F</td>
<td align="right">0</td>
<td align="right">1.00</td>
<td align="right">2.30</td>
<td align="right">5.79</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">1.60</td>
<td align="right">92.10</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td align="left">WS_F</td>
<td align="right">341</td>
<td align="right">0.95</td>
<td align="right">2.00</td>
<td align="right">0.65</td>
<td align="right">0.41</td>
<td align="right">1.55</td>
<td align="right">1.93</td>
<td align="right">2.34</td>
<td align="right">6.54</td>
<td align="left">▃▇▁▁▁</td>
</tr>
</tbody>
</table>
<p>We see for example, that typical values of <code>LW_IN_F</code> are by a factor 100 larger than values of <code>VPD_F</code>. A distance calculated based on these raw values would therefore be strongly dominated by the difference in <code>LW_IN_F</code> values, and differences in <code>VPD_F</code> would hardly affect the distance. Therefore, the data must be <em>standardized</em> before using it with the KNN algorithm (and other algorithms, including Neural Networks). Standardization is done to each variable separately, by centering and scaling each to have <span class="math inline">\(\mu = 0\)</span> and <span class="math inline">\(\sigma = 1\)</span>.</p>
<p>The steps for centering and scaling using the recipes package are described above.</p>
<p>Standardization can be done not only by centering and scaling (as described above), but also by <em>scaling to within range</em>, where values are scaled such that the minimum value within each variable (column) is 0 and the maximum is 1.</p>
<p>As seen above for the feature engineering example, the object <code>pp</code> does not contain a standardized version of the data frame <code>ddf_train</code>, but rather the information that allows us to apply the same standardization also to other data. In other words, <code>recipe(..., data = ddf_train) |&gt; step_center(...) |&gt; step_scale(...)</code> doesn’t actually transform <code>ddf_train</code>. There are two more steps involved to get there. This might seem bothersome at first but their separation is critical in the context of model training and data leakage, and translates the conception of the pre-processing as a “recipe” into the way we write the code.</p>
<p>To actually transform the data, we first have to “prepare” the recipe:</p>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb314-1"><a href="supervised_ml.html#cb314-1" aria-hidden="true" tabindex="-1"></a>pp_prep <span class="ot">&lt;-</span> recipes<span class="sc">::</span><span class="fu">prep</span>(pp, <span class="at">training =</span> ddf_train) </span></code></pre></div>
<p>Finally we can actually transform the data. That is, “bake” the prepared recipe.</p>
<div class="sourceCode" id="cb315"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb315-1"><a href="supervised_ml.html#cb315-1" aria-hidden="true" tabindex="-1"></a>ddf_baked <span class="ot">&lt;-</span> recipes<span class="sc">::</span><span class="fu">bake</span>(pp_prep, <span class="at">new_data =</span> ddf_train)</span></code></pre></div>
<p>The effect is of standardization is illustrated by comparing original and transformed variables:</p>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb316-1"><a href="supervised_ml.html#cb316-1" aria-hidden="true" tabindex="-1"></a>gg1 <span class="ot">&lt;-</span> ddf_train <span class="sc">|&gt;</span> </span>
<span id="cb316-2"><a href="supervised_ml.html#cb316-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">one_of</span>(<span class="fu">c</span>(<span class="st">&quot;SW_IN_F&quot;</span>, <span class="st">&quot;VPD_F&quot;</span>, <span class="st">&quot;TA_F&quot;</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb316-3"><a href="supervised_ml.html#cb316-3" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(SW_IN_F, VPD_F, TA_F), <span class="at">names_to =</span> <span class="st">&quot;var&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;val&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb316-4"><a href="supervised_ml.html#cb316-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(val, ..density..)) <span class="sc">+</span></span>
<span id="cb316-5"><a href="supervised_ml.html#cb316-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb316-6"><a href="supervised_ml.html#cb316-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>var)</span>
<span id="cb316-7"><a href="supervised_ml.html#cb316-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-8"><a href="supervised_ml.html#cb316-8" aria-hidden="true" tabindex="-1"></a>gg2 <span class="ot">&lt;-</span> ddf_baked <span class="sc">|&gt;</span> </span>
<span id="cb316-9"><a href="supervised_ml.html#cb316-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">one_of</span>(<span class="fu">c</span>(<span class="st">&quot;SW_IN_F&quot;</span>, <span class="st">&quot;VPD_F&quot;</span>, <span class="st">&quot;TA_F&quot;</span>))) <span class="sc">|&gt;</span> </span>
<span id="cb316-10"><a href="supervised_ml.html#cb316-10" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(SW_IN_F, VPD_F, TA_F), <span class="at">names_to =</span> <span class="st">&quot;var&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;val&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb316-11"><a href="supervised_ml.html#cb316-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(val, ..density..)) <span class="sc">+</span></span>
<span id="cb316-12"><a href="supervised_ml.html#cb316-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb316-13"><a href="supervised_ml.html#cb316-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>var)</span>
<span id="cb316-14"><a href="supervised_ml.html#cb316-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb316-15"><a href="supervised_ml.html#cb316-15" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(gg1, gg2, <span class="at">nrow =</span> <span class="dv">2</span>)</span></code></pre></div>
<pre><code>## Warning: Removed 545 rows containing non-finite values (`stat_density()`).
## Removed 545 rows containing non-finite values (`stat_density()`).</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-163-1.png" width="672" /></p>
</div>
<div id="handling-missing-data-1" class="section level4 hasAnchor" number="9.2.7.2">
<h4><span class="header-section-number">9.2.7.2</span> Handling missing data<a href="supervised_ml.html#handling-missing-data-1" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Several machine learning algorithms require missing values to be removed. That is, if any of the cells in one row has a missing value, the entire cell gets removed. This can lead to severe data loss. In cases where missing values appear predominantly in only a few variables, it may be advantageous to drop the affected variable from the data for modelling. In other cases, it may be advantageous to fill missing values (data <em>imputation</em>, see next section). Although such imputed data is “fake”, it may be preferred to impute values than to drop entire rows and thus get the benefit of being able to use the information contained in available (real) values of affected rows. Whether or not imputation is preferred should be determined based on the model skill for an an out-of-sample test (more on that later).</p>
<p>Visualizing missing data is the essential first step in making decisions about dropping rows with missing data versus removing predictors from the model (which would imply too much data removal).</p>
<div class="sourceCode" id="cb318"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb318-1"><a href="supervised_ml.html#cb318-1" aria-hidden="true" tabindex="-1"></a>visdat<span class="sc">::</span><span class="fu">vis_miss</span>(</span>
<span id="cb318-2"><a href="supervised_ml.html#cb318-2" aria-hidden="true" tabindex="-1"></a>  ddf,</span>
<span id="cb318-3"><a href="supervised_ml.html#cb318-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster =</span> <span class="cn">FALSE</span>, </span>
<span id="cb318-4"><a href="supervised_ml.html#cb318-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">warn_large_data =</span> <span class="cn">FALSE</span></span>
<span id="cb318-5"><a href="supervised_ml.html#cb318-5" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-164-1.png" width="672" /></p>
<p>Here, the variable <code>LW_IN_F</code> (longwave radiation) if affected by a lot of missing data. Note that we applied a data cleaning step along with the data read-in at the very top of this Chapter. There, we applied a filtering criterion where values are only retained if at least 80% of the underlying half-hourly data is actual measured (and not gap-filled) data. Whether to drop the variable for further modelling should be informed also by our understanding of the data and the processes relevant for the modelling task. Here, the modelling target is GPP and the carbon cycle specialists among the readers may know that longwave radiation is not a known important control on GPP (ecosystem photosynthesis). Therefore, we may consider dropping this variable from the dataset for our modelling task. The remaining variables are affected by less frequent missingness with which we will deal otherwise.</p>
</div>
<div id="imputation" class="section level4 hasAnchor" number="9.2.7.3">
<h4><span class="header-section-number">9.2.7.3</span> Imputation<a href="supervised_ml.html#imputation" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Imputation refers to the replacement of missing values with with a “best guess” value (<a href="https://bradleyboehmke.github.io/HOML/">Boehmke &amp; Greenwell</a>). Different approaches exist for determining that best guess. The most basic approach is to impute missing values with the mean or median of the available values of the same variable, which can be implemented using <code>step_impute_*()</code> from the {recipes} package. For example, to impute the median for all predictors separately:</p>
<div class="sourceCode" id="cb319"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb319-1"><a href="supervised_ml.html#cb319-1" aria-hidden="true" tabindex="-1"></a>pp <span class="sc">|&gt;</span> </span>
<span id="cb319-2"><a href="supervised_ml.html#cb319-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(<span class="fu">all_predictors</span>())</span></code></pre></div>
<pre><code>## Recipe
## 
## Inputs:
## 
##       role #variables
##    outcome          1
##  predictor          3
## 
## Operations:
## 
## Centering for all_numeric(), -all_outcomes()
## Scaling for all_numeric(), -all_outcomes()
## Median imputation for all_predictors()</code></pre>
<p>Imputing by the mean or median is “uninformative”. We may use information about the co-variation of multiple variables for imputing missing values. For example, for imputing missing VPD values, we may consider the fact that VPD tends to be high when air temperature is high. Therefore, missing VPD values can be modeled as a function of other co-variates (predictors). Several approaches to modelling missing values are available through the recipes package (see <a href="https://recipes.tidymodels.org/reference/index.html#step-functions-imputation">here</a>). For example, we can use KNN with five neighbors as:</p>
<div class="sourceCode" id="cb321"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb321-1"><a href="supervised_ml.html#cb321-1" aria-hidden="true" tabindex="-1"></a>pp <span class="sc">|&gt;</span> </span>
<span id="cb321-2"><a href="supervised_ml.html#cb321-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_knn</span>(<span class="fu">all_predictors</span>(), <span class="at">neighbors =</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## Recipe
## 
## Inputs:
## 
##       role #variables
##    outcome          1
##  predictor          3
## 
## Operations:
## 
## Centering for all_numeric(), -all_outcomes()
## Scaling for all_numeric(), -all_outcomes()
## K-nearest neighbor imputation for all_predictors()</code></pre>
</div>
<div id="one-hot-encoding" class="section level4 hasAnchor" number="9.2.7.4">
<h4><span class="header-section-number">9.2.7.4</span> One-hot encoding<a href="supervised_ml.html#one-hot-encoding" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>For ML algorithms that require that all predictors be numerical (e.g., neural networks, or KNN), categorical predictors have to be pre-processed and converted into new numerical predictors. The most common such transformation is <em>one-hot encoding</em>, where a categorical predictor variable that has <span class="math inline">\(N\)</span> levels is replaced by <span class="math inline">\(N\)</span> new variables that contain either zeros or ones depending whether the value of the categorical feature corresponds to the respective column. Because this creates perfect collinearity between these new column, we can also drop one of them. This is referred to as <em>dummy encoding</em>.</p>
<div class="sourceCode" id="cb323"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb323-1"><a href="supervised_ml.html#cb323-1" aria-hidden="true" tabindex="-1"></a><span class="co"># original data frame</span></span>
<span id="cb323-2"><a href="supervised_ml.html#cb323-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>, <span class="at">color =</span> <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;red&quot;</span>, <span class="st">&quot;green&quot;</span>, <span class="st">&quot;blue&quot;</span>))</span>
<span id="cb323-3"><a href="supervised_ml.html#cb323-3" aria-hidden="true" tabindex="-1"></a>df</span></code></pre></div>
<pre><code>## # A tibble: 4 × 2
##      id color
##   &lt;int&gt; &lt;chr&gt;
## 1     1 red  
## 2     2 red  
## 3     3 green
## 4     4 blue</code></pre>
<div class="sourceCode" id="cb325"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb325-1"><a href="supervised_ml.html#cb325-1" aria-hidden="true" tabindex="-1"></a><span class="co"># after one-hot encoding</span></span>
<span id="cb325-2"><a href="supervised_ml.html#cb325-2" aria-hidden="true" tabindex="-1"></a>dmy <span class="ot">&lt;-</span> <span class="fu">dummyVars</span>(<span class="st">&quot;~ .&quot;</span>, <span class="at">data =</span> df, <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)</span>
<span id="cb325-3"><a href="supervised_ml.html#cb325-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="fu">predict</span>(dmy, <span class="at">newdata =</span> df))</span></code></pre></div>
<pre><code>##   id colorblue colorgreen colorred
## 1  1         0          0        1
## 2  2         0          0        1
## 3  3         0          1        0
## 4  4         1          0        0</code></pre>
<p>Note that in a case where color is strictly one of <code>c("red", "red", "green", "blue")</code> (and not, for example, <code>"yellow"</code>), then one of the columns added by <code>dummyVars()</code> is obsolete (if it’s neither <code>"red"</code>, nor <code>"green"</code>, it must be <code>"blue"</code>) - columns are collinear. This can be avoided by <code>setting fullRank = FALSE</code>.</p>
<p>Using the recipes package, one-hot encoding is implemented by:</p>
<div class="sourceCode" id="cb327"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb327-1"><a href="supervised_ml.html#cb327-1" aria-hidden="true" tabindex="-1"></a><span class="fu">recipe</span>(GPP_NT_VUT_REF <span class="sc">~</span> ., <span class="at">data =</span> ddf) <span class="sc">|&gt;</span> </span>
<span id="cb327-2"><a href="supervised_ml.html#cb327-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal</span>(), <span class="at">one_hot =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## Recipe
## 
## Inputs:
## 
##       role #variables
##    outcome          1
##  predictor          8
## 
## Operations:
## 
## Dummy variables from all_nominal()</code></pre>
</div>
<div id="zero-variance-predictors" class="section level4 hasAnchor" number="9.2.7.5">
<h4><span class="header-section-number">9.2.7.5</span> Zero-variance predictors<a href="supervised_ml.html#zero-variance-predictors" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Sometimes, the data generation process yields variables that have the same value in each observation. And sometimes this is due to failure of the measurement device or some other bug in the data collection pipeline. Either way, this may cause some algorithms to crash or become unstable. Such “zero-variance” predictors are usually removed altogether. The same applies also to variables with “near-zero variance”. That is, variables where only a few unique values occur with a high frequency in the entire data set. The danger is that, when data is split into training and testing sets, the variable may effectively become a “zero-variance” variable within the training subset.</p>
<p>We can test for zero-variance or near-zero variance predictors by quantifying the following metrics:</p>
<ul>
<li>Frequency ratio: Ratio of the frequency of the most common predictor over the second most common predictor. This should be near 1 for well-behaved predictors and get very large for problematic ones.</li>
<li>Percent unique values: The number of unique values divided by the total number of rows in the data set (times 100). For problematic variables, this ratio gets small (approaches 1/100).</li>
</ul>
<p>The function <code>nearZeroVar</code> of the {caret} package flags suspicious variables (<code>zeroVar = TRUE</code> or <code>nzv = TRUE</code>). In our data set, we don’t find any:</p>
<div class="sourceCode" id="cb329"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb329-1"><a href="supervised_ml.html#cb329-1" aria-hidden="true" tabindex="-1"></a>caret<span class="sc">::</span><span class="fu">nearZeroVar</span>(ddf, <span class="at">saveMetrics =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>##                freqRatio percentUnique zeroVar   nzv
## TIMESTAMP       1.000000    100.000000   FALSE FALSE
## GPP_NT_VUT_REF  1.000000     93.732887   FALSE FALSE
## TA_F            1.000000     83.951932   FALSE FALSE
## SW_IN_F         1.500000     95.375723   FALSE FALSE
## LW_IN_F         1.000000     43.170064   FALSE FALSE
## VPD_F           1.142857     60.450259   FALSE FALSE
## PA_F            1.090909     37.906906   FALSE FALSE
## P_F            10.268072      5.978096   FALSE FALSE
## WS_F            1.083333     34.758138   FALSE FALSE</code></pre>
<p>Using the recipes package, we can add a step that removes zero-variance predictors by:</p>
<div class="sourceCode" id="cb331"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb331-1"><a href="supervised_ml.html#cb331-1" aria-hidden="true" tabindex="-1"></a>pp <span class="sc">|&gt;</span> </span>
<span id="cb331-2"><a href="supervised_ml.html#cb331-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>())</span></code></pre></div>
<pre><code>## Recipe
## 
## Inputs:
## 
##       role #variables
##    outcome          1
##  predictor          3
## 
## Operations:
## 
## Centering for all_numeric(), -all_outcomes()
## Scaling for all_numeric(), -all_outcomes()
## Zero variance filter on all_predictors()</code></pre>
</div>
<div id="target-engineering" class="section level4 hasAnchor" number="9.2.7.6">
<h4><span class="header-section-number">9.2.7.6</span> Target engineering<a href="supervised_ml.html#target-engineering" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Target engineering refers to pre-processing of the target variable. Its application can enable improved predictions, particularly for models that make assumptions about prediction errors (e.g., normally distributed errors in linear regression) or when the target variable follows a “special” distribution (e.g., heavily skewed distribution, or where the target variable is a fraction that is naturally bounded by 0 and 1). A simple log-transformation of the target variable can often resolve issues with skewed distributions. An implication of a log-transformation is that errors in predicting values in the upper end of the observed range are “discounted” in their weight compared to errors in the lower range.</p>
<p>In our data set, the variable <code>WS_F</code> (wind speed) is skewed. The target variable that we have considered so far (<code>GPP_NT_VUT_REF</code>) is not skewed. In a case where we would consider <code>WS_F</code> to be our target variable, we would thus consider applying a log-transformation.</p>
<div class="sourceCode" id="cb333"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb333-1"><a href="supervised_ml.html#cb333-1" aria-hidden="true" tabindex="-1"></a>gg1 <span class="ot">&lt;-</span> ddf <span class="sc">|&gt;</span> </span>
<span id="cb333-2"><a href="supervised_ml.html#cb333-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> WS_F, <span class="at">y =</span> ..density..)) <span class="sc">+</span></span>
<span id="cb333-3"><a href="supervised_ml.html#cb333-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>() <span class="sc">+</span></span>
<span id="cb333-4"><a href="supervised_ml.html#cb333-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Original&quot;</span>)</span>
<span id="cb333-5"><a href="supervised_ml.html#cb333-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb333-6"><a href="supervised_ml.html#cb333-6" aria-hidden="true" tabindex="-1"></a>gg2 <span class="ot">&lt;-</span> ddf <span class="sc">|&gt;</span> </span>
<span id="cb333-7"><a href="supervised_ml.html#cb333-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(WS_F), <span class="at">y =</span> ..density..)) <span class="sc">+</span></span>
<span id="cb333-8"><a href="supervised_ml.html#cb333-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>() <span class="sc">+</span></span>
<span id="cb333-9"><a href="supervised_ml.html#cb333-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Log-transformed&quot;</span>)</span>
<span id="cb333-10"><a href="supervised_ml.html#cb333-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb333-11"><a href="supervised_ml.html#cb333-11" aria-hidden="true" tabindex="-1"></a>cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(gg1, gg2)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-171-1.png" width="672" /></p>
<p>Log transformation as part of the pre-processing is specified using the <code>step_log()</code> function, here applied to the model target variable (<code>all_outcomes()</code>).</p>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb334-1"><a href="supervised_ml.html#cb334-1" aria-hidden="true" tabindex="-1"></a>recipes<span class="sc">::</span><span class="fu">recipe</span>(WS_F <span class="sc">~</span> ., <span class="at">data =</span> ddf) <span class="sc">|&gt;</span>   <span class="co"># it&#39;s of course non-sense to model wind speed like this</span></span>
<span id="cb334-2"><a href="supervised_ml.html#cb334-2" aria-hidden="true" tabindex="-1"></a>  recipes<span class="sc">::</span><span class="fu">step_log</span>(<span class="fu">all_outcomes</span>())</span></code></pre></div>
<p>A log-transformation doesn’t necessarily result in a perfect normal distribution of transformed values. The <em>Box-Cox</em> can get us closer. It can be considered a generalization of the log-transformation. Values are transformed according to the following function:
<span class="math display">\[
y(\lambda) = \begin{cases}
\frac{Y^\lambda-1}{\lambda}, &amp;\; y \neq 0\\
\log(Y),                     &amp;\; y = 0
\end{cases}
\]</span>
<span class="math inline">\(\lambda\)</span> is treated as a parameter that is fitted such that the resulting distribution of values <span class="math inline">\(y\)</span> approaches the normal distribution. To specify a Box-Cox-transformation as part of the pre-processing, we can use <code>step_BoxCox()</code> from the {recipes} package.</p>
<div class="sourceCode" id="cb335"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb335-1"><a href="supervised_ml.html#cb335-1" aria-hidden="true" tabindex="-1"></a>pp <span class="ot">&lt;-</span> <span class="fu">recipe</span>(WS_F <span class="sc">~</span> ., <span class="at">data =</span> ddf_train) <span class="sc">|&gt;</span></span>
<span id="cb335-2"><a href="supervised_ml.html#cb335-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_BoxCox</span>(<span class="fu">all_outcomes</span>())</span></code></pre></div>
<p>How do transformed values look like?</p>
<div class="sourceCode" id="cb336"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb336-1"><a href="supervised_ml.html#cb336-1" aria-hidden="true" tabindex="-1"></a>prep_pp <span class="ot">&lt;-</span> <span class="fu">prep</span>(pp, <span class="at">training =</span> ddf_train <span class="sc">|&gt;</span> <span class="fu">drop_na</span>())</span>
<span id="cb336-2"><a href="supervised_ml.html#cb336-2" aria-hidden="true" tabindex="-1"></a>ddf_baked <span class="ot">&lt;-</span> <span class="fu">bake</span>(prep_pp, <span class="at">new_data =</span> ddf_test <span class="sc">|&gt;</span> <span class="fu">drop_na</span>())</span>
<span id="cb336-3"><a href="supervised_ml.html#cb336-3" aria-hidden="true" tabindex="-1"></a>ddf_baked <span class="sc">|&gt;</span></span>
<span id="cb336-4"><a href="supervised_ml.html#cb336-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> WS_F, <span class="at">y =</span> ..density..)) <span class="sc">+</span></span>
<span id="cb336-5"><a href="supervised_ml.html#cb336-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>() <span class="sc">+</span></span>
<span id="cb336-6"><a href="supervised_ml.html#cb336-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Box-Cox-transformed&quot;</span>)</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-174-1.png" width="672" /></p>
<p>Note that the Box-Cox-transformation can only be applied to values that are strictly positive. In our example, wind speed (<code>WS_F</code>) is. If this is not satisfied, a Yeo-Johnson transformation can be applied.</p>
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb338-1"><a href="supervised_ml.html#cb338-1" aria-hidden="true" tabindex="-1"></a><span class="fu">recipe</span>(WS_F <span class="sc">~</span> ., <span class="at">data =</span> ddf) <span class="sc">|&gt;</span></span>
<span id="cb338-2"><a href="supervised_ml.html#cb338-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_YeoJohnson</span>(<span class="fu">all_outcomes</span>())</span></code></pre></div>
<pre><code>## Recipe
## 
## Inputs:
## 
##       role #variables
##    outcome          1
##  predictor          8
## 
## Operations:
## 
## Yeo-Johnson transformation on all_outcomes()</code></pre>
</div>
</div>
<div id="putting-it-all-together-half-way" class="section level3 hasAnchor" number="9.2.8">
<h3><span class="header-section-number">9.2.8</span> Putting it all together (half-way)<a href="supervised_ml.html#putting-it-all-together-half-way" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Let’s recap. We have a dataset <code>ddf</code> and we want to predict ecosystem GPP (<code>GPP_NT_VUT_REF</code>) from a set of predictors - environmental covariates that were measured in parallel to GPP. Let’s compare the performance of a multivariate linear regression and KNN model in terms of its generalisation to data that was not used for model fitting. The following pieces are implemented:</p>
<ul>
<li>Missing data: We’ve seen that the predictor <code>LW_IN_F</code> has lots of missing values and - given <em>a priori</em> knowledge is not critical for predicting GPP and we’ll drop it.</li>
<li>Data cleaning: Data (<code>ddf</code>) was cleaned based on quality control information upon reading the data at the beginning of this Chapter. Before modelling, we’re checking the distribution of the target value here again to make sure it is “well-behaved”.</li>
<li>Imputation: We drop rows with missing data for model training, instead of imputing them.</li>
<li>Some of the predictors are distintively not normally distributed. Let’s Box-Cox transform all predictors as a pre-processing step.</li>
<li>We have to standardize the data in order to use it for KNN.</li>
<li>We have no variable, where zero-variance was detected and we have no categorical variables that have to be transformed by one-hot encoding to be used in KNN. We use a data split, whithholding 30% for testing.</li>
<li>Take <span class="math inline">\(k=10\)</span> for the KNN model. Other choices are possible and will affect the prediction error on the training and the testing data in different manners. We’ll learn more about the optimal choice of <span class="math inline">\(k\)</span> (<em>hyperparameter tuning</em>) in the next chapter.</li>
<li>Fit models to minimize the root mean square error (RMSE) between predictions and observations. More on the choice of the <code>metric</code> argument in <code>train()</code> (<em>loss function</em>) in the next chapter.</li>
<li>For the KNN model, use <span class="math inline">\(k=5\)</span>.</li>
</ul>
<p>These steps are implemented by the code below.</p>
<div class="sourceCode" id="cb340"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb340-1"><a href="supervised_ml.html#cb340-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data cleaning: looks ok, no obviously bad data</span></span>
<span id="cb340-2"><a href="supervised_ml.html#cb340-2" aria-hidden="true" tabindex="-1"></a><span class="co"># no long tail, therefore no further target engineering</span></span>
<span id="cb340-3"><a href="supervised_ml.html#cb340-3" aria-hidden="true" tabindex="-1"></a>ddf <span class="sc">|&gt;</span> </span>
<span id="cb340-4"><a href="supervised_ml.html#cb340-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> GPP_NT_VUT_REF, <span class="at">y =</span> ..count..)) <span class="sc">+</span> </span>
<span id="cb340-5"><a href="supervised_ml.html#cb340-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>()</span></code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<pre><code>## Warning: Removed 395 rows containing non-finite values (`stat_bin()`).</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-176-1.png" width="672" /></p>
<div class="sourceCode" id="cb343"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb343-1"><a href="supervised_ml.html#cb343-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data splitting</span></span>
<span id="cb343-2"><a href="supervised_ml.html#cb343-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1982</span>)  <span class="co"># for reproducibility</span></span>
<span id="cb343-3"><a href="supervised_ml.html#cb343-3" aria-hidden="true" tabindex="-1"></a>split <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">initial_split</span>(ddf, <span class="at">prop =</span> <span class="fl">0.7</span>, <span class="at">strata =</span> <span class="st">&quot;VPD_F&quot;</span>)</span>
<span id="cb343-4"><a href="supervised_ml.html#cb343-4" aria-hidden="true" tabindex="-1"></a>ddf_train <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">training</span>(split)</span>
<span id="cb343-5"><a href="supervised_ml.html#cb343-5" aria-hidden="true" tabindex="-1"></a>ddf_test <span class="ot">&lt;-</span> rsample<span class="sc">::</span><span class="fu">testing</span>(split)</span>
<span id="cb343-6"><a href="supervised_ml.html#cb343-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb343-7"><a href="supervised_ml.html#cb343-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Model and pre-processing formulation, use all variables but LW_IN_F</span></span>
<span id="cb343-8"><a href="supervised_ml.html#cb343-8" aria-hidden="true" tabindex="-1"></a>pp <span class="ot">&lt;-</span> recipes<span class="sc">::</span><span class="fu">recipe</span>(GPP_NT_VUT_REF <span class="sc">~</span> SW_IN_F <span class="sc">+</span> VPD_F <span class="sc">+</span> TA_F <span class="sc">+</span> PA_F <span class="sc">+</span> P_F <span class="sc">+</span> WS_F, </span>
<span id="cb343-9"><a href="supervised_ml.html#cb343-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> ddf_train <span class="sc">|&gt;</span> <span class="fu">drop_na</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb343-10"><a href="supervised_ml.html#cb343-10" aria-hidden="true" tabindex="-1"></a>  recipes<span class="sc">::</span><span class="fu">step_BoxCox</span>(<span class="fu">all_predictors</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb343-11"><a href="supervised_ml.html#cb343-11" aria-hidden="true" tabindex="-1"></a>  recipes<span class="sc">::</span><span class="fu">step_center</span>(<span class="fu">all_numeric</span>(), <span class="sc">-</span><span class="fu">all_outcomes</span>()) <span class="sc">|&gt;</span></span>
<span id="cb343-12"><a href="supervised_ml.html#cb343-12" aria-hidden="true" tabindex="-1"></a>  recipes<span class="sc">::</span><span class="fu">step_scale</span>(<span class="fu">all_numeric</span>(), <span class="sc">-</span><span class="fu">all_outcomes</span>())</span>
<span id="cb343-13"><a href="supervised_ml.html#cb343-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb343-14"><a href="supervised_ml.html#cb343-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit linear regression model</span></span>
<span id="cb343-15"><a href="supervised_ml.html#cb343-15" aria-hidden="true" tabindex="-1"></a>mod_lm <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(</span>
<span id="cb343-16"><a href="supervised_ml.html#cb343-16" aria-hidden="true" tabindex="-1"></a>  pp, </span>
<span id="cb343-17"><a href="supervised_ml.html#cb343-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ddf_train <span class="sc">|&gt;</span> <span class="fu">drop_na</span>(), </span>
<span id="cb343-18"><a href="supervised_ml.html#cb343-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">&quot;lm&quot;</span>,</span>
<span id="cb343-19"><a href="supervised_ml.html#cb343-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> caret<span class="sc">::</span><span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;none&quot;</span>),</span>
<span id="cb343-20"><a href="supervised_ml.html#cb343-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">metric =</span> <span class="st">&quot;RMSE&quot;</span></span>
<span id="cb343-21"><a href="supervised_ml.html#cb343-21" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Warning: Non-positive values in selected variable.</code></pre>
<pre><code>## Warning: Non-positive values in selected variable.</code></pre>
<pre><code>## Warning: No Box-Cox transformation could be estimated for: `TA_F`, `PA_F`, `P_F`</code></pre>
<pre><code>## Warning: Non-positive values in selected variable.
## Non-positive values in selected variable.</code></pre>
<pre><code>## Warning: No Box-Cox transformation could be estimated for: `TA_F`, `PA_F`, `P_F`</code></pre>
<div class="sourceCode" id="cb349"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb349-1"><a href="supervised_ml.html#cb349-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit KNN model</span></span>
<span id="cb349-2"><a href="supervised_ml.html#cb349-2" aria-hidden="true" tabindex="-1"></a>mod_knn <span class="ot">&lt;-</span> caret<span class="sc">::</span><span class="fu">train</span>(</span>
<span id="cb349-3"><a href="supervised_ml.html#cb349-3" aria-hidden="true" tabindex="-1"></a>  pp, </span>
<span id="cb349-4"><a href="supervised_ml.html#cb349-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ddf_train <span class="sc">|&gt;</span> <span class="fu">drop_na</span>(), </span>
<span id="cb349-5"><a href="supervised_ml.html#cb349-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">&quot;knn&quot;</span>,</span>
<span id="cb349-6"><a href="supervised_ml.html#cb349-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> caret<span class="sc">::</span><span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;none&quot;</span>),</span>
<span id="cb349-7"><a href="supervised_ml.html#cb349-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuneGrid =</span> <span class="fu">data.frame</span>(<span class="at">k =</span> <span class="dv">5</span>),</span>
<span id="cb349-8"><a href="supervised_ml.html#cb349-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">metric =</span> <span class="st">&quot;RMSE&quot;</span></span>
<span id="cb349-9"><a href="supervised_ml.html#cb349-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Warning: Non-positive values in selected variable.</code></pre>
<pre><code>## Warning: Non-positive values in selected variable.</code></pre>
<pre><code>## Warning: No Box-Cox transformation could be estimated for: `TA_F`, `PA_F`, `P_F`</code></pre>
<pre><code>## Warning: Non-positive values in selected variable.
## Non-positive values in selected variable.</code></pre>
<pre><code>## Warning: No Box-Cox transformation could be estimated for: `TA_F`, `PA_F`, `P_F`</code></pre>
<p>We can use the model objects <code>mod_lm</code> and <code>mod_knn</code> to add the fitted values to the training data and add the predicted values to the test data, both using the generic function <code>predict(..., newdata = ...)</code>. The code below implements the prediction step, the measuring of the prediction skill, and the visualisation of predicted versus observed values on the test and training sets, bundled into the function <code>eval_model()</code>, which we will re-use for each fitted model object.</p>
<div class="sourceCode" id="cb355"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb355-1"><a href="supervised_ml.html#cb355-1" aria-hidden="true" tabindex="-1"></a><span class="do">## make model evaluation into a function to reuse code</span></span>
<span id="cb355-2"><a href="supervised_ml.html#cb355-2" aria-hidden="true" tabindex="-1"></a>eval_model <span class="ot">&lt;-</span> <span class="cf">function</span>(mod, df_train, df_test){</span>
<span id="cb355-3"><a href="supervised_ml.html#cb355-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb355-4"><a href="supervised_ml.html#cb355-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## add predictions to the data frames</span></span>
<span id="cb355-5"><a href="supervised_ml.html#cb355-5" aria-hidden="true" tabindex="-1"></a>  df_train <span class="ot">&lt;-</span> df_train <span class="sc">%&gt;%</span> </span>
<span id="cb355-6"><a href="supervised_ml.html#cb355-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb355-7"><a href="supervised_ml.html#cb355-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">fitted =</span>  <span class="fu">predict</span>(mod, <span class="at">newdata =</span> .))</span>
<span id="cb355-8"><a href="supervised_ml.html#cb355-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb355-9"><a href="supervised_ml.html#cb355-9" aria-hidden="true" tabindex="-1"></a>  df_test <span class="ot">&lt;-</span> df_test <span class="sc">%&gt;%</span> </span>
<span id="cb355-10"><a href="supervised_ml.html#cb355-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb355-11"><a href="supervised_ml.html#cb355-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">fitted =</span>  <span class="fu">predict</span>(mod, <span class="at">newdata =</span> .))</span>
<span id="cb355-12"><a href="supervised_ml.html#cb355-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb355-13"><a href="supervised_ml.html#cb355-13" aria-hidden="true" tabindex="-1"></a>  <span class="do">## get metrics tables</span></span>
<span id="cb355-14"><a href="supervised_ml.html#cb355-14" aria-hidden="true" tabindex="-1"></a>  metrics_train <span class="ot">&lt;-</span> df_train <span class="sc">%&gt;%</span> </span>
<span id="cb355-15"><a href="supervised_ml.html#cb355-15" aria-hidden="true" tabindex="-1"></a>    yardstick<span class="sc">::</span><span class="fu">metrics</span>(GPP_NT_VUT_REF, fitted)</span>
<span id="cb355-16"><a href="supervised_ml.html#cb355-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb355-17"><a href="supervised_ml.html#cb355-17" aria-hidden="true" tabindex="-1"></a>  metrics_test <span class="ot">&lt;-</span> df_test <span class="sc">%&gt;%</span> </span>
<span id="cb355-18"><a href="supervised_ml.html#cb355-18" aria-hidden="true" tabindex="-1"></a>    yardstick<span class="sc">::</span><span class="fu">metrics</span>(GPP_NT_VUT_REF, fitted)</span>
<span id="cb355-19"><a href="supervised_ml.html#cb355-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb355-20"><a href="supervised_ml.html#cb355-20" aria-hidden="true" tabindex="-1"></a>  <span class="do">## extract values from metrics tables</span></span>
<span id="cb355-21"><a href="supervised_ml.html#cb355-21" aria-hidden="true" tabindex="-1"></a>  rmse_train <span class="ot">&lt;-</span> metrics_train <span class="sc">%&gt;%</span> </span>
<span id="cb355-22"><a href="supervised_ml.html#cb355-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">&quot;rmse&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb355-23"><a href="supervised_ml.html#cb355-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(.estimate)</span>
<span id="cb355-24"><a href="supervised_ml.html#cb355-24" aria-hidden="true" tabindex="-1"></a>  rsq_train <span class="ot">&lt;-</span> metrics_train <span class="sc">%&gt;%</span> </span>
<span id="cb355-25"><a href="supervised_ml.html#cb355-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">&quot;rsq&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb355-26"><a href="supervised_ml.html#cb355-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(.estimate)</span>
<span id="cb355-27"><a href="supervised_ml.html#cb355-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb355-28"><a href="supervised_ml.html#cb355-28" aria-hidden="true" tabindex="-1"></a>  rmse_test <span class="ot">&lt;-</span> metrics_test <span class="sc">%&gt;%</span> </span>
<span id="cb355-29"><a href="supervised_ml.html#cb355-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">&quot;rmse&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb355-30"><a href="supervised_ml.html#cb355-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(.estimate)</span>
<span id="cb355-31"><a href="supervised_ml.html#cb355-31" aria-hidden="true" tabindex="-1"></a>  rsq_test <span class="ot">&lt;-</span> metrics_test <span class="sc">%&gt;%</span> </span>
<span id="cb355-32"><a href="supervised_ml.html#cb355-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">&quot;rsq&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb355-33"><a href="supervised_ml.html#cb355-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(.estimate)</span>
<span id="cb355-34"><a href="supervised_ml.html#cb355-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb355-35"><a href="supervised_ml.html#cb355-35" aria-hidden="true" tabindex="-1"></a>  <span class="do">## visualise with a hexagon binning and a customised color scale,</span></span>
<span id="cb355-36"><a href="supervised_ml.html#cb355-36" aria-hidden="true" tabindex="-1"></a>  <span class="do">## adding information of metrics as sub-titles</span></span>
<span id="cb355-37"><a href="supervised_ml.html#cb355-37" aria-hidden="true" tabindex="-1"></a>  gg1 <span class="ot">&lt;-</span> df_train <span class="sc">%&gt;%</span> </span>
<span id="cb355-38"><a href="supervised_ml.html#cb355-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(GPP_NT_VUT_REF, fitted)) <span class="sc">+</span></span>
<span id="cb355-39"><a href="supervised_ml.html#cb355-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb355-40"><a href="supervised_ml.html#cb355-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb355-41"><a href="supervised_ml.html#cb355-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>) <span class="sc">+</span></span>
<span id="cb355-42"><a href="supervised_ml.html#cb355-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="fu">bquote</span>( <span class="fu">italic</span>(R)<span class="sc">^</span><span class="dv">2</span> <span class="sc">==</span> .(<span class="fu">format</span>(rsq_train, <span class="at">digits =</span> <span class="dv">2</span>)) <span class="sc">~</span><span class="er">~</span></span>
<span id="cb355-43"><a href="supervised_ml.html#cb355-43" aria-hidden="true" tabindex="-1"></a>                            RMSE <span class="sc">==</span> .(<span class="fu">format</span>(rmse_train, <span class="at">digits =</span> <span class="dv">3</span>))),</span>
<span id="cb355-44"><a href="supervised_ml.html#cb355-44" aria-hidden="true" tabindex="-1"></a>         <span class="at">title =</span> <span class="st">&quot;Training set&quot;</span>) <span class="sc">+</span></span>
<span id="cb355-45"><a href="supervised_ml.html#cb355-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()</span>
<span id="cb355-46"><a href="supervised_ml.html#cb355-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb355-47"><a href="supervised_ml.html#cb355-47" aria-hidden="true" tabindex="-1"></a>  gg2 <span class="ot">&lt;-</span> df_test <span class="sc">%&gt;%</span> </span>
<span id="cb355-48"><a href="supervised_ml.html#cb355-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(GPP_NT_VUT_REF, fitted)) <span class="sc">+</span></span>
<span id="cb355-49"><a href="supervised_ml.html#cb355-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb355-50"><a href="supervised_ml.html#cb355-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">&quot;red&quot;</span>) <span class="sc">+</span></span>
<span id="cb355-51"><a href="supervised_ml.html#cb355-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>) <span class="sc">+</span></span>
<span id="cb355-52"><a href="supervised_ml.html#cb355-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="fu">bquote</span>( <span class="fu">italic</span>(R)<span class="sc">^</span><span class="dv">2</span> <span class="sc">==</span> .(<span class="fu">format</span>(rsq_test, <span class="at">digits =</span> <span class="dv">2</span>)) <span class="sc">~</span><span class="er">~</span></span>
<span id="cb355-53"><a href="supervised_ml.html#cb355-53" aria-hidden="true" tabindex="-1"></a>                            RMSE <span class="sc">==</span> .(<span class="fu">format</span>(rmse_test, <span class="at">digits =</span> <span class="dv">3</span>))),</span>
<span id="cb355-54"><a href="supervised_ml.html#cb355-54" aria-hidden="true" tabindex="-1"></a>         <span class="at">title =</span> <span class="st">&quot;Test set&quot;</span>) <span class="sc">+</span></span>
<span id="cb355-55"><a href="supervised_ml.html#cb355-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_classic</span>()</span>
<span id="cb355-56"><a href="supervised_ml.html#cb355-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb355-57"><a href="supervised_ml.html#cb355-57" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(gg1, gg2)</span>
<span id="cb355-58"><a href="supervised_ml.html#cb355-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb355-59"><a href="supervised_ml.html#cb355-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb355-60"><a href="supervised_ml.html#cb355-60" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb355-61"><a href="supervised_ml.html#cb355-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb355-62"><a href="supervised_ml.html#cb355-62" aria-hidden="true" tabindex="-1"></a><span class="co"># linear regression model</span></span>
<span id="cb355-63"><a href="supervised_ml.html#cb355-63" aria-hidden="true" tabindex="-1"></a><span class="fu">eval_model</span>(<span class="at">mod =</span> mod_lm, <span class="at">df_train =</span> ddf_train, <span class="at">df_test =</span> ddf_test)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;
## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-177-1.png" width="672" /></p>
<div class="sourceCode" id="cb357"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb357-1"><a href="supervised_ml.html#cb357-1" aria-hidden="true" tabindex="-1"></a><span class="co"># KNN</span></span>
<span id="cb357-2"><a href="supervised_ml.html#cb357-2" aria-hidden="true" tabindex="-1"></a><span class="fu">eval_model</span>(<span class="at">mod =</span> mod_knn, <span class="at">df_train =</span> ddf_train, <span class="at">df_test =</span> ddf_test)</span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = &#39;y ~ x&#39;
## `geom_smooth()` using formula = &#39;y ~ x&#39;</code></pre>
<p><img src="_main_files/figure-html/unnamed-chunk-177-2.png" width="672" /></p>
<p>It is advisable to keep workflow notebooks (this RMarkdown file) light and legible. Therefore, code chunks should not be excessively long and functions should be kept in a <code>./R/*.R</code> file, which can be loaded. This also facilitates debugging code inside the function. Here, the function <code>eval_model()</code> is part of the book’s git repository, stored in the sub-directory <code>./R/</code>, and used also in later chapters.</p>
</div>
<div id="training" class="section level3 hasAnchor" number="9.2.9">
<h3><span class="header-section-number">9.2.9</span> Model training<a href="supervised_ml.html#training" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Model training in supervised machine learning is guided by the match (or mismatch) between the predicted and observed target variable(s), that is, between <span class="math inline">\(\hat{y}\)</span> and <span class="math inline">\(y\)</span>. The <em>loss</em> function quantifies this mismatch (<span class="math inline">\(L(\hat{y}, y)\)</span>), and the algorithm takes care of progressively reducing the loss during model training. Let’s say the machine learning model contains two parameters and predictions can be considered a function of the two (<span class="math inline">\(\hat{y}(w_1, w_2)\)</span>). <span class="math inline">\(y\)</span> is actually constant. Thus, the loss function is effectively a function <span class="math inline">\(L(w_1, w_2)\)</span>. Therefore, we can consider the model training as a search of the parameter space of the machine learning model <span class="math inline">\((w_1, w_2)\)</span> to find the minimum of the loss. Common loss functions are the root mean square error (RMSE), or the mean square error (MSE), or the mean absolute error (MAE). Loss minimization is a general feature of ML model training.</p>
<div class="figure"><span style="display:block;" id="fig:unnamed-chunk-178"></span>
<img src="figures/loss_plane.png" alt="Visualization of a loss function as a plane spanned by the two parameters $w_1$ and $w_2$."  />
<p class="caption">
Figure 9.1: Visualization of a loss function as a plane spanned by the two parameters <span class="math inline">\(w_1\)</span> and <span class="math inline">\(w_2\)</span>.
</p>
</div>
<p>Model training is implemented in R for different algorithms in different packages. Some algorithms are even implemented by multiple packages (e.g., <code>nnet</code> and <code>neuralnet</code> for artificial neural networks). As described in Chapter <a href="supervised_ml.html#preprocessing">9.2.7</a>, the <strong>caret</strong> package provides “wrappers” that handle a large selection of different ML model implementations in different packages with a unified interface (see <a href="https://topepo.github.io/caret/available-models.html">here</a> for an overview of available models). The <strong>caret</strong> function <code>train()</code> is the centre piece. Its argument <code>metric</code> specifies the loss function and defaults to the RMSE for regression models and accuracy for classification (see sub-section on metrics below).</p>
<div id="hyperparameter-tuning" class="section level4 hasAnchor" number="9.2.9.1">
<h4><span class="header-section-number">9.2.9.1</span> Hyperparameter tuning<a href="supervised_ml.html#hyperparameter-tuning" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Practically all ML algorithms have some “knobs” to turn in order to achieve efficient model training and predictive performance. Such “knobs” are the <em>hyperparameters</em>. What these knobs are, depends on the ML algorithm.</p>
<p>For KNN, this is <code>k</code> - the number of neighbours to consider for determining distances. There is always an optimum <span class="math inline">\(k\)</span>. Obviously, if <span class="math inline">\(k = n\)</span>, we consider all observations as neighbours and each prediction is simply the mean of all observed target values <span class="math inline">\(Y\)</span>, irrespective of the predictor values. This cannot be optimal and such a model is likely underfit. On the other extreme, with <span class="math inline">\(k = 1\)</span>, the model will be strongly affected by the noise in the single nearest neighbour and its generalisability will suffer. This should be reflected in a poor performance on the validation data.</p>
<p>For random forests from the <strong>ranger</strong> package, hyperparameters are:</p>
<ul>
<li><code>mtry</code>: the number of variables to consider to make decisions, often taken as <span class="math inline">\(p/3\)</span>, where <span class="math inline">\(p\)</span> is the number of predictors.</li>
<li><code>min.node.size</code>: the number of data points at the “bottom” of each decision tree</li>
<li><code>splitrule</code>: the function applied to data in each branch of a tree, used for determining the goodness of a decision</li>
</ul>
<p>Hyperparameters usually have to be “tuned”. The optimal setting depends on the data and can therefore not be known <em>a priori</em>.</p>
<p>In <strong>caret</strong>, hyperparameter tuning is implemented as part of the <code>train()</code> function. Values of hyperparameters to consider are to be specified by the argument <code>tuneGrid</code>, which takes a data frame with column(s) named according to the name(s) of the hyperparameter(s) and rows for each combination of hyperparameters to consider.</p>
<div class="sourceCode" id="cb359"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb359-1"><a href="supervised_ml.html#cb359-1" aria-hidden="true" tabindex="-1"></a><span class="do">## do not run</span></span>
<span id="cb359-2"><a href="supervised_ml.html#cb359-2" aria-hidden="true" tabindex="-1"></a><span class="fu">train</span>(</span>
<span id="cb359-3"><a href="supervised_ml.html#cb359-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">form =</span> GPP_NT_VUT_REF <span class="sc">~</span> SW_F_IN <span class="sc">+</span> VPD_F <span class="sc">+</span> TA_F, </span>
<span id="cb359-4"><a href="supervised_ml.html#cb359-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ddf, </span>
<span id="cb359-5"><a href="supervised_ml.html#cb359-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">&quot;ranger&quot;</span>,</span>
<span id="cb359-6"><a href="supervised_ml.html#cb359-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>( <span class="at">.mtry =</span> <span class="fu">floor</span>(<span class="dv">6</span> <span class="sc">/</span> <span class="dv">3</span>),</span>
<span id="cb359-7"><a href="supervised_ml.html#cb359-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">.min.node.size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">9</span>,<span class="dv">15</span>, <span class="dv">30</span>),</span>
<span id="cb359-8"><a href="supervised_ml.html#cb359-8" aria-hidden="true" tabindex="-1"></a>                          <span class="at">.splitrule =</span> <span class="fu">c</span>(<span class="st">&quot;variance&quot;</span>, <span class="st">&quot;maxstat&quot;</span>)),</span>
<span id="cb359-9"><a href="supervised_ml.html#cb359-9" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb359-10"><a href="supervised_ml.html#cb359-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Here, <code>expand.grid()</code> is used to provide a data frame with all combinations of values provided by individual vectors.</p>
</div>
<div id="resampling" class="section level4 hasAnchor" number="9.2.9.2">
<h4><span class="header-section-number">9.2.9.2</span> Resampling<a href="supervised_ml.html#resampling" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The goal of model training is to achieve the best possible model generalisability. That is, the best possible model performance when predicting to data that was not used for training - the test data. Resampling mimicks the comparison of predictions to the test data. Instead of using all training data, the training data is <em>resampled</em> into a number further splits into pairs of training and <em>validation</em> data. Model training is then guided by minimising the average loss determined on each resample of the validation data. Having multiple resamples (multiple <em>folds</em> of training-validation splits) avoids the loss minimization from being misguided by random peculiarities in the training and/or validation data.</p>
<p>A common resampling method is <em>k-fold cross validation</em>, where the training data is split into <em>k</em> equally sized subsets (<em>folds</em>). Then, there will be <em>k</em> iterations, where each fold is used for validation once (while the remaining folds are used for training). An extreme case is <em>leave-one-out cross validation</em>, where <em>k</em> corresponds to the number of data points.</p>
<p><img src="figures/cv.png" /><!-- --></p>
<p>To do a k-fold cross validation during model training in R, we don’t have to implement the loops around folds ourselves. The resampling procedure can be specified in the <strong>caret</strong> function <code>train()</code> with the argument <code>trControl</code>. The object that this argument takes is the output of a function call to <code>trainControl()</code>. This can be implemented in two steps. For example, to do a 10-fold cross-validation, we can write:</p>
<div class="sourceCode" id="cb360"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb360-1"><a href="supervised_ml.html#cb360-1" aria-hidden="true" tabindex="-1"></a><span class="do">## do not run</span></span>
<span id="cb360-2"><a href="supervised_ml.html#cb360-2" aria-hidden="true" tabindex="-1"></a><span class="fu">train</span>(</span>
<span id="cb360-3"><a href="supervised_ml.html#cb360-3" aria-hidden="true" tabindex="-1"></a>  pp, </span>
<span id="cb360-4"><a href="supervised_ml.html#cb360-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> ddf_train, </span>
<span id="cb360-5"><a href="supervised_ml.html#cb360-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">&quot;ranger&quot;</span>,</span>
<span id="cb360-6"><a href="supervised_ml.html#cb360-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuneGrid =</span> <span class="fu">expand.grid</span>( <span class="at">.mtry =</span> <span class="fu">floor</span>(<span class="dv">6</span> <span class="sc">/</span> <span class="dv">3</span>),</span>
<span id="cb360-7"><a href="supervised_ml.html#cb360-7" aria-hidden="true" tabindex="-1"></a>                          <span class="at">.min.node.size =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">9</span>,<span class="dv">15</span>, <span class="dv">30</span>),</span>
<span id="cb360-8"><a href="supervised_ml.html#cb360-8" aria-hidden="true" tabindex="-1"></a>                          <span class="at">.splitrule =</span> <span class="fu">c</span>(<span class="st">&quot;variance&quot;</span>, <span class="st">&quot;maxstat&quot;</span>)),</span>
<span id="cb360-9"><a href="supervised_ml.html#cb360-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">trControl =</span> <span class="fu">trainControl</span>(<span class="at">method =</span> <span class="st">&quot;cv&quot;</span>, <span class="at">number =</span> <span class="dv">10</span>),</span>
<span id="cb360-10"><a href="supervised_ml.html#cb360-10" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb360-11"><a href="supervised_ml.html#cb360-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>In certain cases, data points stem from different “groups”, and generalisability across groups is critical. In such cases, data from a given group must not be used both in the training and validation sets. Instead, splits should be made along group delineations. The <em>caret</em> function <code>groupKFold()</code> offers the solution for this case.</p>
</div>
</div>
</div>
<div id="exercises-8" class="section level2 hasAnchor" number="9.3">
<h2><span class="header-section-number">9.3</span> Exercises<a href="supervised_ml.html#exercises-8" class="anchor-section" aria-label="Anchor link to header"></a></h2>
</div>
<div id="solutions-7" class="section level2 hasAnchor" number="9.4">
<h2><span class="header-section-number">9.4</span> Solutions<a href="supervised_ml.html#solutions-7" class="anchor-section" aria-label="Anchor link to header"></a></h2>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="regression_classification.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="random_forest.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/09-supervised_ml_A.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
