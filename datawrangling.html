<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Data wrangling | Applied Geodata Science</title>
  <meta name="description" content="This course prepares you to benefit from the general data richness in environmental and geo-sciences." />
  <meta name="generator" content="bookdown 0.31 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Data wrangling | Applied Geodata Science" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This course prepares you to benefit from the general data richness in environmental and geo-sciences." />
  <meta name="github-repo" content="stineb/agsd" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Data wrangling | Applied Geodata Science" />
  
  <meta name="twitter:description" content="This course prepares you to benefit from the general data richness in environmental and geo-sciences." />
  

<meta name="author" content="Benjamin Stocker, Koen Hufkens, Pepa Arán, and Pascal Schneider" />


<meta name="date" content="2023-03-13" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="figures/apple-touch-icon.png" />
  <link rel="shortcut icon" href="figures/favicon.ico" type="image/x-icon" />
<link rel="prev" href="programmingprimers.html"/>
<link rel="next" href="datavis.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Applied Geodata Science</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Overview</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-this-book"><i class="fa fa-check"></i>About this book</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#about-this-course"><i class="fa fa-check"></i>About this course</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#course-goal"><i class="fa fa-check"></i>Course goal</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#learning-objectives"><i class="fa fa-check"></i>Learning Objectives</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#course-contents"><i class="fa fa-check"></i>Course contents</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i>Introduction</a>
<ul>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#what-is-applied-geodata-science"><i class="fa fa-check"></i>What is Applied Geodata Science?</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#the-data-science-workflow"><i class="fa fa-check"></i>The data science workflow</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#why-now"><i class="fa fa-check"></i>Why now?</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#a-new-modelling-paradigm"><i class="fa fa-check"></i>A new modelling paradigm</a></li>
<li class="chapter" data-level="" data-path="introduction.html"><a href="introduction.html#reading-and-link-collection"><i class="fa fa-check"></i>Reading and link collection</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="gettingstarted.html"><a href="gettingstarted.html"><i class="fa fa-check"></i><b>1</b> Getting started</a>
<ul>
<li class="chapter" data-level="1.1" data-path="gettingstarted.html"><a href="gettingstarted.html#learning-objectives-1"><i class="fa fa-check"></i><b>1.1</b> Learning objectives</a></li>
<li class="chapter" data-level="1.2" data-path="gettingstarted.html"><a href="gettingstarted.html#tutorial"><i class="fa fa-check"></i><b>1.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="gettingstarted.html"><a href="gettingstarted.html#working-with-r-and-rstudio"><i class="fa fa-check"></i><b>1.2.1</b> Working with R and RStudio</a></li>
<li class="chapter" data-level="1.2.2" data-path="gettingstarted.html"><a href="gettingstarted.html#r-objects"><i class="fa fa-check"></i><b>1.2.2</b> R objects</a></li>
<li class="chapter" data-level="1.2.3" data-path="gettingstarted.html"><a href="gettingstarted.html#r-environment"><i class="fa fa-check"></i><b>1.2.3</b> R environment</a></li>
<li class="chapter" data-level="1.2.4" data-path="gettingstarted.html"><a href="gettingstarted.html#libraries"><i class="fa fa-check"></i><b>1.2.4</b> Libraries</a></li>
<li class="chapter" data-level="1.2.5" data-path="gettingstarted.html"><a href="gettingstarted.html#r-scripts"><i class="fa fa-check"></i><b>1.2.5</b> R scripts</a></li>
<li class="chapter" data-level="1.2.6" data-path="gettingstarted.html"><a href="gettingstarted.html#rmarkdown"><i class="fa fa-check"></i><b>1.2.6</b> R Markdown</a></li>
<li class="chapter" data-level="1.2.7" data-path="gettingstarted.html"><a href="gettingstarted.html#wspmgmt"><i class="fa fa-check"></i><b>1.2.7</b> Workspace management</a></li>
<li class="chapter" data-level="1.2.8" data-path="gettingstarted.html"><a href="gettingstarted.html#setup"><i class="fa fa-check"></i><b>1.2.8</b> Setup</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="gettingstarted.html"><a href="gettingstarted.html#exercises"><i class="fa fa-check"></i><b>1.3</b> Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="gettingstarted.html"><a href="gettingstarted.html#dimensions-of-a-circle"><i class="fa fa-check"></i>Dimensions of a circle</a></li>
<li class="chapter" data-level="" data-path="gettingstarted.html"><a href="gettingstarted.html#sequence-of-numbers"><i class="fa fa-check"></i>Sequence of numbers</a></li>
<li class="chapter" data-level="" data-path="gettingstarted.html"><a href="gettingstarted.html#gauss-sum"><i class="fa fa-check"></i>Gauss sum</a></li>
<li class="chapter" data-level="" data-path="gettingstarted.html"><a href="gettingstarted.html#magic-trick-algorithm"><i class="fa fa-check"></i>Magic trick algorithm</a></li>
<li class="chapter" data-level="" data-path="gettingstarted.html"><a href="gettingstarted.html#vectors-1"><i class="fa fa-check"></i>Vectors</a></li>
<li class="chapter" data-level="" data-path="gettingstarted.html"><a href="gettingstarted.html#data-frames-1"><i class="fa fa-check"></i>Data frames</a></li>
<li class="chapter" data-level="" data-path="gettingstarted.html"><a href="gettingstarted.html#workspace"><i class="fa fa-check"></i>Workspace</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="programmingprimers.html"><a href="programmingprimers.html"><i class="fa fa-check"></i><b>2</b> Programming primers</a>
<ul>
<li class="chapter" data-level="2.1" data-path="programmingprimers.html"><a href="programmingprimers.html#learning-objectives-2"><i class="fa fa-check"></i><b>2.1</b> Learning objectives</a></li>
<li class="chapter" data-level="2.2" data-path="programmingprimers.html"><a href="programmingprimers.html#tutorial-1"><i class="fa fa-check"></i><b>2.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="programmingprimers.html"><a href="programmingprimers.html#programming-basics"><i class="fa fa-check"></i><b>2.2.1</b> Programming basics</a></li>
<li class="chapter" data-level="2.2.2" data-path="programmingprimers.html"><a href="programmingprimers.html#style-your-code"><i class="fa fa-check"></i><b>2.2.2</b> Style your code</a></li>
<li class="chapter" data-level="2.2.3" data-path="programmingprimers.html"><a href="programmingprimers.html#findinghelp"><i class="fa fa-check"></i><b>2.2.3</b> Where to find help</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="programmingprimers.html"><a href="programmingprimers.html#exercises-1"><i class="fa fa-check"></i><b>2.3</b> Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="programmingprimers.html"><a href="programmingprimers.html#gauss-variations"><i class="fa fa-check"></i>Gauss variations</a></li>
<li class="chapter" data-level="" data-path="programmingprimers.html"><a href="programmingprimers.html#nested-loops"><i class="fa fa-check"></i>Nested loops</a></li>
<li class="chapter" data-level="" data-path="programmingprimers.html"><a href="programmingprimers.html#interpolation"><i class="fa fa-check"></i>Interpolation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="datawrangling.html"><a href="datawrangling.html"><i class="fa fa-check"></i><b>3</b> Data wrangling</a>
<ul>
<li class="chapter" data-level="3.1" data-path="datawrangling.html"><a href="datawrangling.html#learning-objectives-3"><i class="fa fa-check"></i><b>3.1</b> Learning objectives</a></li>
<li class="chapter" data-level="3.2" data-path="datawrangling.html"><a href="datawrangling.html#tutorial-2"><i class="fa fa-check"></i><b>3.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="datawrangling.html"><a href="datawrangling.html#example-data"><i class="fa fa-check"></i><b>3.2.1</b> Example data</a></li>
<li class="chapter" data-level="3.2.2" data-path="datawrangling.html"><a href="datawrangling.html#tidyverse"><i class="fa fa-check"></i><b>3.2.2</b> Tidyverse</a></li>
<li class="chapter" data-level="3.2.3" data-path="datawrangling.html"><a href="datawrangling.html#reading-tabular-data"><i class="fa fa-check"></i><b>3.2.3</b> Reading tabular data</a></li>
<li class="chapter" data-level="3.2.4" data-path="datawrangling.html"><a href="datawrangling.html#variable-selection"><i class="fa fa-check"></i><b>3.2.4</b> Variable selection</a></li>
<li class="chapter" data-level="3.2.5" data-path="datawrangling.html"><a href="datawrangling.html#time-objects"><i class="fa fa-check"></i><b>3.2.5</b> Time objects</a></li>
<li class="chapter" data-level="3.2.6" data-path="datawrangling.html"><a href="datawrangling.html#variable-re--definition"><i class="fa fa-check"></i><b>3.2.6</b> Variable (re-) definition</a></li>
<li class="chapter" data-level="3.2.7" data-path="datawrangling.html"><a href="datawrangling.html#axes-of-variation"><i class="fa fa-check"></i><b>3.2.7</b> Axes of variation</a></li>
<li class="chapter" data-level="3.2.8" data-path="datawrangling.html"><a href="datawrangling.html#tidydata"><i class="fa fa-check"></i><b>3.2.8</b> Tidy data</a></li>
<li class="chapter" data-level="3.2.9" data-path="datawrangling.html"><a href="datawrangling.html#aggregating-data"><i class="fa fa-check"></i><b>3.2.9</b> Aggregating data</a></li>
<li class="chapter" data-level="3.2.10" data-path="datawrangling.html"><a href="datawrangling.html#data-cleaning"><i class="fa fa-check"></i><b>3.2.10</b> Data cleaning</a></li>
<li class="chapter" data-level="3.2.11" data-path="datawrangling.html"><a href="datawrangling.html#writing-data-to-csv"><i class="fa fa-check"></i><b>3.2.11</b> Writing data to CSV</a></li>
<li class="chapter" data-level="3.2.12" data-path="datawrangling.html"><a href="datawrangling.html#combining-relational-data"><i class="fa fa-check"></i><b>3.2.12</b> Combining relational data</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="datawrangling.html"><a href="datawrangling.html#extramaterialwrangling"><i class="fa fa-check"></i><b>3.3</b> Extra material</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="datawrangling.html"><a href="datawrangling.html#functional-programming-i"><i class="fa fa-check"></i><b>3.3.1</b> Functional programming I</a></li>
<li class="chapter" data-level="3.3.2" data-path="datawrangling.html"><a href="datawrangling.html#strings"><i class="fa fa-check"></i><b>3.3.2</b> Strings</a></li>
<li class="chapter" data-level="3.3.3" data-path="datawrangling.html"><a href="datawrangling.html#functional-programming-ii"><i class="fa fa-check"></i><b>3.3.3</b> Functional programming II</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="datawrangling.html"><a href="datawrangling.html#exerciseswrangling"><i class="fa fa-check"></i><b>3.4</b> Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#star-wars"><i class="fa fa-check"></i>Star wars</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#aggregating"><i class="fa fa-check"></i>Aggregating</a></li>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#patterns-in-data-quality"><i class="fa fa-check"></i>Patterns in data quality</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="datawrangling.html"><a href="datawrangling.html#report-exercise"><i class="fa fa-check"></i><b>3.5</b> Report Exercise</a>
<ul>
<li class="chapter" data-level="" data-path="datawrangling.html"><a href="datawrangling.html#cleaning-data-from-elevated-co_2-experiments"><i class="fa fa-check"></i>Cleaning data from elevated CO<span class="math inline">\(_2\)</span> experiments</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="datavis.html"><a href="datavis.html"><i class="fa fa-check"></i><b>4</b> Data visualisation</a>
<ul>
<li class="chapter" data-level="4.1" data-path="datavis.html"><a href="datavis.html#learning-objectives-4"><i class="fa fa-check"></i><b>4.1</b> Learning objectives</a></li>
<li class="chapter" data-level="4.2" data-path="datavis.html"><a href="datavis.html#tutorial-3"><i class="fa fa-check"></i><b>4.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="datavis.html"><a href="datavis.html#the-grammar-of-graphics"><i class="fa fa-check"></i><b>4.2.1</b> The grammar of graphics</a></li>
<li class="chapter" data-level="4.2.2" data-path="datavis.html"><a href="datavis.html#every-data-has-its-representation"><i class="fa fa-check"></i><b>4.2.2</b> Every data has its representation</a></li>
<li class="chapter" data-level="4.2.3" data-path="datavis.html"><a href="datavis.html#writing-to-file"><i class="fa fa-check"></i><b>4.2.3</b> Writing to file</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="datavis.html"><a href="datavis.html#exercises-2"><i class="fa fa-check"></i><b>4.3</b> Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="datavis.html"><a href="datavis.html#spurious-data"><i class="fa fa-check"></i>Spurious data</a></li>
<li class="chapter" data-level="" data-path="datavis.html"><a href="datavis.html#identifying-outliers"><i class="fa fa-check"></i>Identifying Outliers</a></li>
<li class="chapter" data-level="" data-path="datavis.html"><a href="datavis.html#visualising-diurnal-and-seasonal-cycles-of-gpp"><i class="fa fa-check"></i>Visualising diurnal and seasonal cycles of GPP</a></li>
<li class="chapter" data-level="" data-path="datavis.html"><a href="datavis.html#trend-in-carbon-dioxide-concentrations"><i class="fa fa-check"></i>Trend in carbon dioxide concentrations</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="datavis.html"><a href="datavis.html#report-exercises"><i class="fa fa-check"></i><b>4.4</b> Report Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="datavis.html"><a href="datavis.html#telling-a-story-from-data"><i class="fa fa-check"></i>Telling a story from data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="datavariety.html"><a href="datavariety.html"><i class="fa fa-check"></i><b>5</b> Data variety</a>
<ul>
<li class="chapter" data-level="5.1" data-path="datavariety.html"><a href="datavariety.html#learning-objectives-5"><i class="fa fa-check"></i><b>5.1</b> Learning objectives</a></li>
<li class="chapter" data-level="5.2" data-path="datavariety.html"><a href="datavariety.html#tutorial-4"><i class="fa fa-check"></i><b>5.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="datavariety.html"><a href="datavariety.html#files-and-file-formats"><i class="fa fa-check"></i><b>5.2.1</b> Files and file formats</a></li>
<li class="chapter" data-level="5.2.2" data-path="datavariety.html"><a href="datavariety.html#meta-data"><i class="fa fa-check"></i><b>5.2.2</b> Meta-data</a></li>
<li class="chapter" data-level="5.2.3" data-path="datavariety.html"><a href="datavariety.html#spatial-data-representation"><i class="fa fa-check"></i><b>5.2.3</b> Spatial data representation</a></li>
<li class="chapter" data-level="5.2.4" data-path="datavariety.html"><a href="datavariety.html#online-data-sources"><i class="fa fa-check"></i><b>5.2.4</b> Online data sources</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="datavariety.html"><a href="datavariety.html#exercises-3"><i class="fa fa-check"></i><b>5.3</b> Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="datavariety.html"><a href="datavariety.html#files-and-file-formats-1"><i class="fa fa-check"></i>Files and file formats</a></li>
<li class="chapter" data-level="" data-path="datavariety.html"><a href="datavariety.html#api-use"><i class="fa fa-check"></i>API use</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="openscience.html"><a href="openscience.html"><i class="fa fa-check"></i><b>6</b> Open science practices</a>
<ul>
<li class="chapter" data-level="6.1" data-path="openscience.html"><a href="openscience.html#learning-objectives-6"><i class="fa fa-check"></i><b>6.1</b> Learning objectives</a></li>
<li class="chapter" data-level="6.2" data-path="openscience.html"><a href="openscience.html#tutorial-5"><i class="fa fa-check"></i><b>6.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="openscience.html"><a href="openscience.html#project-structure"><i class="fa fa-check"></i><b>6.2.1</b> Project structure</a></li>
<li class="chapter" data-level="6.2.2" data-path="openscience.html"><a href="openscience.html#managing-workflows"><i class="fa fa-check"></i><b>6.2.2</b> Managing workflows</a></li>
<li class="chapter" data-level="6.2.3" data-path="openscience.html"><a href="openscience.html#capturing-your-session-state"><i class="fa fa-check"></i><b>6.2.3</b> Capturing your session state</a></li>
<li class="chapter" data-level="6.2.4" data-path="openscience.html"><a href="openscience.html#capturing-a-system-state"><i class="fa fa-check"></i><b>6.2.4</b> Capturing a system state</a></li>
<li class="chapter" data-level="6.2.5" data-path="openscience.html"><a href="openscience.html#readable-reporting-using-rmarkdown"><i class="fa fa-check"></i><b>6.2.5</b> Readable reporting using Rmarkdown</a></li>
<li class="chapter" data-level="6.2.6" data-path="openscience.html"><a href="openscience.html#project-structure-1"><i class="fa fa-check"></i><b>6.2.6</b> Project structure</a></li>
<li class="chapter" data-level="6.2.7" data-path="openscience.html"><a href="openscience.html#data-retention"><i class="fa fa-check"></i><b>6.2.7</b> Data retention</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="openscience.html"><a href="openscience.html#exercises-4"><i class="fa fa-check"></i><b>6.3</b> Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="openscience.html"><a href="openscience.html#external-data"><i class="fa fa-check"></i>External data</a></li>
<li class="chapter" data-level="" data-path="openscience.html"><a href="openscience.html#a-new-project"><i class="fa fa-check"></i>A new project</a></li>
<li class="chapter" data-level="" data-path="openscience.html"><a href="openscience.html#tracking-the-state-of-your-project"><i class="fa fa-check"></i>Tracking the state of your project</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="codemgmt.html"><a href="codemgmt.html"><i class="fa fa-check"></i><b>7</b> Code management</a>
<ul>
<li class="chapter" data-level="7.1" data-path="codemgmt.html"><a href="codemgmt.html#learning-objectives-7"><i class="fa fa-check"></i><b>7.1</b> Learning objectives</a></li>
<li class="chapter" data-level="7.2" data-path="codemgmt.html"><a href="codemgmt.html#tutorial-6"><i class="fa fa-check"></i><b>7.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="codemgmt.html"><a href="codemgmt.html#gitworkflow"><i class="fa fa-check"></i><b>7.2.1</b> Git and local version control</a></li>
<li class="chapter" data-level="7.2.2" data-path="codemgmt.html"><a href="codemgmt.html#remote-version-control"><i class="fa fa-check"></i><b>7.2.2</b> Remote version control</a></li>
<li class="chapter" data-level="7.2.3" data-path="codemgmt.html"><a href="codemgmt.html#location-based-code-management---github-templates"><i class="fa fa-check"></i><b>7.2.3</b> Location based code management - github templates</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="codemgmt.html"><a href="codemgmt.html#exercises-5"><i class="fa fa-check"></i><b>7.3</b> Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="codemgmt.html"><a href="codemgmt.html#location-based-code-management"><i class="fa fa-check"></i>Location based code management</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="codemgmt.html"><a href="codemgmt.html#report-exercises-1"><i class="fa fa-check"></i><b>7.4</b> Report Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="codemgmt.html"><a href="codemgmt.html#collaborative-work-on-github"><i class="fa fa-check"></i>Collaborative Work on Github</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="regressionclassification.html"><a href="regressionclassification.html"><i class="fa fa-check"></i><b>8</b> Regression and classification</a>
<ul>
<li class="chapter" data-level="8.1" data-path="regressionclassification.html"><a href="regressionclassification.html#learning-objectives-8"><i class="fa fa-check"></i><b>8.1</b> Learning objectives</a></li>
<li class="chapter" data-level="8.2" data-path="regressionclassification.html"><a href="regressionclassification.html#tutorial-7"><i class="fa fa-check"></i><b>8.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="regressionclassification.html"><a href="regressionclassification.html#types-of-models"><i class="fa fa-check"></i><b>8.2.1</b> Types of models</a></li>
<li class="chapter" data-level="8.2.2" data-path="regressionclassification.html"><a href="regressionclassification.html#regression"><i class="fa fa-check"></i><b>8.2.2</b> Regression</a></li>
<li class="chapter" data-level="8.2.3" data-path="regressionclassification.html"><a href="regressionclassification.html#model-selection"><i class="fa fa-check"></i><b>8.2.3</b> Model selection</a></li>
<li class="chapter" data-level="8.2.4" data-path="regressionclassification.html"><a href="regressionclassification.html#outlier-detection"><i class="fa fa-check"></i><b>8.2.4</b> Outlier detection</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="regressionclassification.html"><a href="regressionclassification.html#extra-material"><i class="fa fa-check"></i><b>8.3</b> Extra material</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="regressionclassification.html"><a href="regressionclassification.html#classification"><i class="fa fa-check"></i><b>8.3.1</b> Classification</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="regressionclassification.html"><a href="regressionclassification.html#exercises-6"><i class="fa fa-check"></i><b>8.4</b> Exercises</a></li>
<li class="chapter" data-level="8.5" data-path="regressionclassification.html"><a href="regressionclassification.html#report-exercise-1"><i class="fa fa-check"></i><b>8.5</b> Report Exercise</a>
<ul>
<li class="chapter" data-level="" data-path="regressionclassification.html"><a href="regressionclassification.html#deliverables-for-the-report-1"><i class="fa fa-check"></i>Deliverables for the report</a></li>
<li class="chapter" data-level="" data-path="regressionclassification.html"><a href="regressionclassification.html#guide-for-your-implementation"><i class="fa fa-check"></i>Guide for your implementation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="supervisedmli.html"><a href="supervisedmli.html"><i class="fa fa-check"></i><b>9</b> Supervised machine learning I</a>
<ul>
<li class="chapter" data-level="9.1" data-path="supervisedmli.html"><a href="supervisedmli.html#learning-objectives-9"><i class="fa fa-check"></i><b>9.1</b> Learning objectives</a></li>
<li class="chapter" data-level="9.2" data-path="supervisedmli.html"><a href="supervisedmli.html#tutorial-8"><i class="fa fa-check"></i><b>9.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="supervisedmli.html"><a href="supervisedmli.html#what-is-supervised-machine-learning"><i class="fa fa-check"></i><b>9.2.1</b> What is supervised machine learning?</a></li>
<li class="chapter" data-level="9.2.2" data-path="supervisedmli.html"><a href="supervisedmli.html#overfitting"><i class="fa fa-check"></i><b>9.2.2</b> Overfitting</a></li>
<li class="chapter" data-level="9.2.3" data-path="supervisedmli.html"><a href="supervisedmli.html#data-and-the-modelling-challenge"><i class="fa fa-check"></i><b>9.2.3</b> Data and the modelling challenge</a></li>
<li class="chapter" data-level="9.2.4" data-path="supervisedmli.html"><a href="supervisedmli.html#k-nearest-neighbours"><i class="fa fa-check"></i><b>9.2.4</b> K-nearest neighbours</a></li>
<li class="chapter" data-level="9.2.5" data-path="supervisedmli.html"><a href="supervisedmli.html#model-formulation"><i class="fa fa-check"></i><b>9.2.5</b> Model formulation</a></li>
<li class="chapter" data-level="9.2.6" data-path="supervisedmli.html"><a href="supervisedmli.html#data-splitting"><i class="fa fa-check"></i><b>9.2.6</b> Data splitting</a></li>
<li class="chapter" data-level="9.2.7" data-path="supervisedmli.html"><a href="supervisedmli.html#preprocessing"><i class="fa fa-check"></i><b>9.2.7</b> Pre-processing</a></li>
<li class="chapter" data-level="9.2.8" data-path="supervisedmli.html"><a href="supervisedmli.html#putting-it-all-together-half-way"><i class="fa fa-check"></i><b>9.2.8</b> Putting it all together (half-way)</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="supervisedmli.html"><a href="supervisedmli.html#exercises-7"><i class="fa fa-check"></i><b>9.3</b> Exercises</a></li>
<li class="chapter" data-level="9.4" data-path="supervisedmli.html"><a href="supervisedmli.html#report-exercises-2"><i class="fa fa-check"></i><b>9.4</b> Report Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="supervisedmli.html"><a href="supervisedmli.html#comparison-of-the-linear-regression-and-knn-models"><i class="fa fa-check"></i>Comparison of the linear regression and KNN models</a></li>
<li class="chapter" data-level="" data-path="supervisedmli.html"><a href="supervisedmli.html#the-role-of-k"><i class="fa fa-check"></i>The role of k</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="supervisedmlii.html"><a href="supervisedmlii.html"><i class="fa fa-check"></i><b>10</b> Supervised machine learning II</a>
<ul>
<li class="chapter" data-level="10.1" data-path="supervisedmlii.html"><a href="supervisedmlii.html#learning-objectives-10"><i class="fa fa-check"></i><b>10.1</b> Learning objectives</a></li>
<li class="chapter" data-level="10.2" data-path="supervisedmlii.html"><a href="supervisedmlii.html#tutorial-9"><i class="fa fa-check"></i><b>10.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="supervisedmlii.html"><a href="supervisedmlii.html#data-and-the-modelling-challenge-1"><i class="fa fa-check"></i><b>10.2.1</b> Data and the modelling challenge</a></li>
<li class="chapter" data-level="10.2.2" data-path="supervisedmlii.html"><a href="supervisedmlii.html#training"><i class="fa fa-check"></i><b>10.2.2</b> Loss function</a></li>
<li class="chapter" data-level="10.2.3" data-path="supervisedmlii.html"><a href="supervisedmlii.html#hyperparameters"><i class="fa fa-check"></i><b>10.2.3</b> Hyperparameters</a></li>
<li class="chapter" data-level="10.2.4" data-path="supervisedmlii.html"><a href="supervisedmlii.html#resampling"><i class="fa fa-check"></i><b>10.2.4</b> Resampling</a></li>
<li class="chapter" data-level="10.2.5" data-path="supervisedmlii.html"><a href="supervisedmlii.html#validation-versus-testing-data"><i class="fa fa-check"></i><b>10.2.5</b> Validation versus testing data</a></li>
<li class="chapter" data-level="10.2.6" data-path="supervisedmlii.html"><a href="supervisedmlii.html#modeling-with-structured-data"><i class="fa fa-check"></i><b>10.2.6</b> Modeling with structured data</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="supervisedmlii.html"><a href="supervisedmlii.html#exercises-8"><i class="fa fa-check"></i><b>10.3</b> Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="supervisedmlii.html"><a href="supervisedmlii.html#cross-validation-by-hand"><i class="fa fa-check"></i>Cross-validation by hand</a></li>
<li class="chapter" data-level="10.3.1" data-path="supervisedmlii.html"><a href="supervisedmlii.html#cross-validation-vs.-test-error"><i class="fa fa-check"></i><b>10.3.1</b> Cross-validation vs. test error</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="supervisedmlii.html"><a href="supervisedmlii.html#report-exercises-3"><i class="fa fa-check"></i><b>10.4</b> Report Exercises</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="randomforest.html"><a href="randomforest.html"><i class="fa fa-check"></i><b>11</b> Random Forest</a>
<ul>
<li class="chapter" data-level="11.1" data-path="randomforest.html"><a href="randomforest.html#learning-objectives-11"><i class="fa fa-check"></i><b>11.1</b> Learning objectives</a></li>
<li class="chapter" data-level="11.2" data-path="randomforest.html"><a href="randomforest.html#tutorial-10"><i class="fa fa-check"></i><b>11.2</b> Tutorial</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="randomforest.html"><a href="randomforest.html#decision-trees"><i class="fa fa-check"></i><b>11.2.1</b> Decision trees</a></li>
<li class="chapter" data-level="11.2.2" data-path="randomforest.html"><a href="randomforest.html#bagging"><i class="fa fa-check"></i><b>11.2.2</b> Bagging</a></li>
<li class="chapter" data-level="11.2.3" data-path="randomforest.html"><a href="randomforest.html#from-trees-to-a-forest"><i class="fa fa-check"></i><b>11.2.3</b> From trees to a forest</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="randomforest.html"><a href="randomforest.html#exercises-9"><i class="fa fa-check"></i><b>11.3</b> Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="randomforest.html"><a href="randomforest.html#fitting-a-random-forest"><i class="fa fa-check"></i>Fitting a Random Forest</a></li>
<li class="chapter" data-level="" data-path="randomforest.html"><a href="randomforest.html#hyperparameter-tuning"><i class="fa fa-check"></i>Hyperparameter tuning</a></li>
<li class="chapter" data-level="" data-path="randomforest.html"><a href="randomforest.html#model-performance"><i class="fa fa-check"></i>Model performance</a></li>
</ul></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="solutions.html"><a href="solutions.html"><i class="fa fa-check"></i><b>A</b> Solutions</a>
<ul>
<li class="chapter" data-level="A.1" data-path="solutions.html"><a href="solutions.html#getting-started"><i class="fa fa-check"></i><b>A.1</b> Getting Started</a>
<ul>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#dimensions-of-a-circle-1"><i class="fa fa-check"></i>Dimensions of a circle</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#sequence-of-numbers-1"><i class="fa fa-check"></i>Sequence of numbers</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#gauss-sum-1"><i class="fa fa-check"></i>Gauss sum</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#magic-trick-algorithm-1"><i class="fa fa-check"></i>Magic trick algorithm</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#vectors-2"><i class="fa fa-check"></i>Vectors</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#data-frames-2"><i class="fa fa-check"></i>Data frames</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#workspace-1"><i class="fa fa-check"></i>Workspace</a></li>
</ul></li>
<li class="chapter" data-level="A.2" data-path="solutions.html"><a href="solutions.html#programming-primers"><i class="fa fa-check"></i><b>A.2</b> Programming primers</a>
<ul>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#gauss-variations-1"><i class="fa fa-check"></i>Gauss variations</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#nested-loops-1"><i class="fa fa-check"></i>Nested loops</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#interpolation-1"><i class="fa fa-check"></i>Interpolation</a></li>
</ul></li>
<li class="chapter" data-level="A.3" data-path="solutions.html"><a href="solutions.html#data-wrangling"><i class="fa fa-check"></i><b>A.3</b> Data wrangling</a>
<ul>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#star-wars-1"><i class="fa fa-check"></i>Star wars</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#aggregating-1"><i class="fa fa-check"></i>Aggregating</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#patterns-in-data-quality-1"><i class="fa fa-check"></i>Patterns in data quality</a></li>
</ul></li>
<li class="chapter" data-level="A.4" data-path="solutions.html"><a href="solutions.html#data-visualisation"><i class="fa fa-check"></i><b>A.4</b> Data Visualisation</a>
<ul>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#spurious-data-1"><i class="fa fa-check"></i>Spurious data</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#identifying-outliers-1"><i class="fa fa-check"></i>Identifying Outliers</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#visualising-diurnal-and-seasonal-cycles-of-gpp-1"><i class="fa fa-check"></i>Visualising diurnal and seasonal cycles of GPP</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#trend-in-carbon-dioxide-concentrations-1"><i class="fa fa-check"></i>Trend in carbon dioxide concentrations</a></li>
</ul></li>
<li class="chapter" data-level="A.5" data-path="solutions.html"><a href="solutions.html#data-variety"><i class="fa fa-check"></i><b>A.5</b> Data Variety</a>
<ul>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#files-and-file-formats-2"><i class="fa fa-check"></i>Files and file formats</a></li>
<li class="chapter" data-level="A.5.1" data-path="solutions.html"><a href="solutions.html#api-use-1"><i class="fa fa-check"></i><b>A.5.1</b> API Use</a></li>
</ul></li>
<li class="chapter" data-level="A.6" data-path="solutions.html"><a href="solutions.html#open-science"><i class="fa fa-check"></i><b>A.6</b> Open Science</a>
<ul>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#external-data-1"><i class="fa fa-check"></i>External data</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#a-new-project-1"><i class="fa fa-check"></i>A new project</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#tracking-the-state-of-your-project-1"><i class="fa fa-check"></i>Tracking the state of your project</a></li>
</ul></li>
<li class="chapter" data-level="A.7" data-path="solutions.html"><a href="solutions.html#code-management"><i class="fa fa-check"></i><b>A.7</b> Code Management</a>
<ul>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#location-based-code-management-1"><i class="fa fa-check"></i>Location based code management</a></li>
</ul></li>
<li class="chapter" data-level="A.8" data-path="solutions.html"><a href="solutions.html#regression-and-classification"><i class="fa fa-check"></i><b>A.8</b> Regression and Classification</a></li>
<li class="chapter" data-level="A.9" data-path="solutions.html"><a href="solutions.html#supervised-ml-i"><i class="fa fa-check"></i><b>A.9</b> Supervised ML I</a></li>
<li class="chapter" data-level="A.10" data-path="solutions.html"><a href="solutions.html#supervised-ml-ii"><i class="fa fa-check"></i><b>A.10</b> Supervised ML II</a>
<ul>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#cross-validation-by-hand-1"><i class="fa fa-check"></i>Cross-validation by hand</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#cross-validation-vs.-test-error-1"><i class="fa fa-check"></i>Cross-validation vs. test error</a></li>
</ul></li>
<li class="chapter" data-level="A.11" data-path="solutions.html"><a href="solutions.html#random-forest"><i class="fa fa-check"></i><b>A.11</b> Random Forest</a>
<ul>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#fitting-a-random-forest-1"><i class="fa fa-check"></i>Fitting a Random Forest</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#hyperparameter-tuning-1"><i class="fa fa-check"></i>Hyperparameter tuning</a></li>
<li class="chapter" data-level="" data-path="solutions.html"><a href="solutions.html#model-performance-1"><i class="fa fa-check"></i>Model performance</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="B" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>B</b> References</a>
<ul>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html#system-information-and-package-list"><i class="fa fa-check"></i>System information and package list</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Applied Geodata Science</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="datawrangling" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">Chapter 3</span> Data wrangling<a href="datawrangling.html#datawrangling" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p><strong>Chapter lead author: Benjamin Stocker</strong></p>
<div id="learning-objectives-3" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Learning objectives<a href="datawrangling.html#learning-objectives-3" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In this chapter you will learn how to manipluate and transform data, a curcial part of the data science workflow.</p>
<p>You will learn how to:</p>
<ul>
<li>read and transform tabulated data</li>
<li>understand the ‘tidy’ data concept</li>
<li>select variables</li>
<li>Aggregate data</li>
<li>handle bad and/or missing data</li>
</ul>
</div>
<div id="tutorial-2" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Tutorial<a href="datawrangling.html#tutorial-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Exploratory data analysis - the transformation, visualization, and modelling of data - is the central part of any (geo-) data science workflow and typically takes up a majority of the time we spend on a research project. The transformation of data often turns out to be particularly (and often surprisingly) time-demanding. Therefore, it is key to master typical steps of data transformation, and to implement them in a transparent fashion and efficiently - both in terms of robustness against coding errors (“bugs”) and in terms of code execution speed.</p>
<p>We refer to data <em>wrangling</em> here to encompass the steps for preparing the data set <em>prior</em> to modelling - including, the combination of variables from different data sources, the removal of bad data, and the aggregation of data to the desired resolution or granularity (e.g., averaging over all time steps in a day, or over all replicates in a sample).</p>
<p>In contrast, <em>pre-processing</em> refers to the additional steps that are either required by the the specific machine learning algorithm used with the data (e.g., centering and scaling for K-Nearest Neighbors or Neural Networks), the gap-filling of variables, or the transformation of variables guided by the resulting improvement of the predictive power of the machine learning model. Pre-processing is part of the modelling workflow and includes all steps that apply transformations that use parameters derived from the data. We will introduce and discuss data pre-processing in Chapter <a href="supervisedmli.html#supervisedmli">9</a>.</p>
<div id="example-data" class="section level3 hasAnchor" number="3.2.1">
<h3><span class="header-section-number">3.2.1</span> Example data<a href="datawrangling.html#example-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The example data used in this chapter are parallel time series of (gaseous) CO<span class="math inline">\(_2\)</span> and water vapor exchange fluxes between the vegetation and the atmosphere, along with various meteorological variables measured in parallel. Quasi-continuous measurements of temporally changing gas exchange fluxes are obtained with the eddy covariance technique which relies on the parallel quantification of vertical wind speeds and gas concentrations.</p>
<p>The data are provided at half-hourly resolution for the site <a href="https://www.swissfluxnet.ethz.ch/index.php/sites/ch-lae-laegeren/site-info-ch-lae/">CH-Lae</a>, located on the south slope of the Lägern mountain on the Swiss Plateau at 689 m a.s.l. in a mixed forest with a distinct seasonal course of active green leaves (a substantial portion of the trees in the measured forest are deciduous). The dataset is generated and formatted following standard protocols (<a href="https://fluxnet.org//data/fluxnet2015-dataset/">FLUXNET2015</a>). For more information of the variables in the dataset, see the <a href="http://fluxnet.fluxdata.org/data/fluxnet2015-dataset/">FLUXNET2015 website</a> and <a href="https://www.nature.com/articles/s41597-020-0534-3">Pastorello et al., 2020</a> for a comprehensive documentation of variable definitions and methods.</p>
<p>For our demonstrations, the following variables are the most relevant:</p>
<ul>
<li><code>TIMESTAMP_START</code>: Hour and day of the start of the measurement period for which the respective row’s data are representative. Provided in a format of “YYYYMMDDhhmm”.</li>
<li><code>TIMESTAMP_END</code>: Hour and day of the end of the measurement period for which the respective row’s data are representative. Provided in a format of “YYYYMMDDhhmm”.</li>
<li><code>TA_*</code> (°C): Air temperature.</li>
<li><code>SW_IN_*</code> (W m<span class="math inline">\(^{-2}\)</span>): Shortwave incoming radiation</li>
<li><code>LW_IN_*</code> (W m<span class="math inline">\(^{-2}\)</span>): Longwave incoming radiation</li>
<li><code>VPD_*</code> (hPa): Vapor pressure deficit (the difference between actual and saturation water vapor pressure)</li>
<li><code>PA_*</code> (kPa): Atmospheric pressure</li>
<li><code>P_*</code> (mm): Precipitation</li>
<li><code>WS_*</code> (m <span class="math inline">\(^{-1}\)</span>): Wind speed</li>
<li><code>SWC_*</code> (%): Volumetric soil water content</li>
<li><code>GPP_*</code> (<span class="math inline">\(\mu\)</span>mol CO<span class="math inline">\(_2\)</span> m<span class="math inline">\(^{-2}\)</span> s<span class="math inline">\(^{-1}\)</span>): Gross primary production (the ecosystem-level gross CO<span class="math inline">\(_2\)</span> uptake flux driven by photosynthesis)</li>
<li><code>*_QC</code>: Quality control information for the variable <code>*</code>. Important for us: <code>NEE_*_QC</code> is the quality control information for the net ecosystem CO<span class="math inline">\(_2\)</span> exchange flux (<code>NEE_*</code>) and for GPP derived from the corresponding NEE estimate (<code>GPP_*</code>). 0 = measured, 1 = good quality gap-filled, 2 = medium, 3 = poor.</li>
</ul>
<p>Suffixes <code>_*</code> indicate that multiple estimates for respective variables are available and distinguished by different suffixes. For example, variables <code>TA_*</code> contain the same information, but are derived with slightly different assumptions and gap-filling techniques. The meanings of suffixes are described in <a href="https://www.nature.com/articles/s41597-020-0534-3">Pastorello et al., 2020</a>.</p>
</div>
<div id="tidyverse" class="section level3 hasAnchor" number="3.2.2">
<h3><span class="header-section-number">3.2.2</span> Tidyverse<a href="datawrangling.html#tidyverse" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The tidyverse is a collection of R packages and functions that share a common design philosophy, enabling a particularly efficient implementation of transformation steps on tabular data. The most important data and function design principle of the tidyverse is that each function takes a data frame as its first argument and returns a data frame as its output.</p>
<!-- Working on a (geo-) data science project, we want to efficiently progress through the multiple circles of exploratory data analysis. The following aspects are particularly important for fast and error-free progression. First, the programming language should be conducive of fast, intuitive, and error-free coding. Second, code that we have written once should be legible by others and by our future selves (even after a long holiday or after the manuscript has been seen by all reviewers months after we finished the analysis for our initial submission). It's the daily reality of us (geo-) data scientist that the code we write is harder to read than text in a newspaper, and that it will have bugs. There is (so far) no magic solution to this. But the R tidyverse comes close.  -->
<p>From this design principles, even the most convoluted code and implementation of data transformation steps fall into place and fast and error-free progression through exploratory data analysis is facilitated. Therefore, you will be introduced to the R {tidyverse} here and we heavily rely on this <em>dialect</em> of the R language throughout the remainder of this course.</p>
</div>
<div id="reading-tabular-data" class="section level3 hasAnchor" number="3.2.3">
<h3><span class="header-section-number">3.2.3</span> Reading tabular data<a href="datawrangling.html#reading-tabular-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Tabular data are organised in rows and columns. R data frames are tabular data. As introduced in Chapter <a href="gettingstarted.html#gettingstarted">1</a>, each column can be regarded as a vector of a certain type. Each row contains the same number of columns and each column contains the same type of values (for example numeric, or characters). Each row can be regarded as a separate instance or data record - for example a record of simultaneously taken measurements of different variables, along with some attributes and meta information (e.g., the date). In Chapter <a href="datavariety.html#datavariety">5</a>, you will be introduced to other types of data.</p>
<p>The most common format for tabular data are CSV (comma-separated-values), typically indicated by the file name suffix <code>.csv</code>. CSV is a text-based file format, readable across platforms and does not rely on proprietary software (as opposed to, for example, <code>.xlsx</code>). The first row in a CSV file typically specifies the name of the variable provided in the respective column.</p>
<p>Let’s get started with working with our example data set and read it into R, as the variable <code>half_hourly_fluxes</code>. Note that the naming of variables can be important for keeping code legible. Chose intuitively understandable names that describe what the object represents (as done here).</p>
<p>To import the data into the R environment, we use the function <code>read_csv()</code> from the {readr} package (part of tidyverse). In other R code, you will also encounter the base R <code>read.csv()</code> function. However, <code>read_csv()</code> is much faster and reads data into a tidyverse-data frame (a <em>tibble</em>) which has some useful additional characteristics, on top of a common R data frame. For example, <em>tibbles</em> generate a nicely readable output when printing the object as is done below.</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb118-1"><a href="datawrangling.html#cb118-1" aria-hidden="true" tabindex="-1"></a>half_hourly_fluxes <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">&quot;./data/FLX_CH-Lae_FLUXNET2015_FULLSET_HH_2004-2006.csv&quot;</span>)</span>
<span id="cb118-2"><a href="datawrangling.html#cb118-2" aria-hidden="true" tabindex="-1"></a>half_hourly_fluxes</span></code></pre></div>
<pre><code>## # A tibble: 52,608 × 235
##    TIMEST…¹ TIMES…² TA_F_…³ TA_F_…⁴ TA_ERA  TA_F TA_F_QC SW_IN…⁵ SW_IN…⁶ SW_IN…⁷
##       &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
##  1  2.00e11 2.00e11   -9999   -9999  -2.22 -2.22       2       0   -9999   -9999
##  2  2.00e11 2.00e11   -9999   -9999  -2.25 -2.25       2       0   -9999   -9999
##  3  2.00e11 2.00e11   -9999   -9999  -2.28 -2.28       2       0   -9999   -9999
##  4  2.00e11 2.00e11   -9999   -9999  -2.50 -2.50       2       0   -9999   -9999
##  5  2.00e11 2.00e11   -9999   -9999  -2.72 -2.72       2       0   -9999   -9999
##  6  2.00e11 2.00e11   -9999   -9999  -2.94 -2.94       2       0   -9999   -9999
##  7  2.00e11 2.00e11   -9999   -9999  -3.17 -3.17       2       0   -9999   -9999
##  8  2.00e11 2.00e11   -9999   -9999  -3.39 -3.39       2       0   -9999   -9999
##  9  2.00e11 2.00e11   -9999   -9999  -3.61 -3.61       2       0   -9999   -9999
## 10  2.00e11 2.00e11   -9999   -9999  -3.59 -3.59       2       0   -9999   -9999
## # … with 52,598 more rows, 225 more variables: SW_IN_ERA &lt;dbl&gt;, SW_IN_F &lt;dbl&gt;,
## #   SW_IN_F_QC &lt;dbl&gt;, LW_IN_F_MDS &lt;dbl&gt;, LW_IN_F_MDS_QC &lt;dbl&gt;, LW_IN_ERA &lt;dbl&gt;,
## #   LW_IN_F &lt;dbl&gt;, LW_IN_F_QC &lt;dbl&gt;, LW_IN_JSB &lt;dbl&gt;, LW_IN_JSB_QC &lt;dbl&gt;,
## #   LW_IN_JSB_ERA &lt;dbl&gt;, LW_IN_JSB_F &lt;dbl&gt;, LW_IN_JSB_F_QC &lt;dbl&gt;,
## #   VPD_F_MDS &lt;dbl&gt;, VPD_F_MDS_QC &lt;dbl&gt;, VPD_ERA &lt;dbl&gt;, VPD_F &lt;dbl&gt;,
## #   VPD_F_QC &lt;dbl&gt;, PA &lt;dbl&gt;, PA_ERA &lt;dbl&gt;, PA_F &lt;dbl&gt;, PA_F_QC &lt;dbl&gt;, P &lt;dbl&gt;,
## #   P_ERA &lt;dbl&gt;, P_F &lt;dbl&gt;, P_F_QC &lt;dbl&gt;, WS &lt;dbl&gt;, WS_ERA &lt;dbl&gt;, WS_F &lt;dbl&gt;, …</code></pre>
<blockquote>
<p>To reproduce this code chunk, you can download the file <code>FLX_CH-Lae_FLUXNET2015_FULLSET_HH_2004-2006.csv</code> from <a href="https://raw.githubusercontent.com/geco-bern/agds/main/data/FLX_CH-Lae_FLUXNET2015_FULLSET_HH_2004-2006.csv">here</a> and read it from the local path where the file is stored on your machine. All data files used in this tutorials are stored <a href="https://github.com/geco-bern/agds/tree/main/data">here</a>.</p>
</blockquote>
<p>Since the file is properly formatted, with variable names given in the first line of the file, the function <code>read_csv()</code> identifies them correctly as column names and interprets values in each column as values of a consistent type (as numeric <code>&lt;dbl&gt;</code>). The file is also automatically machine-readable because it has no merged cells and only one value per cell.</p>
</div>
<div id="variable-selection" class="section level3 hasAnchor" number="3.2.4">
<h3><span class="header-section-number">3.2.4</span> Variable selection<a href="datawrangling.html#variable-selection" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For our further data exploration, we will reduce the data frame we are working with and select a reduced set of variables. Reducing the dataset can have the advantage of speeding up further processing steps, especially when the data are large. For the further steps in this chapter we will now subset our original data. We select the following variants of variables described above, plus some additional variables (further information in <a href="https://www.nature.com/articles/s41597-020-0534-3">Pastorello et al., 2020</a>):</p>
<ul>
<li>All variables with names starting with <code>TIMESTAMP</code>)</li>
<li>All meteorological variables derived following the “final gap-filled method”, as indicated with names ending with <code>_F</code>.</li>
<li>GPP estimates that are based on the nighttime decomposition method, using the “most representative” of different gap-filling versions, after having applied the variable u-star filtering method (<code>GPP_NT_VUT_REF</code>) and the corresponding quality control information (<code>NEE_VUT_REF_QC</code>)</li>
<li>Soil water measured at different depths (variables starting with <code>SWC_F_MDS_</code>)</li>
<li>Do not use any radiation variables derived with the “JSBACH” algorithm (not with a name that contains the string <code>JSB</code>)</li>
<li>Flag indicating whether a time step is at night (<code>NIGHT</code>)</li>
</ul>
<p>This is implemented by:</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb120-1"><a href="datawrangling.html#cb120-1" aria-hidden="true" tabindex="-1"></a>half_hourly_fluxes <span class="ot">&lt;-</span> <span class="fu">select</span>(</span>
<span id="cb120-2"><a href="datawrangling.html#cb120-2" aria-hidden="true" tabindex="-1"></a>  half_hourly_fluxes,</span>
<span id="cb120-3"><a href="datawrangling.html#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">starts_with</span>(<span class="st">&quot;TIMESTAMP&quot;</span>),</span>
<span id="cb120-4"><a href="datawrangling.html#cb120-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ends_with</span>(<span class="st">&quot;_F&quot;</span>),</span>
<span id="cb120-5"><a href="datawrangling.html#cb120-5" aria-hidden="true" tabindex="-1"></a>  GPP_NT_VUT_REF,</span>
<span id="cb120-6"><a href="datawrangling.html#cb120-6" aria-hidden="true" tabindex="-1"></a>  NEE_VUT_REF_QC,</span>
<span id="cb120-7"><a href="datawrangling.html#cb120-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">starts_with</span>(<span class="st">&quot;SWC_F_MDS_&quot;</span>),</span>
<span id="cb120-8"><a href="datawrangling.html#cb120-8" aria-hidden="true" tabindex="-1"></a>  <span class="sc">-</span><span class="fu">contains</span>(<span class="st">&quot;JSB&quot;</span>),</span>
<span id="cb120-9"><a href="datawrangling.html#cb120-9" aria-hidden="true" tabindex="-1"></a>  NIGHT</span>
<span id="cb120-10"><a href="datawrangling.html#cb120-10" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>This reduces our dataset from 235 available variables to 59 variables. As you can see, <code>select()</code> is a powerful tool to apply multiple selection criteria on your data frame in one step. It takes many functions that make filtering the columns easier. For example, criteria can be formulated based on the variable names with <code>starts_with()</code>, <code>ends_with()</code>, <code>contains()</code>, <code>matches()</code>, etc. Using these functions within <code>select()</code> can help if several column names start with the same characters or contain the same pattern and all need to be selected. If a minus (<code>-</code>) is added in front of a column name or one of the mentioned functions within <code>select()</code>, then R will not include the stated column(s). Note that the selection criteria are evaluated in the order we write them in the <code>select()</code> function call. You can find the complete reference for selecting variables <a href="https://dplyr.tidyverse.org/reference/select.html">here</a>.</p>
</div>
<div id="time-objects" class="section level3 hasAnchor" number="3.2.5">
<h3><span class="header-section-number">3.2.5</span> Time objects<a href="datawrangling.html#time-objects" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The automatic interpretation of the variables <code>TIMESTAMP_START</code> and <code>TIMESTAMP_END</code> by the function <code>read_csv()</code> is not optimal:</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="datawrangling.html#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(half_hourly_fluxes<span class="sc">$</span>TIMESTAMP_START[[<span class="dv">1</span>]])</span></code></pre></div>
<pre><code>## [1] &quot;numeric&quot;</code></pre>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="datawrangling.html#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.character</span>(half_hourly_fluxes<span class="sc">$</span>TIMESTAMP_START[[<span class="dv">1</span>]])</span></code></pre></div>
<pre><code>## [1] &quot;200401010000&quot;</code></pre>
<p>As we can see, it is considered by R as a numeric variable with 12 digits (“double-precision”, occupying 64 bits in computer memory). After printing the variable as a string, we can guess that the format is: <code>YYYYMMDDhhmm</code>. The {lubridate} package is designed to facilitate processing date and time objects. Knowing the format of the timestamp variables in our dataset, we can use <code>ymd_hm()</code> to convert them to actual date-time objects.</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb125-1"><a href="datawrangling.html#cb125-1" aria-hidden="true" tabindex="-1"></a>dates <span class="ot">&lt;-</span> <span class="fu">ymd_hm</span>(half_hourly_fluxes<span class="sc">$</span>TIMESTAMP_START)</span>
<span id="cb125-2"><a href="datawrangling.html#cb125-2" aria-hidden="true" tabindex="-1"></a>dates[<span class="dv">1</span>]</span></code></pre></div>
<pre><code>## [1] &quot;2004-01-01 UTC&quot;</code></pre>
<p>Working with such date-time objects facilitates typical operations on time series. For example, adding one day can be done by:</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb127-1"><a href="datawrangling.html#cb127-1" aria-hidden="true" tabindex="-1"></a>nextday <span class="ot">&lt;-</span> dates <span class="sc">+</span> <span class="fu">days</span>(<span class="dv">1</span>)</span>
<span id="cb127-2"><a href="datawrangling.html#cb127-2" aria-hidden="true" tabindex="-1"></a>nextday[<span class="dv">1</span>]</span></code></pre></div>
<pre><code>## [1] &quot;2004-01-02 UTC&quot;</code></pre>
<p>The following returns the month of each date object:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb129-1"><a href="datawrangling.html#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="fu">month</span>(dates[<span class="dv">1</span>])</span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>The number 1 stands for the month of the year, i.e., January. You can find more information on formatting dates and time within the {tidyverse} <a href="https://r4ds.had.co.nz/dates-and-times.html">here</a>, and a complete reference of the {lubridate} package is available <a href="https://lubridate.tidyverse.org/">here</a>.</p>
</div>
<div id="variable-re--definition" class="section level3 hasAnchor" number="3.2.6">
<h3><span class="header-section-number">3.2.6</span> Variable (re-) definition<a href="datawrangling.html#variable-re--definition" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Since <code>read_csv()</code> did not interpret the <code>TIMESTAMP_*</code> variables as desired, we may convert the entire column in the data frame into a date-time object. In base-R, we would do this by:</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="datawrangling.html#cb131-1" aria-hidden="true" tabindex="-1"></a>half_hourly_fluxes<span class="sc">$</span>TIMESTAMP_START <span class="ot">&lt;-</span> <span class="fu">ymd_hm</span>(half_hourly_fluxes<span class="sc">$</span>TIMESTAMP_START)</span></code></pre></div>
<p>Modifying existing or creating new variables (columns) in a data frame is done in the {tidyverse} using the function <code>mutate()</code>. The equivalent statement is:</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb132-1"><a href="datawrangling.html#cb132-1" aria-hidden="true" tabindex="-1"></a>half_hourly_fluxes <span class="ot">&lt;-</span> <span class="fu">mutate</span>(</span>
<span id="cb132-2"><a href="datawrangling.html#cb132-2" aria-hidden="true" tabindex="-1"></a>  half_hourly_fluxes,</span>
<span id="cb132-3"><a href="datawrangling.html#cb132-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">TIMESTAMP_START =</span> <span class="fu">ymd_hm</span>(TIMESTAMP_START)</span>
<span id="cb132-4"><a href="datawrangling.html#cb132-4" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>Note that in the code chunk above, the function <code>mutate()</code> is from the tidyverse package {dplyr}. It takes a dataframe as its first argument (here <code>half_hourly_fluxes</code>) and returns a dataframe as its output. You will encounter an alternative, but equivalent, syntax in the following form:</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="datawrangling.html#cb133-1" aria-hidden="true" tabindex="-1"></a>half_hourly_fluxes <span class="ot">&lt;-</span> half_hourly_fluxes <span class="sc">|&gt;</span> </span>
<span id="cb133-2"><a href="datawrangling.html#cb133-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TIMESTAMP_START =</span> <span class="fu">ymd_hm</span>(TIMESTAMP_START))</span></code></pre></div>
<p>Here, the <strong>pipe</strong> operator <code>|&gt;</code> is used. It “pipes” the object evaluated on its left side into the function on its right side, where the object takes the place of (but is not spelled out as) the <em>first argument</em> of that function. Using the pipe operator can have the advantage of facilitating the separation, removal, inserting, or re-arranging of individual transformation steps. Arguably, it facilitates reading code, especially for complex data transformation workflows. Therefore, you will encounter the pipe operator frequently throughout the remainder of this course.</p>
<blockquote>
<p>Note: The pipe operator is so popular that has been recently included in the latest versions of base R (version 4.1.0 and beyond). This is the <code>|&gt;</code> pipe we just introduced. Nevertheless, you may encounter the <code>%&gt;%</code> operator, which is the original pipe from the {magrittr} package (part of the {tidyverse}).</p>
</blockquote>
<blockquote>
<p>Note: If you cannot update R and have a version older than 4.1.0, just use the <code>magrittr</code> pipe <code>%&gt;%</code> throughout. This can happen if you have an older Macbook that can’t operate the latest Operating System version.</p>
</blockquote>
<p>Mutating both our timestamp variables could be written as <code>mutate(TIMESTAMP_START = ymd_hm(TIMESTAMP_START), TIMESTAMP_END = ymd_hm(TIMESTAMP_END))</code>. Sometimes, such multiple-variable mutate statements can get quite long. A handy short version of this can be implemented using <code>across()</code>:</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="datawrangling.html#cb134-1" aria-hidden="true" tabindex="-1"></a>half_hourly_fluxes <span class="ot">&lt;-</span> half_hourly_fluxes <span class="sc">|&gt;</span> </span>
<span id="cb134-2"><a href="datawrangling.html#cb134-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">starts_with</span>(<span class="st">&quot;TIMESTAMP_&quot;</span>), ymd_hm))</span></code></pre></div>
<p>We will encounter more ways to use mutate later in this tutorial. A complete reference to <code>mutate()</code> is available <a href="https://r4ds.had.co.nz/transform.html#add-new-variables-with-mutate">here</a>.</p>
<p>If you only want to change the name of a variable, but not modify its values, you can do so with the {dplyr} function <code>rename()</code>.</p>
</div>
<div id="axes-of-variation" class="section level3 hasAnchor" number="3.2.7">
<h3><span class="header-section-number">3.2.7</span> Axes of variation<a href="datawrangling.html#axes-of-variation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Tabular data are two-dimensional (rows <span class="math inline">\(\times\)</span> columns), but not all two-dimensional data are tabular. For example, raster data are a two-dimensional array of data (a matrix) representing variables on an evenly spaced grid, for example pixels in remotely sensed imagery. For example the <code>volcano</code> data (provided as an example dataset in R) is a matrix - each column contains the same variable, and no variable names are provided.</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb135-1"><a href="datawrangling.html#cb135-1" aria-hidden="true" tabindex="-1"></a>volcano[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4] [,5]
## [1,]  100  100  101  101  101
## [2,]  101  101  102  102  102
## [3,]  102  102  103  103  103
## [4,]  103  103  104  104  104
## [5,]  104  104  105  105  105</code></pre>
<p>In the <code>volcano</code> dataset, rows and columns represent different geographic positions in latitude and longitude, respectively. The <code>volcano</code> data are not tabular data. Another typical example for non-tabular data are climate model outputs. They are typically given as <em>arrays</em> with more than two dimensions. Typically, this is longitude, latitude, and time, and sometimes a vertical dimension representing, for example, elevation. Such data are multi-dimensional and, as such, not tabular.</p>
<p>Tabular data, although formatted in two dimensions by rows and columns, may represent data that varies along multiple axes. Most environmental data are <em>structured</em>, that is, values of “nearby” observations tend to be more similar than values of “distant” observations. Here, “nearby” and “distant” may refer to a spatial distance, but not necessarily so. Structure in data arises from similarity of the subjects generating the data (e.g., evapotranspiration over two croplands may be more similar than evapotranspiration over a forest), or from temporal proximity. In biological data, there may be a genetic structure arising from evolutionary relatedness (<a href="https://onlinelibrary.wiley.com/doi/10.1111/ecog.02881">Roberts et al., 2016</a>). Note also that temporal proximity is more complex than than being governed by a single dimension - time. In environmental data, time is often expressed through periodically varying conditions (the diurnal and seasonal cycles). It’s often critical to understand and account for the structure in data when analysing it and using it for model fitting. Challenges are posed when structure is not apparent or not known.</p>
<p>Note also that some structures are <em>hierarchical</em>. For example, data may be structured by postal codes within cantons; or by hours within a day within a year. Biological data may be generated by species within <em>genera</em> within <em>families</em>. Data from experiments is typically structured as <em>samples</em> within <em>treatments</em>. You see, structure in data is rather the rule than the exception.</p>
<p>Our example data contains values recorded at each half-hourly time interval over the course of eleven years (check by <code>nrow(half_hourly_fluxes)/(2*24*365)</code>). The data are recorded at a site, located in the temperate climate zone, where solar radiation and therefore also other meteorological variables and ecosystem fluxes vary substantially over the course of a day and over the course of a year. Although not explicitly separated, the date-time object thus encodes information along multiple <em>axes of variation</em> in the data. For example, over the course of one day (<code>2*24</code> rows in our data), the shortwave incoming radiation <code>SW_IN_F</code> varies over a typical diurnal cycle:</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="datawrangling.html#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb137-2"><a href="datawrangling.html#cb137-2" aria-hidden="true" tabindex="-1"></a>  half_hourly_fluxes[<span class="dv">1</span><span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span><span class="dv">24</span>),]<span class="sc">$</span>TIMESTAMP_START,</span>
<span id="cb137-3"><a href="datawrangling.html#cb137-3" aria-hidden="true" tabindex="-1"></a>  half_hourly_fluxes[<span class="dv">1</span><span class="sc">:</span>(<span class="dv">2</span><span class="sc">*</span><span class="dv">24</span>),]<span class="sc">$</span>SW_IN_F,</span>
<span id="cb137-4"><a href="datawrangling.html#cb137-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">&quot;l&quot;</span></span>
<span id="cb137-5"><a href="datawrangling.html#cb137-5" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-69-1.png" width="672" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Note: <code>plot()</code> is the very basic of plotting data. In Chapter <a href="datavis.html#datavis">4</a>, you will get introduced to additional methods for visualising data. The argument <code>type = "l"</code> indicates that we want a line plot, rather than points.</p>
</blockquote>
<p>Over the course of an entire year, shortwave incoming radiation varies with the seasons, peaking in summer:</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb138-1"><a href="datawrangling.html#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb138-2"><a href="datawrangling.html#cb138-2" aria-hidden="true" tabindex="-1"></a>  half_hourly_fluxes[<span class="dv">1</span><span class="sc">:</span>(<span class="dv">365</span><span class="sc">*</span><span class="dv">2</span><span class="sc">*</span><span class="dv">24</span>),]<span class="sc">$</span>TIMESTAMP_START,</span>
<span id="cb138-3"><a href="datawrangling.html#cb138-3" aria-hidden="true" tabindex="-1"></a>  half_hourly_fluxes[<span class="dv">1</span><span class="sc">:</span>(<span class="dv">365</span><span class="sc">*</span><span class="dv">2</span><span class="sc">*</span><span class="dv">24</span>),]<span class="sc">$</span>SW_IN_F,</span>
<span id="cb138-4"><a href="datawrangling.html#cb138-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">&quot;l&quot;</span></span>
<span id="cb138-5"><a href="datawrangling.html#cb138-5" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-70-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>All data frames have two dimensions, rows and columns. Our data frame is organised along half-hourly time steps in rows. As described above, these time steps belong to different days, months, and years, although these “axes of variation” are not reflected by the structure of the data frame object itself and we do not have columns that indicate the day, month or year of each half-hourly time step. This would be redundant information since the date-time objects of columns <code>TIMESTAMP_*</code> contain this information. However, for certain applications, it may be useful to separate information regarding these axes of variation more explicitly. For example by:</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="datawrangling.html#cb139-1" aria-hidden="true" tabindex="-1"></a>half_hourly_fluxes <span class="sc">|&gt;</span></span>
<span id="cb139-2"><a href="datawrangling.html#cb139-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(TIMESTAMP_START),</span>
<span id="cb139-3"><a href="datawrangling.html#cb139-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">month =</span> <span class="fu">month</span>(TIMESTAMP_START),</span>
<span id="cb139-4"><a href="datawrangling.html#cb139-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">doy =</span> <span class="fu">yday</span>(TIMESTAMP_START)     <span class="co"># day of year</span></span>
<span id="cb139-5"><a href="datawrangling.html#cb139-5" aria-hidden="true" tabindex="-1"></a>         ) <span class="sc">|&gt;</span></span>
<span id="cb139-6"><a href="datawrangling.html#cb139-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(TIMESTAMP_START, TIMESTAMP_END, year, month, doy)  <span class="co"># for displaying</span></span></code></pre></div>
<pre><code>## # A tibble: 52,608 × 5
##    TIMESTAMP_START     TIMESTAMP_END        year month   doy
##    &lt;dttm&gt;              &lt;dttm&gt;              &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 2004-01-01 00:00:00 2004-01-01 00:30:00  2004     1     1
##  2 2004-01-01 00:30:00 2004-01-01 01:00:00  2004     1     1
##  3 2004-01-01 01:00:00 2004-01-01 01:30:00  2004     1     1
##  4 2004-01-01 01:30:00 2004-01-01 02:00:00  2004     1     1
##  5 2004-01-01 02:00:00 2004-01-01 02:30:00  2004     1     1
##  6 2004-01-01 02:30:00 2004-01-01 03:00:00  2004     1     1
##  7 2004-01-01 03:00:00 2004-01-01 03:30:00  2004     1     1
##  8 2004-01-01 03:30:00 2004-01-01 04:00:00  2004     1     1
##  9 2004-01-01 04:00:00 2004-01-01 04:30:00  2004     1     1
## 10 2004-01-01 04:30:00 2004-01-01 05:00:00  2004     1     1
## # … with 52,598 more rows</code></pre>
<p>Note that we used <code>mutate()</code> here to create a new variable (column) in the data frame, as opposed to above where we overwrote an existing variable with the same function.</p>
</div>
<div id="tidydata" class="section level3 hasAnchor" number="3.2.8">
<h3><span class="header-section-number">3.2.8</span> Tidy data<a href="datawrangling.html#tidydata" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Data comes in many forms and shapes. For example, Excel provides a playground for even the wildest layouts of information in some remotely tabular form and merged cells as we will see in the <a href="datawrangling.html#exerciseswrangling">Exercises</a>. A data frame imposes a relatively strict formatting in named columns of equal length. But even data frames can come in various shapes - even if the information they contain is the same.</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="datawrangling.html#cb141-1" aria-hidden="true" tabindex="-1"></a>co2_concentration</span></code></pre></div>
<pre><code>## # A tibble: 36 × 3
##     year month co2_concentration
##    &lt;int&gt; &lt;ord&gt;             &lt;dbl&gt;
##  1  1959 Jan                315.
##  2  1959 Feb                316.
##  3  1959 Mar                316.
##  4  1959 Apr                318.
##  5  1959 May                318.
##  6  1959 Jun                318 
##  7  1959 Jul                316.
##  8  1959 Aug                315.
##  9  1959 Sep                314.
## 10  1959 Oct                313.
## # … with 26 more rows</code></pre>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="datawrangling.html#cb143-1" aria-hidden="true" tabindex="-1"></a>co2_concentration_monthly</span></code></pre></div>
<pre><code>## # A tibble: 3 × 13
##    year   Jan   Feb   Mar   Apr   May   Jun   Jul   Aug   Sep   Oct   Nov   Dec
##   &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  1959  315.  316.  316.  318.  318.  318   316.  315.  314.  313.  315.  315.
## 2  1960  316.  317.  317.  319.  320.  319.  318.  316.  314   314.  315.  316.
## 3  1961  317.  318.  318.  319.  320.  320.  318.  317.  315.  315.  316.  317.</code></pre>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="datawrangling.html#cb145-1" aria-hidden="true" tabindex="-1"></a>co2_concentration_yearly</span></code></pre></div>
<pre><code>## # A tibble: 12 × 4
##    month `1959` `1960` `1961`
##    &lt;ord&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
##  1 Jan     315.   316.   317.
##  2 Feb     316.   317.   318.
##  3 Mar     316.   317.   318.
##  4 Apr     318.   319.   319.
##  5 May     318.   320.   320.
##  6 Jun     318    319.   320.
##  7 Jul     316.   318.   318.
##  8 Aug     315.   316.   317.
##  9 Sep     314.   314    315.
## 10 Oct     313.   314.   315.
## 11 Nov     315.   315.   316.
## 12 Dec     315.   316.   317.</code></pre>
<p>There are advantages for interoperability and ease of use when data frames come with consistent layouts, adhering to certain design principles. We have learned that in tabular data, each row contains the same number of columns and each column contains the same type of values (for example numeric, or characters). And that each row can be regarded as a separate instance of the same type, for example a record of simultaneously taken measurements, along with some attributes. Following these principles strictly leads to <em>tidy data</em>. In essence, quoting <a href="https://r4ds.had.co.nz/tidy-data.html">Wickham and Grolemund (2017)</a>, data are tidy if:</p>
<ul>
<li>Each variable has its own column.</li>
<li>Each observation has its own row.</li>
<li>Each value has its own cell.</li>
</ul>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:tidy"></span>
<img src="figures/tidy_data.png" alt="Rules for tidy data. Figure from [Wickham and Grolemund (2017)](https://r4ds.had.co.nz/tidy-data.html)" width="100%" />
<p class="caption">
Figure 3.1: Rules for tidy data. Figure from <a href="https://r4ds.had.co.nz/tidy-data.html">Wickham and Grolemund (2017)</a>
</p>
</div>
<p>The {tidyr} package provides powerful functions to make data tidy. In the examples above, <code>co2_concentration_monthly</code> and and <code>co2_concentration_yearly</code> are not tidy. In <code>co2_concentration_monthly</code>, the same variable (CO2 concentration) appears in multiple columns. Organising columns by months leads to a “wide” table format. We can convert it to a “long” format by:</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="datawrangling.html#cb147-1" aria-hidden="true" tabindex="-1"></a>co2_concentration_monthly <span class="sc">|&gt;</span> </span>
<span id="cb147-2"><a href="datawrangling.html#cb147-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">13</span>, <span class="at">names_to =</span> <span class="st">&quot;month&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;co2&quot;</span>)</span></code></pre></div>
<pre><code>## # A tibble: 36 × 3
##     year month   co2
##    &lt;int&gt; &lt;chr&gt; &lt;dbl&gt;
##  1  1959 Jan    315.
##  2  1959 Feb    316.
##  3  1959 Mar    316.
##  4  1959 Apr    318.
##  5  1959 May    318.
##  6  1959 Jun    318 
##  7  1959 Jul    316.
##  8  1959 Aug    315.
##  9  1959 Sep    314.
## 10  1959 Oct    313.
## # … with 26 more rows</code></pre>
<p>This corresponds to the format of <code>co2_concentration</code> and is tidy. A long format of data frames is required to visualise data using the plotting functions of the {ggplot2} package which will be introduced in Chapter <a href="datavis.html#datavis">4</a>.</p>
<p>Either way, for certain applications, it may be advantageous to work with a wide format. We can convert from a long to a wide format by:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="datawrangling.html#cb149-1" aria-hidden="true" tabindex="-1"></a>co2_concentration <span class="sc">|&gt;</span> </span>
<span id="cb149-2"><a href="datawrangling.html#cb149-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> year, <span class="at">values_from =</span> co2_concentration)</span></code></pre></div>
<pre><code>## # A tibble: 12 × 4
##    month `1959` `1960` `1961`
##    &lt;ord&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
##  1 Jan     315.   316.   317.
##  2 Feb     316.   317.   318.
##  3 Mar     316.   317.   318.
##  4 Apr     318.   319.   319.
##  5 May     318.   320.   320.
##  6 Jun     318    319.   320.
##  7 Jul     316.   318.   318.
##  8 Aug     315.   316.   317.
##  9 Sep     314.   314    315.
## 10 Oct     313.   314.   315.
## 11 Nov     315.   315.   316.
## 12 Dec     315.   316.   317.</code></pre>
<p>When seeking, for example, the average CO2 concentration for each month, you may be tempted to work with a wide data frame and treat it as a matrix to calculate a mean by rows. You can do so, but then, you leave the <code>tidyverse</code>. This will complicate your life. You’ll learn how to perform tidy data aggregation below.</p>
<p>The concept of tidy data can even be taken further by understanding a “value” as any object type, e.g., a list or a data frame. This leads to a list or data frame “nested” within a data frame. You will learn more about this below.</p>
</div>
<div id="aggregating-data" class="section level3 hasAnchor" number="3.2.9">
<h3><span class="header-section-number">3.2.9</span> Aggregating data<a href="datawrangling.html#aggregating-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Aggregating data refers to collapsing a larger set of values into a smaller set of values that are derived from the larger set. For example, we can aggregate over all <span class="math inline">\(N\)</span> rows in a data frame (<span class="math inline">\(N\times M\)</span>), calculating the sum for each of the <span class="math inline">\(M\)</span> columns. This returns a data frame (<span class="math inline">\(1 \times M\)</span>) with the same number of columns as the initial data frame, but only one row. Often, aggregations are done not across all rows but for rows within <span class="math inline">\(G\)</span> groups of rows. This yields a data frame (<span class="math inline">\(G \times M\)</span>) with the number of rows corresponding to the number of groups.</p>
<p>Let’s say we want to calculate the mean of half-hourly shortwave radiation within each day. We thus have <span class="math inline">\(N\)</span> half-hourly time steps in <span class="math inline">\(G\)</span> days. That is, to aggregate our half-hourly data to daily data by taking a mean. There are two pieces of information needed for an aggregation step: The factor (or “axis of variation”), here days, that groups a vector of values for collapsing it into a single value, and the function used for collapsing values, here, the <code>mean()</code> function. This function should take a vector as an argument and return a single value as an output. These two steps are implemented by the {dplyr} functions <code>group_by()</code> and <code>summarise()</code>. The entire aggregation workflow is implemented by the following code:</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="datawrangling.html#cb151-1" aria-hidden="true" tabindex="-1"></a>daily_fluxes <span class="ot">&lt;-</span> half_hourly_fluxes <span class="sc">|&gt;</span>  </span>
<span id="cb151-2"><a href="datawrangling.html#cb151-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as_date</span>(TIMESTAMP_START)) <span class="sc">|&gt;</span>  <span class="co"># converts the ymd_hm-formatted date-time object to a date-only object (ymd)</span></span>
<span id="cb151-3"><a href="datawrangling.html#cb151-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">|&gt;</span> </span>
<span id="cb151-4"><a href="datawrangling.html#cb151-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">SW_IN_F =</span> <span class="fu">mean</span>(SW_IN_F))</span></code></pre></div>
<p>The seasonal course can now be more clearly be visualized with the data aggregated to daily values.</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb152-1"><a href="datawrangling.html#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(daily_fluxes[<span class="dv">1</span><span class="sc">:</span><span class="dv">365</span>,]<span class="sc">$</span>date, daily_fluxes[<span class="dv">1</span><span class="sc">:</span><span class="dv">365</span>,]<span class="sc">$</span>SW_IN_F, <span class="at">type =</span> <span class="st">&quot;l&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-77-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>We can also apply multiple aggregation functions to different variables simultaneously. In the example below, we aggregate half-hourly data to daily data by…</p>
<ul>
<li><p>taking the daily mean GPP</p></li>
<li><p>counting the number of half-hourly data points by day</p></li>
<li><p>counting the number of measured (not gap-filled) data points</p></li>
<li><p>taking the mean shortwave radiation</p></li>
</ul>
<p>Finally, we calculate the fraction of measured underlying half-hourly data from which the aggregation is calculated and we save the daily data frame as a CSV file for later use.</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb153-1"><a href="datawrangling.html#cb153-1" aria-hidden="true" tabindex="-1"></a>daily_fluxes <span class="ot">&lt;-</span> half_hourly_fluxes <span class="sc">|&gt;</span> </span>
<span id="cb153-2"><a href="datawrangling.html#cb153-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as_date</span>(TIMESTAMP_START)) <span class="sc">|&gt;</span>   <span class="co"># converts time object to a date object</span></span>
<span id="cb153-3"><a href="datawrangling.html#cb153-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(date) <span class="sc">|&gt;</span> </span>
<span id="cb153-4"><a href="datawrangling.html#cb153-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">GPP_NT_VUT_REF =</span> <span class="fu">mean</span>(GPP_NT_VUT_REF, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb153-5"><a href="datawrangling.html#cb153-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">n_datapoints =</span> <span class="fu">n</span>(), <span class="co"># counts the number of observations per day</span></span>
<span id="cb153-6"><a href="datawrangling.html#cb153-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">n_measured =</span> <span class="fu">sum</span>(NEE_VUT_REF_QC <span class="sc">==</span> <span class="dv">0</span>), <span class="co"># counts the number of actually measured data (excluding gap-filled and poor quality data)</span></span>
<span id="cb153-7"><a href="datawrangling.html#cb153-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">SW_IN_F =</span> <span class="fu">mean</span>(SW_IN_F, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),  <span class="co"># we will use this later</span></span>
<span id="cb153-8"><a href="datawrangling.html#cb153-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">.groups =</span> <span class="st">&#39;drop&#39;</span> <span class="co"># to un-group the resulting data frame</span></span>
<span id="cb153-9"><a href="datawrangling.html#cb153-9" aria-hidden="true" tabindex="-1"></a>              ) <span class="sc">|&gt;</span> </span>
<span id="cb153-10"><a href="datawrangling.html#cb153-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">f_measured =</span> n_measured <span class="sc">/</span> n_datapoints) <span class="co"># calculate the fraction of measured values over total observations</span></span>
<span id="cb153-11"><a href="datawrangling.html#cb153-11" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(daily_fluxes, <span class="at">file =</span> <span class="st">&quot;data/daily_fluxes.csv&quot;</span>)</span>
<span id="cb153-12"><a href="datawrangling.html#cb153-12" aria-hidden="true" tabindex="-1"></a>daily_fluxes</span></code></pre></div>
<pre><code>## # A tibble: 1,096 × 6
##    date       GPP_NT_VUT_REF n_datapoints n_measured SW_IN_F f_measured
##    &lt;date&gt;              &lt;dbl&gt;        &lt;int&gt;      &lt;int&gt;   &lt;dbl&gt;      &lt;dbl&gt;
##  1 2004-01-01        -0.0138           48          0    38.1          0
##  2 2004-01-02         0.768            48          0    23.9          0
##  3 2004-01-03         0.673            48          0    54.1          0
##  4 2004-01-04        -0.322            48          0    41.7          0
##  5 2004-01-05         0.841            48          0    17.4          0
##  6 2004-01-06         1.22             48          0    40.5          0
##  7 2004-01-07         0.215            48          0    31.6          0
##  8 2004-01-08         1.11             48          0    58.4          0
##  9 2004-01-09         1.44             48          0    11.9          0
## 10 2004-01-10         0.364            48          0    27.6          0
## # … with 1,086 more rows</code></pre>
<p>More info on how to group values using summarise functions <a href="https://r4ds.had.co.nz/transform.html#grouped-summaries-with-summarise">here</a>, or a summary on the inputs the function <a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a> and <a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a> take.</p>
<p>Aggregating is related to <em>nesting</em> performed by the {tidyr} function <code>nest()</code>:</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb155-1"><a href="datawrangling.html#cb155-1" aria-hidden="true" tabindex="-1"></a>half_hourly_fluxes <span class="sc">|&gt;</span>  </span>
<span id="cb155-2"><a href="datawrangling.html#cb155-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as_date</span>(TIMESTAMP_START)) <span class="sc">|&gt;</span></span>
<span id="cb155-3"><a href="datawrangling.html#cb155-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">|&gt;</span> </span>
<span id="cb155-4"><a href="datawrangling.html#cb155-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>()</span></code></pre></div>
<pre><code>## # A tibble: 1,096 × 2
## # Groups:   date [1,096]
##    date       data              
##    &lt;date&gt;     &lt;list&gt;            
##  1 2004-01-01 &lt;tibble [48 × 20]&gt;
##  2 2004-01-02 &lt;tibble [48 × 20]&gt;
##  3 2004-01-03 &lt;tibble [48 × 20]&gt;
##  4 2004-01-04 &lt;tibble [48 × 20]&gt;
##  5 2004-01-05 &lt;tibble [48 × 20]&gt;
##  6 2004-01-06 &lt;tibble [48 × 20]&gt;
##  7 2004-01-07 &lt;tibble [48 × 20]&gt;
##  8 2004-01-08 &lt;tibble [48 × 20]&gt;
##  9 2004-01-09 &lt;tibble [48 × 20]&gt;
## 10 2004-01-10 &lt;tibble [48 × 20]&gt;
## # … with 1,086 more rows</code></pre>
<p>Here, the data frame has one row per date and therefore the same number of rows as the data frame <code>daily_fluxes</code>, but the data itself is not reduced by a summarising function. Instead, the data are kept at the half-hourly level, but it’s nested inside the new column <code>data</code>, which now contains a list of half-hourly data frames for each day. This is just a brief perspective of what nesting is about. More is explained in Section <a href="datawrangling.html#extramaterialwrangling">3.3</a>. More comprehensive tutorials on nesting and functional programming are provided in <a href="https://dcl-prog.stanford.edu/">Altman, Behrman and Wickham (2021)</a> or in <a href="https://r4ds.had.co.nz/iteration.html">Wickham and Grolemund (2017), Chapter 21</a>.</p>
</div>
<div id="data-cleaning" class="section level3 hasAnchor" number="3.2.10">
<h3><span class="header-section-number">3.2.10</span> Data cleaning<a href="datawrangling.html#data-cleaning" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Data cleaning is often a time-consuming task and decisions taken during data cleaning may be critical for analyses and modelling. In the following, we distinguish between cleaning formats, the identification (and removal) of “bad” data, and the gap-filling of missing or removed data. An excellent resource for further reading is the <a href="https://github.com/Quartz/bad-data-guide">Quartz Guide to Bad Data</a> which provides an overview of how to deal with different types of bad data.</p>
<div id="cleaning-formats" class="section level4 hasAnchor" number="3.2.10.1">
<h4><span class="header-section-number">3.2.10.1</span> Cleaning formats<a href="datawrangling.html#cleaning-formats" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>As a general principle, we want to have <em>machine readable</em> data. Key for achieving machine-readability is that a cell should only contain one value of one type. Hence, for example, character strings should be kept in separate columns (as separate variables) from numeric data. Character strings can impose particular challenges for achieving machine-readability. Typically, they encode categorical or ordinal information, but are prone to spelling inconsistencies or errors that undermine the ordering or categorization. Here are typical examples for challenges working with character strings and lessons for avoiding problems:</p>
<ul>
<li><p>Often, character strings encode the units of a measurement, and entries may be <code>c("kg m-2", "kg/m2", "Kg / m2", "1000 g m-2")</code> . They are all equivalent, but “the machine” treats them as non-identical. To clean such data, one may compile a lookup-table to identify equivalent (but not identical) strings. Much better is to specify a consistent treatment of units before data collection.</p></li>
<li><p>Even if the data are clean and contain a consistently spelled categorical variable in the form of a character string, R doesn’t necessarily treat it as categorical. For certain downstream steps of the workflow, it may be necessary to transform such a variable to one of type <code>factor</code>. For example, as entries of an unordered categorical variable, we have <code>unique(df$gender) = c("female", "male", "non-binary")</code>. To treat them as categorical and not just mere character strings, we would have to do:</p></li>
</ul>
<div class="sourceCode" id="cb157"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb157-1"><a href="datawrangling.html#cb157-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">gender =</span> <span class="fu">as.factor</span>(gender))</span></code></pre></div>
<ul>
<li>Character strings may encode ordinal information. For example, entries specify quality control information and are one of <code>c("good quality", "fair quality, "poor quality")</code>. A challenge could be that the spelling is inconsistent (<code>c("Good quality", "good quality", …)</code>). Using integers (positive natural numbers) instead of character strings avoids such challenges and enforces an order. The quality control variable <code>NEE_VUT_REF_QC</code> in our example dataset <code>half_hourly_fluxes</code> follows this approach:</li>
</ul>
<div class="sourceCode" id="cb158"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb158-1"><a href="datawrangling.html#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(half_hourly_fluxes<span class="sc">$</span>NEE_VUT_REF_QC)</span></code></pre></div>
<pre><code>## [1] 3 2 1 0</code></pre>
<ul>
<li>An entry like <code>&gt;10 m</code> is not a friend of a data scientist. Here, we have three pieces of information: <code>&gt;</code> as in “greater than”, <code>10</code>, and <code>m</code> indicating the units. A machine-readable format would be obtained by creating separate columns for each piece of information. The <code>&gt;</code> should be avoided already at the stage of recording the data. Here, we may have to find a solution for encoding it in a machine readable manner (see <a href="datawrangling.html#exerciseswrangling">Exercises</a>).</li>
</ul>
<!-- -   Can you think of more such examples? (-\> Exercises)  -->
<p>String manipulations are usually required for cleaning data. The Section @ref(#strings) below demonstrates some simple examples.</p>
<p>Note that a majority of machine learning algorithms and other statistical model types require all data to be numeric. Methods exist to convert categorical data into numeric data, as we will learn later. We re-visit data cleaning in the form of data <em>pre-processing</em> as part of the modelling workflow in Chapter <a href="supervisedmli.html#supervisedmli">9</a>.</p>
</div>
<div id="baddata" class="section level4 hasAnchor" number="3.2.10.2">
<h4><span class="header-section-number">3.2.10.2</span> Bad data<a href="datawrangling.html#baddata" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Data may be “bad” for different reasons, including sensor error, human error, a data point representing a different population, or unsuitable measurement conditions. In this sense, data are “bad” if they don’t represent what they are assumed by the user to represent. Its presence in analyses and modelling may undermine the model skill or even lead to spurious results. A goal of data cleaning typically is to remove bad data. But how to detect them? And how safe is it to remove them?</p>
<p>A diversity of processes may generate bad data and it is often not possible to formulate rules and criteria for their identification <em>a priori</em>. Therefore, an understanding of the data and the data generation processes is important for the identification and treatment of bad data. Often, such an understanding is gained by repeated exploratory data analysis cycles, involving the visualization, transformation, and analysis of the data.</p>
<p>Ideally, information about the quality of the data are provided as part of the dataset. Also other meta-information (e.g., sensor type, human recording the data, environmental conditions during the data collection) may be valuable for data cleaning purposes. In our example dataset, the column with suffices <code>_QC</code> provide such information (see ‘Example data’ section above) and an example for their use in data cleaning is given further below.</p>
<p>Bad data may come in the form of <em>outliers</em>, which are commonly defined based on their value with respect to the <em>distribution</em> of all values of the same variable in a dataset. Hence, their identification most commonly relies on quantifying their distance from the center of the variable’s empirical distribution. The default <code>boxplot()</code> plotting function in R (which we will learn about more in Chapter <a href="datavis.html#datavis">4</a>) shows the median (bold line in the center), the upper and lower quartiles (corresponding to the 25% and the 75% quantiles, often referred to as <span class="math inline">\(Q_1\)</span> and <span class="math inline">\(Q_3\)</span> , given by the upper and lower edge of the box plot) and the range of <span class="math inline">\(( Q_1 - 1.5 (Q_3 - Q_1), Q_3 + 1.5 (Q_3 - Q_1))\)</span>. Any point outside this range is plotted by a circle and labeled an “outlier”. However, this definition is very restrictive and may lead to a false labeling of outliers, in particular if they are drawn from a distribution with a fat tail or from asymmetrical distributions.</p>
<p>Outliers may also be identified via multivariate distributions. We will re-visit such methods later, in Chapter <a href="regressionclassification.html#regressionclassification">8</a>. For certain applications, outliers or <em>anomalies</em> may be the target of the investigation, not the noise in the data. This has spurred the field of <a href="https://en.wikipedia.org/wiki/Anomaly_detection"><em>anomaly detection</em></a> which relies on machine learning algorithms for determining whether a value is anomalous, given a set of covariates.</p>
<p>Sensor error or algorithm error may generate spurious values, identified, for example when a continuous variable attains the numerically identical value with a spuriously high frequency.</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb160-1"><a href="datawrangling.html#cb160-1" aria-hidden="true" tabindex="-1"></a>half_hourly_fluxes<span class="sc">$</span>GPP_NT_VUT_REF <span class="sc">|&gt;</span> </span>
<span id="cb160-2"><a href="datawrangling.html#cb160-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">table</span>() <span class="sc">|&gt;</span> </span>
<span id="cb160-3"><a href="datawrangling.html#cb160-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sort</span>(<span class="at">decreasing =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb160-4"><a href="datawrangling.html#cb160-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code></pre></div>
<pre><code>## 
##  5.18422  3.54996   1.3107 -5.57199 0.984756  2.49444 
##       32       22       19       18       17       17</code></pre>
<p>The probability of a certain numeric value of a continuous variable to appear twice in a dataset is practically zero. Here, several values appear multiple times - the value <code>5.18422</code> even 32 times! This must be bad data.</p>
<p>Other processes may lead to spurious trends or <em>drift</em> in the data, for example caused by sensor degradation. Spurious <em>step changes</em> or <em>change points</em> in time series or in (multivariate) regressions may be related to the replacement or deplacement of the measuring device. Different methods and R libraries help identifying such cases (see for example <a href="https://www.marinedatascience.co/blog/2019/09/28/comparison-of-change-point-detection-methods/">this</a> tutorial). Solutions have to be found for the remediation of such spurious patterns in the data on a case-by-case basis.</p>
</div>
<div id="handling-missing-data" class="section level4 hasAnchor" number="3.2.10.3">
<h4><span class="header-section-number">3.2.10.3</span> Handling missing data<a href="datawrangling.html#handling-missing-data" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The question about when data are “bad” and whether to remove it is often critical. Such decisions are important to keep track of and should be reported as transparently as possible in publications. In reality, where the data generation process may start in the field with actual human beings writing notes in a lab book, and where the human collecting the data is often not the same as the human analyzing the data or writing the paper, it’s often more difficult to keep track of such decisions. As a general principle, it is advisable to design data records such that decisions made during the data collection process remain transparent throughout all stages of the workflow and that sufficient information be collected to enable later revisions of particularly critical decisions. In practice, this means that the removal of data and entire rows should be avoided and implemented only at the very last step if necessary (e.g., when passing the data into a model fitting function). Instead, information about whether data are bad should be kept in a separate, categorical, variable (a <em>quality control</em> variable, like <code>*_QC</code> variables in our example data <code>half_hourly_fluxes</code>).</p>
<p>Data may be missing for several reasons. Some yield random patterns of missing data, others not. In the latter case, we can speak of <em>informative missingness</em> (<a href="http://www.feat.engineering/">Kuhn and Johnson, 2019</a>) and its information can be used for modelling. For categorical data, we may replace such data with <code>"none"</code> (instead of <code>NA</code>). Some machine learning algorithms (mainly tree-based methods, e.g., Random Forest) can handle missing values. However, when comparing the performance of alternative ML algorithms, they should be tested with the same data and removing missing data should be done beforehand.</p>
<p>Most machine learning algorithms require missing values to be removed. That is, if any of the cells in one row has a missing value, the entire cell gets removed. This generally leads to a loss of information contained in the remaining variables. Methods exist to <em>impute</em> missing values in order to avoid this information loss. However, the gain of data imputation has to be traded off against effects of associating the available variables with the imputed (knowingly wrong) values, and effects of <em>data leakage</em> have to be considered. Data imputation as part of the modelling process will be dealt with in Chapter <a href="supervisedmli.html#supervisedmli">9</a>.</p>
<p>In our example dataset, some values of <code>SWC_F_MDS_*</code> are given as <code>-9999</code>.</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb162-1"><a href="datawrangling.html#cb162-1" aria-hidden="true" tabindex="-1"></a>half_hourly_fluxes <span class="sc">|&gt;</span> </span>
<span id="cb162-2"><a href="datawrangling.html#cb162-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(TIMESTAMP_START, <span class="fu">starts_with</span>(<span class="st">&quot;SWC_F_MDS_&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb162-3"><a href="datawrangling.html#cb162-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code></pre></div>
<pre><code>## # A tibble: 6 × 9
##   TIMESTAMP_START     SWC_F_MD…¹ SWC_F…² SWC_F…³ SWC_F…⁴ SWC_F…⁵ SWC_F…⁶ SWC_F…⁷
##   &lt;dttm&gt;                   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
## 1 2004-01-01 00:00:00      -9999   -9999   -9999   -9999   -9999   -9999   -9999
## 2 2004-01-01 00:30:00      -9999   -9999   -9999   -9999   -9999   -9999   -9999
## 3 2004-01-01 01:00:00      -9999   -9999   -9999   -9999   -9999   -9999   -9999
## 4 2004-01-01 01:30:00      -9999   -9999   -9999   -9999   -9999   -9999   -9999
## 5 2004-01-01 02:00:00      -9999   -9999   -9999   -9999   -9999   -9999   -9999
## 6 2004-01-01 02:30:00      -9999   -9999   -9999   -9999   -9999   -9999   -9999
## # … with 1 more variable: SWC_F_MDS_4_QC &lt;dbl&gt;, and abbreviated variable names
## #   ¹​SWC_F_MDS_1, ²​SWC_F_MDS_2, ³​SWC_F_MDS_3, ⁴​SWC_F_MDS_4, ⁵​SWC_F_MDS_1_QC,
## #   ⁶​SWC_F_MDS_2_QC, ⁷​SWC_F_MDS_3_QC</code></pre>
<p>When reading the documentation of this specific dataset, we learn that <code>-9999</code> is the code for <em>missing data</em>. The {dplyr} functions help us to clarify these missing values by mutating across all numeric variables and overwrite entries with <code>NA</code> if they hold a <code>-9999</code>.</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb164-1"><a href="datawrangling.html#cb164-1" aria-hidden="true" tabindex="-1"></a>half_hourly_fluxes <span class="ot">&lt;-</span> half_hourly_fluxes <span class="sc">|&gt;</span>  </span>
<span id="cb164-2"><a href="datawrangling.html#cb164-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">na_if</span>(., <span class="sc">-</span><span class="dv">9999</span>)))</span>
<span id="cb164-3"><a href="datawrangling.html#cb164-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-4"><a href="datawrangling.html#cb164-4" aria-hidden="true" tabindex="-1"></a>half_hourly_fluxes <span class="sc">|&gt;</span> </span>
<span id="cb164-5"><a href="datawrangling.html#cb164-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(TIMESTAMP_START, <span class="fu">starts_with</span>(<span class="st">&quot;SWC_F_MDS_&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb164-6"><a href="datawrangling.html#cb164-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code></pre></div>
<pre><code>## # A tibble: 6 × 9
##   TIMESTAMP_START     SWC_F_MD…¹ SWC_F…² SWC_F…³ SWC_F…⁴ SWC_F…⁵ SWC_F…⁶ SWC_F…⁷
##   &lt;dttm&gt;                   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
## 1 2004-01-01 00:00:00         NA      NA      NA      NA      NA      NA      NA
## 2 2004-01-01 00:30:00         NA      NA      NA      NA      NA      NA      NA
## 3 2004-01-01 01:00:00         NA      NA      NA      NA      NA      NA      NA
## 4 2004-01-01 01:30:00         NA      NA      NA      NA      NA      NA      NA
## 5 2004-01-01 02:00:00         NA      NA      NA      NA      NA      NA      NA
## 6 2004-01-01 02:30:00         NA      NA      NA      NA      NA      NA      NA
## # … with 1 more variable: SWC_F_MDS_4_QC &lt;dbl&gt;, and abbreviated variable names
## #   ¹​SWC_F_MDS_1, ²​SWC_F_MDS_2, ³​SWC_F_MDS_3, ⁴​SWC_F_MDS_4, ⁵​SWC_F_MDS_1_QC,
## #   ⁶​SWC_F_MDS_2_QC, ⁷​SWC_F_MDS_3_QC</code></pre>
<p>This lets us visualise the data and its gaps with <code>vis_miss()</code> from the {visdat} package. Visualising missing data can be informative for making decisions about dropping rows with missing data versus removing predictors from the analysis (which would imply too much data removal).</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb166-1"><a href="datawrangling.html#cb166-1" aria-hidden="true" tabindex="-1"></a>visdat<span class="sc">::</span><span class="fu">vis_miss</span>(</span>
<span id="cb166-2"><a href="datawrangling.html#cb166-2" aria-hidden="true" tabindex="-1"></a>  half_hourly_fluxes <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10000</span>),</span>
<span id="cb166-3"><a href="datawrangling.html#cb166-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster =</span> <span class="cn">FALSE</span>, </span>
<span id="cb166-4"><a href="datawrangling.html#cb166-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">warn_large_data =</span> <span class="cn">FALSE</span></span>
<span id="cb166-5"><a href="datawrangling.html#cb166-5" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-85-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>For many applications, we want to filter the data so that the values of particular variables satisfy certain conditions. The {dplyr} function used for such tasks is <code>filter()</code>. As argument, it takes the expressions that specify the criterion for filtering using logical operators (<code>&gt;, &gt;=, &lt;, ==, !-, ...</code>, see Chapter <a href="gettingstarted.html#gettingstarted">1</a>). Multiple filtering criteria can be combined with logical (boolean) operators:</p>
<ul>
<li><code>&amp;</code>: logical AND</li>
<li><code>|</code>: logical OR</li>
<li><code>!</code> logical NOT</li>
</ul>
<p>For example, if we wanted only those rows in our data where NEE is based on measured or good quality gap-filled NEE data, we write:</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb167-1"><a href="datawrangling.html#cb167-1" aria-hidden="true" tabindex="-1"></a>half_hourly_fluxes <span class="sc">|&gt;</span></span>
<span id="cb167-2"><a href="datawrangling.html#cb167-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(NEE_VUT_REF_QC <span class="sc">==</span> <span class="dv">0</span> <span class="sc">|</span> NEE_VUT_REF_QC <span class="sc">==</span> <span class="dv">1</span>)</span></code></pre></div>
<p>For evaluating multiple OR operations simultaneously, we can write alternatively and equivalently:</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb168-1"><a href="datawrangling.html#cb168-1" aria-hidden="true" tabindex="-1"></a>half_hourly_fluxes <span class="sc">|&gt;</span></span>
<span id="cb168-2"><a href="datawrangling.html#cb168-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(NEE_VUT_REF_QC <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span></code></pre></div>
<p>Note that <code>filter()</code> removes entire rows. In some cases this is undesired and it is preferred to replace bad quality values with <code>NA</code>. It is important to note that specifying a value as missing is information itself. Dropping an entire row leads to the loss of this information. For cases where we do not want to drop entire rows when applying <code>filter()</code>, we can just replace certain values with <code>NA</code>. In our case, where we want to retain only data where NEE is based on actual measurements or good quality gap-filling, we can do this by:</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb169-1"><a href="datawrangling.html#cb169-1" aria-hidden="true" tabindex="-1"></a>half_hourly_fluxes <span class="sc">|&gt;</span> </span>
<span id="cb169-2"><a href="datawrangling.html#cb169-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">GPP_NT_VUT_REF =</span> <span class="fu">ifelse</span>(NEE_VUT_REF_QC <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>), GPP_NT_VUT_REF, <span class="cn">NA</span>))</span></code></pre></div>
<p>If we decide to drop a row containing <code>NA</code> in any of the variables later during the workflow, we can do this, for example using the useful {tidyr} function <code>drop_na()</code>.</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="datawrangling.html#cb170-1" aria-hidden="true" tabindex="-1"></a>half_hourly_fluxes <span class="sc">|&gt;</span> </span>
<span id="cb170-2"><a href="datawrangling.html#cb170-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span></code></pre></div>
<p>An excellent source for a more comprehensive introduction to missing data handling is given in <a href="https://bookdown.org/max/FES/handling-missing-data.html">Kuhn and Johnson (2019)</a>.</p>
</div>
</div>
<div id="writing-data-to-csv" class="section level3 hasAnchor" number="3.2.11">
<h3><span class="header-section-number">3.2.11</span> Writing data to CSV<a href="datawrangling.html#writing-data-to-csv" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>After having applied some data reduction and cleaning steps above, let’s save the data frame in the form of a CSV file for use in later chapters.</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb171-1"><a href="datawrangling.html#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(half_hourly_fluxes, <span class="at">file =</span> <span class="st">&quot;data/FLX_CH-Lae_FLUXNET2015_FULLSET_HH_2004-2006_CLEAN.csv&quot;</span>)</span></code></pre></div>
<blockquote>
<p>Note: Making a file publicly available as a <code>.rds</code> or <code>.RData</code> file (explained in Chapter <a href="gettingstarted.html#gettingstarted">1</a>) violates the open science principles (introduced in Chapter <a href="openscience.html#openscience">6</a>). These two formats make it very easy to save R objects related to your analysis project, but are not adequate to save <em>data</em>. Therefore, whenever possible, save your data in a format that is readable across platforms without requiring proprietary software. Hence use <code>write_csv()</code> from {readr} whenever possible. We will encounter other non-proprietary formats that let you save and share more complex data structures in Chapter <a href="datavariety.html#datavariety">5</a>.</p>
</blockquote>
</div>
<div id="combining-relational-data" class="section level3 hasAnchor" number="3.2.12">
<h3><span class="header-section-number">3.2.12</span> Combining relational data<a href="datawrangling.html#combining-relational-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Often, data are spread across multiple files and tables and need to be combined for the planned analysis. In the simplest case, data frames have an identical number of columns, arranged in the same order, and we can “stack” them along rows:</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="datawrangling.html#cb172-1" aria-hidden="true" tabindex="-1"></a>co2_conc_subset_1</span></code></pre></div>
<pre><code>## # A tibble: 6 × 4
##   month `1959` `1960` `1961`
##   &lt;ord&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1 Jan     315.   316.   317.
## 2 Feb     316.   317.   318.
## 3 Mar     316.   317.   318.
## 4 Apr     318.   319.   319.
## 5 May     318.   320.   320.
## 6 Jun     318    319.   320.</code></pre>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="datawrangling.html#cb174-1" aria-hidden="true" tabindex="-1"></a>co2_conc_subset_2</span></code></pre></div>
<pre><code>## # A tibble: 6 × 4
##   month `1959` `1960` `1961`
##   &lt;ord&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
## 1 Jul     316.   318.   318.
## 2 Aug     315.   316.   317.
## 3 Sep     314.   314    315.
## 4 Oct     313.   314.   315.
## 5 Nov     315.   315.   316.
## 6 Dec     315.   316.   317.</code></pre>
<div class="sourceCode" id="cb176"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb176-1"><a href="datawrangling.html#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_rows</span>(co2_conc_subset_1, co2_conc_subset_2)</span></code></pre></div>
<pre><code>## # A tibble: 12 × 4
##    month `1959` `1960` `1961`
##    &lt;ord&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
##  1 Jan     315.   316.   317.
##  2 Feb     316.   317.   318.
##  3 Mar     316.   317.   318.
##  4 Apr     318.   319.   319.
##  5 May     318.   320.   320.
##  6 Jun     318    319.   320.
##  7 Jul     316.   318.   318.
##  8 Aug     315.   316.   317.
##  9 Sep     314.   314    315.
## 10 Oct     313.   314.   315.
## 11 Nov     315.   315.   316.
## 12 Dec     315.   316.   317.</code></pre>
<p>In other cases, data frames may have an identical set of rows (and arranged in the same order) and we can “stack” them along columns.</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb178-1"><a href="datawrangling.html#cb178-1" aria-hidden="true" tabindex="-1"></a>co2_conc_subset_3</span></code></pre></div>
<pre><code>## # A tibble: 12 × 3
##    month `1959` `1960`
##    &lt;ord&gt;  &lt;dbl&gt;  &lt;dbl&gt;
##  1 Jan     315.   316.
##  2 Feb     316.   317.
##  3 Mar     316.   317.
##  4 Apr     318.   319.
##  5 May     318.   320.
##  6 Jun     318    319.
##  7 Jul     316.   318.
##  8 Aug     315.   316.
##  9 Sep     314.   314 
## 10 Oct     313.   314.
## 11 Nov     315.   315.
## 12 Dec     315.   316.</code></pre>
<div class="sourceCode" id="cb180"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb180-1"><a href="datawrangling.html#cb180-1" aria-hidden="true" tabindex="-1"></a>co2_conc_subset_4</span></code></pre></div>
<pre><code>## # A tibble: 12 × 2
##    month `1961`
##    &lt;ord&gt;  &lt;dbl&gt;
##  1 Jan     317.
##  2 Feb     318.
##  3 Mar     318.
##  4 Apr     319.
##  5 May     320.
##  6 Jun     320.
##  7 Jul     318.
##  8 Aug     317.
##  9 Sep     315.
## 10 Oct     315.
## 11 Nov     316.
## 12 Dec     317.</code></pre>
<div class="sourceCode" id="cb182"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb182-1"><a href="datawrangling.html#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bind_cols</span>(co2_conc_subset_3, co2_conc_subset_4)</span></code></pre></div>
<pre><code>## New names:
## • `month` -&gt; `month...1`
## • `month` -&gt; `month...4`</code></pre>
<pre><code>## # A tibble: 12 × 5
##    month...1 `1959` `1960` month...4 `1961`
##    &lt;ord&gt;      &lt;dbl&gt;  &lt;dbl&gt; &lt;ord&gt;      &lt;dbl&gt;
##  1 Jan         315.   316. Jan         317.
##  2 Feb         316.   317. Feb         318.
##  3 Mar         316.   317. Mar         318.
##  4 Apr         318.   319. Apr         319.
##  5 May         318.   320. May         320.
##  6 Jun         318    319. Jun         320.
##  7 Jul         316.   318. Jul         318.
##  8 Aug         315.   316. Aug         317.
##  9 Sep         314.   314  Sep         315.
## 10 Oct         313.   314. Oct         315.
## 11 Nov         315.   315. Nov         316.
## 12 Dec         315.   316. Dec         317.</code></pre>
<p>But beware! In particular the stacking along columns (<code>bind_cols()</code>) is very error-prone and should be avoided. Since a <em>tidy</em> data frame regards each row as an instance of associated measurements, the rows of the two data frames and their order must match exactly. Otherwise, an error is raised or (even worse) rows get associated when they shouldn’t be. In such cases, where information about a common set of observations is distributed across multiple data objects, we are dealing with <em>relational data</em>. The key for their combination (or “merging”) is the <em>join variable</em> - the column that is present in both data frames and which contains values along which the merging of the two data frames is performed. In our example from above, this is <code>month</code>, and we can use the {dplyr} function <code>left_join()</code>.</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb185-1"><a href="datawrangling.html#cb185-1" aria-hidden="true" tabindex="-1"></a>co2_conc_subset_3 <span class="sc">|&gt;</span></span>
<span id="cb185-2"><a href="datawrangling.html#cb185-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(), <span class="at">replace =</span> <span class="cn">FALSE</span>)) <span class="sc">|&gt;</span>  <span class="co"># re-shuffling rows</span></span>
<span id="cb185-3"><a href="datawrangling.html#cb185-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(co2_conc_subset_4, <span class="at">by =</span> <span class="st">&quot;month&quot;</span>) <span class="sc">|&gt;</span> </span>
<span id="cb185-4"><a href="datawrangling.html#cb185-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(month)  <span class="co"># sort in ascending order</span></span></code></pre></div>
<pre><code>## # A tibble: 12 × 4
##    month `1959` `1960` `1961`
##    &lt;ord&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
##  1 Jan     315.   316.   317.
##  2 Feb     316.   317.   318.
##  3 Mar     316.   317.   318.
##  4 Apr     318.   319.   319.
##  5 May     318.   320.   320.
##  6 Jun     318    319.   320.
##  7 Jul     316.   318.   318.
##  8 Aug     315.   316.   317.
##  9 Sep     314.   314    315.
## 10 Oct     313.   314.   315.
## 11 Nov     315.   315.   316.
## 12 Dec     315.   316.   317.</code></pre>
<p>Note that here, we first re-shuffled (permuted) the rows of <code>df6</code> for demonstration purposes, and arranged the output data frame again by <code>month</code> - an ordinal variable. <code>left_join()</code> is not compromised by the order of the rows, but instead relies on the join variable, specified by the argument <code>by = "month"</code>, for associating (merging, joining) the two data frames. In some cases, multiple columns may act as the joining variables in their combination (for example <code>by = c("year", "month")</code>).</p>
<p>Other variants of <code>*_join()</code> are available as described <a href="https://r4ds.had.co.nz/relational-data.html">here</a>.</p>
</div>
</div>
<div id="extramaterialwrangling" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Extra material<a href="datawrangling.html#extramaterialwrangling" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="functional-programming-i" class="section level3 hasAnchor" number="3.3.1">
<h3><span class="header-section-number">3.3.1</span> Functional programming I<a href="datawrangling.html#functional-programming-i" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Above, we read a CSV table into R and applied several data transformation steps. In practice, we often have to apply the same data transformation steps repeatedly over a set of similar objects. This <em>extra material</em> section outlines an example workflow for demonstrating how to efficiently work with lists of similar objects - in particular, lists of data frames.</p>
<p>Our aim is to read a set of files into R data frames and apply transformation steps to each data frame separately. Here, we will work with daily data, not half-hourly data. The daily data contains largely identical variables with consistent naming and units as in the half-hourly data (description above). Let’s start by creating a list of paths that point to the files with daily data. They are all located in the directory <code>"./data"</code> and share a certain string of characters in their file names <code>"_FLUXNET2015_FULLSET_DD_"</code>.</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="datawrangling.html#cb187-1" aria-hidden="true" tabindex="-1"></a>vec_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;./data&quot;</span>, <span class="at">pattern =</span> <span class="st">&quot;_FLUXNET2015_FULLSET_DD_&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb187-2"><a href="datawrangling.html#cb187-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(vec_files)</span></code></pre></div>
<pre><code>## [1] &quot;./data/FLX_CH-Dav_FLUXNET2015_FULLSET_DD_1997-2014_1-3.csv&quot;
## [2] &quot;./data/FLX_CH-Lae_FLUXNET2015_FULLSET_DD_2004-2014_1-4.csv&quot;
## [3] &quot;./data/FLX_FI-Hyy_FLUXNET2015_FULLSET_DD_1996-2014_1-3.csv&quot;
## [4] &quot;./data/FLX_FR-Pue_FLUXNET2015_FULLSET_DD_2000-2014_2-3.csv&quot;</code></pre>
<blockquote>
<p>To reproduce this code chunk, you can download the files <code>FLX_CH-Lae_FLUXNET2015_FULLSET_HH_2004-2006.csv</code> from <a href="https://github.com/geco-bern/agds/tree/main/data">here</a> and read it from the local path where the file is stored on your machine.</p>
</blockquote>
<p><code>vec_files</code> is now a vector of three files paths as character strings. To read in the three files and combine the three data frames (<code>list_df</code> below) into a list of data frames, we could use a <code>for</code> loop:</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="datawrangling.html#cb189-1" aria-hidden="true" tabindex="-1"></a>list_df <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb189-2"><a href="datawrangling.html#cb189-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (ifil <span class="cf">in</span> vec_files){</span>
<span id="cb189-3"><a href="datawrangling.html#cb189-3" aria-hidden="true" tabindex="-1"></a>  list_df[[ifil]] <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(ifil)</span>
<span id="cb189-4"><a href="datawrangling.html#cb189-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Repeatedly applying a function (here <code>read_csv()</code>) over a list similar objects is facilitated by the <code>map*()</code> family of functions from the {purrr} package. An (almost) equivalent statement is:</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb190-1"><a href="datawrangling.html#cb190-1" aria-hidden="true" tabindex="-1"></a>list_df <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(<span class="fu">as.list</span>(vec_files), <span class="sc">~</span><span class="fu">read_csv</span>(.))</span></code></pre></div>
<p>Here, <code>purrr::map()</code> applies the function <code>read_csv()</code> to elements of a <em>list</em>. Hence, we first have to convert the vector <code>vec_files</code> to a list. A list is always the first argument within the <code>purrr::map()</code> function. Note two new symbols (<code>~</code> and <code>.</code>). The <code>~</code> always goes before the function that is repeatedly applied (or “mapped”) to elements of the list. The <code>.</code> indicates where the elements of the list would go if spelled out (e.g., here, <code>read_csv(.)</code> would be <code>read_csv("./data/FLX_CH-Dav_FLUXNET2015_FULLSET_DD_1997-2014_1-3.csv")</code> for the first iteration). The output of <code>purrr::map()</code> is again a list. There are many variants of the function <code>purrr::map()</code> that each have a specific use. A complete reference for all {purrr} functions is available <a href="https://purrr.tidyverse.org/reference/index.html">here</a>. A useful and more extensive tutorial on {purrr} is available <a href="https://www.r-bloggers.com/one-stop-tutorial-on-purrr-package-in-r/">here</a>.</p>
<p>The above <code>purrr::map()</code> call does not return a <em>named</em> list as our <code>for</code> loop created. But we can give each element of the returned list of data frames different names by:</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="datawrangling.html#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(list_df) <span class="ot">&lt;-</span> vec_files  <span class="co"># this makes it a named list</span></span></code></pre></div>
<p>Next, we will apply a similar data cleaning procedure to this data set as we did above for half-hourly data. To do so, we “package” the individual cleaning steps into a function …</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb192-1"><a href="datawrangling.html#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="co"># function definition</span></span>
<span id="cb192-2"><a href="datawrangling.html#cb192-2" aria-hidden="true" tabindex="-1"></a>clean_data_dd <span class="ot">&lt;-</span> <span class="cf">function</span>(df){</span>
<span id="cb192-3"><a href="datawrangling.html#cb192-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-4"><a href="datawrangling.html#cb192-4" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb192-5"><a href="datawrangling.html#cb192-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-6"><a href="datawrangling.html#cb192-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># select only the variables we are interested in</span></span>
<span id="cb192-7"><a href="datawrangling.html#cb192-7" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb192-8"><a href="datawrangling.html#cb192-8" aria-hidden="true" tabindex="-1"></a>      TIMESTAMP,</span>
<span id="cb192-9"><a href="datawrangling.html#cb192-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ends_with</span>(<span class="st">&quot;_F&quot;</span>),</span>
<span id="cb192-10"><a href="datawrangling.html#cb192-10" aria-hidden="true" tabindex="-1"></a>      GPP_NT_VUT_REF,</span>
<span id="cb192-11"><a href="datawrangling.html#cb192-11" aria-hidden="true" tabindex="-1"></a>      NEE_VUT_REF_QC,</span>
<span id="cb192-12"><a href="datawrangling.html#cb192-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">starts_with</span>(<span class="st">&quot;SWC_F_MDS_&quot;</span>),</span>
<span id="cb192-13"><a href="datawrangling.html#cb192-13" aria-hidden="true" tabindex="-1"></a>      <span class="sc">-</span><span class="fu">contains</span>(<span class="st">&quot;JSB&quot;</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb192-14"><a href="datawrangling.html#cb192-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-15"><a href="datawrangling.html#cb192-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># convert to a nice date object</span></span>
<span id="cb192-16"><a href="datawrangling.html#cb192-16" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">TIMESTAMP =</span> lubridate<span class="sc">::</span><span class="fu">ymd</span>(TIMESTAMP)) <span class="sc">|&gt;</span></span>
<span id="cb192-17"><a href="datawrangling.html#cb192-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-18"><a href="datawrangling.html#cb192-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># set all -9999 to NA</span></span>
<span id="cb192-19"><a href="datawrangling.html#cb192-19" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">na_if</span>(., <span class="sc">-</span><span class="dv">9999</span>)))</span>
<span id="cb192-20"><a href="datawrangling.html#cb192-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb192-21"><a href="datawrangling.html#cb192-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(df)</span>
<span id="cb192-22"><a href="datawrangling.html#cb192-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>… and apply this function to each data frame within our list of data frames:</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="datawrangling.html#cb193-1" aria-hidden="true" tabindex="-1"></a>list_df <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(list_df, <span class="sc">~</span><span class="fu">clean_data_dd</span>(.))</span></code></pre></div>
<p>Having different data frames as elements of a list may be impractical. Since we read in similarly formatted files and selected always the same variables in each data frame, all elements of the list of data frames <code>list_df</code> share the same columns. This suggests that we can collapse our list of data frames and “stack” data frames along rows. As described above, this can be done using <code>bind_rows()</code> and we can automatically create a new column <code>"siteid"</code> in the stacked data frame that takes the name of the corresponding list element.</p>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="datawrangling.html#cb194-1" aria-hidden="true" tabindex="-1"></a>daily_fluxes_allsites <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(list_df, <span class="at">.id =</span> <span class="st">&quot;siteid&quot;</span>)</span>
<span id="cb194-2"><a href="datawrangling.html#cb194-2" aria-hidden="true" tabindex="-1"></a>daily_fluxes_allsites</span></code></pre></div>
<pre><code>## # A tibble: 23,011 × 21
##    siteid      TIMESTAMP    TA_F SW_IN_F LW_IN_F VPD_F  PA_F   P_F  WS_F GPP_N…¹
##    &lt;chr&gt;       &lt;date&gt;      &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;
##  1 ./data/FLX… 1997-01-01 -4.57     77.4    223. 0.565  82.6   0.4 0.559  0.697 
##  2 ./data/FLX… 1997-01-02 -3.34     45.6    235. 0.978  82.9   0   1.11   1.04  
##  3 ./data/FLX… 1997-01-03  0.278    74.1    239. 2.24   82.4   0   2.03  -0.242 
##  4 ./data/FLX… 1997-01-04 -1.88     58.1    250. 1.38   81.7   1.8 1.92   0.247 
##  5 ./data/FLX… 1997-01-05 -4.96     80.8    248. 1.16   82.3   0   0.407  0.520 
##  6 ./data/FLX… 1997-01-06 -4.48     59.6    237. 0.838  82.7   0   0.466  0.0182
##  7 ./data/FLX… 1997-01-07 -3.15     45.5    234. 1.33   82.9   0   1.03   0.0777
##  8 ./data/FLX… 1997-01-08 -2.45     76.7    222. 1.87   82.7   0   1.95  -0.484 
##  9 ./data/FLX… 1997-01-09 -2.43     47.6    251. 1.44   82.2   0   0.785 -0.379 
## 10 ./data/FLX… 1997-01-10 -3.09     39.6    242. 0.776  82.8   0   1.25  -0.552 
## # … with 23,001 more rows, 11 more variables: NEE_VUT_REF_QC &lt;dbl&gt;,
## #   SWC_F_MDS_1 &lt;dbl&gt;, SWC_F_MDS_2 &lt;dbl&gt;, SWC_F_MDS_3 &lt;dbl&gt;,
## #   SWC_F_MDS_1_QC &lt;dbl&gt;, SWC_F_MDS_2_QC &lt;dbl&gt;, SWC_F_MDS_3_QC &lt;dbl&gt;,
## #   SWC_F_MDS_4 &lt;dbl&gt;, SWC_F_MDS_4_QC &lt;dbl&gt;, SWC_F_MDS_5 &lt;dbl&gt;,
## #   SWC_F_MDS_5_QC &lt;dbl&gt;, and abbreviated variable name ¹​GPP_NT_VUT_REF</code></pre>
<p>A visualisation of missing data indicates that soil water content data (<code>SWC_F_MDS_*</code>) are often missing.</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="datawrangling.html#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a subset of the data</span></span>
<span id="cb196-2"><a href="datawrangling.html#cb196-2" aria-hidden="true" tabindex="-1"></a>daily_fluxex_subset <span class="ot">&lt;-</span> daily_fluxes_allsites <span class="sc">|&gt;</span></span>
<span id="cb196-3"><a href="datawrangling.html#cb196-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10000</span>)</span>
<span id="cb196-4"><a href="datawrangling.html#cb196-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-5"><a href="datawrangling.html#cb196-5" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize missing data</span></span>
<span id="cb196-6"><a href="datawrangling.html#cb196-6" aria-hidden="true" tabindex="-1"></a>visdat<span class="sc">::</span><span class="fu">vis_miss</span>(</span>
<span id="cb196-7"><a href="datawrangling.html#cb196-7" aria-hidden="true" tabindex="-1"></a>  daily_fluxex_subset,</span>
<span id="cb196-8"><a href="datawrangling.html#cb196-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster =</span> <span class="cn">FALSE</span>,</span>
<span id="cb196-9"><a href="datawrangling.html#cb196-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">warn_large_data =</span> <span class="cn">FALSE</span></span>
<span id="cb196-10"><a href="datawrangling.html#cb196-10" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-103-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="strings" class="section level3 hasAnchor" number="3.3.2">
<h3><span class="header-section-number">3.3.2</span> Strings<a href="datawrangling.html#strings" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The column <code>siteid</code> currently contains strings specifying the full paths of the files that were read in earlier. The next task is to extract the site name from these strings. The file names follow a clear pattern (this also highlights why naming files wisely can often make life a lot simpler).</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="datawrangling.html#cb197-1" aria-hidden="true" tabindex="-1"></a>daily_fluxes_allsites<span class="sc">$</span>siteid <span class="sc">|&gt;</span> <span class="fu">head</span>()</span></code></pre></div>
<pre><code>## [1] &quot;./data/FLX_CH-Dav_FLUXNET2015_FULLSET_DD_1997-2014_1-3.csv&quot;
## [2] &quot;./data/FLX_CH-Dav_FLUXNET2015_FULLSET_DD_1997-2014_1-3.csv&quot;
## [3] &quot;./data/FLX_CH-Dav_FLUXNET2015_FULLSET_DD_1997-2014_1-3.csv&quot;
## [4] &quot;./data/FLX_CH-Dav_FLUXNET2015_FULLSET_DD_1997-2014_1-3.csv&quot;
## [5] &quot;./data/FLX_CH-Dav_FLUXNET2015_FULLSET_DD_1997-2014_1-3.csv&quot;
## [6] &quot;./data/FLX_CH-Dav_FLUXNET2015_FULLSET_DD_1997-2014_1-3.csv&quot;</code></pre>
<p>The paths each start with the subdirectory where they are located (<code>"./data/"</code>), then <code>"FLX_"</code>, followed by the site name (the first three entries of the table containing data from all sites are for the site <code>"CH-Dav"</code>), and then some more specifications, including the years that respective files’ data cover.</p>
<p>The <a href="https://stringr.tidyverse.org/">{stringr}</a> package (part of tidyverse) offers a set of functions for working with strings. <a href="https://r4ds.had.co.nz/strings.html">Wikham and Grolemund (2017)</a> provide a more comprehensive introduction to working with strings. Here, we would like to extract the six characters, starting at position 12. The function <code>str_sub()</code> does that job.</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="datawrangling.html#cb199-1" aria-hidden="true" tabindex="-1"></a>vec_sites <span class="ot">&lt;-</span> <span class="fu">str_sub</span>(vec_files, <span class="at">start =</span> <span class="dv">12</span>, <span class="at">end =</span> <span class="dv">17</span>)</span>
<span id="cb199-2"><a href="datawrangling.html#cb199-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(vec_sites)</span></code></pre></div>
<pre><code>## [1] &quot;CH-Dav&quot; &quot;CH-Lae&quot; &quot;FI-Hyy&quot; &quot;FR-Pue&quot;</code></pre>
<p>We can use this function to mutate all values of column <code>"siteid"</code>, overwriting it with just these six characters.</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="datawrangling.html#cb201-1" aria-hidden="true" tabindex="-1"></a>daily_fluxes_allsites <span class="ot">&lt;-</span> daily_fluxes_allsites <span class="sc">|&gt;</span></span>
<span id="cb201-2"><a href="datawrangling.html#cb201-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">siteid =</span> <span class="fu">str_sub</span>(siteid, <span class="at">start =</span> <span class="dv">12</span>, <span class="at">end =</span> <span class="dv">17</span>))</span>
<span id="cb201-3"><a href="datawrangling.html#cb201-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-4"><a href="datawrangling.html#cb201-4" aria-hidden="true" tabindex="-1"></a>daily_fluxes_allsites</span></code></pre></div>
<pre><code>## # A tibble: 23,011 × 21
##    siteid TIMESTAMP    TA_F SW_IN_F LW_IN_F VPD_F  PA_F   P_F  WS_F GPP_NT_VUT…¹
##    &lt;chr&gt;  &lt;date&gt;      &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;        &lt;dbl&gt;
##  1 CH-Dav 1997-01-01 -4.57     77.4    223. 0.565  82.6   0.4 0.559       0.697 
##  2 CH-Dav 1997-01-02 -3.34     45.6    235. 0.978  82.9   0   1.11        1.04  
##  3 CH-Dav 1997-01-03  0.278    74.1    239. 2.24   82.4   0   2.03       -0.242 
##  4 CH-Dav 1997-01-04 -1.88     58.1    250. 1.38   81.7   1.8 1.92        0.247 
##  5 CH-Dav 1997-01-05 -4.96     80.8    248. 1.16   82.3   0   0.407       0.520 
##  6 CH-Dav 1997-01-06 -4.48     59.6    237. 0.838  82.7   0   0.466       0.0182
##  7 CH-Dav 1997-01-07 -3.15     45.5    234. 1.33   82.9   0   1.03        0.0777
##  8 CH-Dav 1997-01-08 -2.45     76.7    222. 1.87   82.7   0   1.95       -0.484 
##  9 CH-Dav 1997-01-09 -2.43     47.6    251. 1.44   82.2   0   0.785      -0.379 
## 10 CH-Dav 1997-01-10 -3.09     39.6    242. 0.776  82.8   0   1.25       -0.552 
## # … with 23,001 more rows, 11 more variables: NEE_VUT_REF_QC &lt;dbl&gt;,
## #   SWC_F_MDS_1 &lt;dbl&gt;, SWC_F_MDS_2 &lt;dbl&gt;, SWC_F_MDS_3 &lt;dbl&gt;,
## #   SWC_F_MDS_1_QC &lt;dbl&gt;, SWC_F_MDS_2_QC &lt;dbl&gt;, SWC_F_MDS_3_QC &lt;dbl&gt;,
## #   SWC_F_MDS_4 &lt;dbl&gt;, SWC_F_MDS_4_QC &lt;dbl&gt;, SWC_F_MDS_5 &lt;dbl&gt;,
## #   SWC_F_MDS_5_QC &lt;dbl&gt;, and abbreviated variable name ¹​GPP_NT_VUT_REF</code></pre>
</div>
<div id="functional-programming-ii" class="section level3 hasAnchor" number="3.3.3">
<h3><span class="header-section-number">3.3.3</span> Functional programming II<a href="datawrangling.html#functional-programming-ii" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Functions can be applied to a list of objects of any type. Therefore, <code>purrr::map()</code> is a powerful approach to “iterating” over multiple instances of the same object type and can be used for all sorts of tasks. In the following, list elements are data frames of daily data and the function <code>lm()</code> fits a linear regression model of GPP versus shortwave radiation to each sites’ data. We’ll learn more about fitting statistical models in R in Chapter <a href="regressionclassification.html#regressionclassification">8</a>.</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="datawrangling.html#cb203-1" aria-hidden="true" tabindex="-1"></a>list_linmod <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(list_df, <span class="sc">~</span><span class="fu">lm</span>(GPP_NT_VUT_REF <span class="sc">~</span> SW_IN_F, <span class="at">data =</span> .))</span></code></pre></div>
<p>Note how the <code>.</code> indicates where the elements of <code>list_df</code> go when evaluating the <code>lm()</code> function. This returns a list of linear model objects (the type of objects returned by the <code>lm()</code> function call).</p>
<p>We can spin the functional programming concept further and apply (or map) the <code>summary()</code> function to the <code>lm</code>-model objects to get a list of useful statistics and metrics, and then further extract the element <code>"r.squared"</code> from that list as:</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="datawrangling.html#cb204-1" aria-hidden="true" tabindex="-1"></a>list_linmod <span class="sc">|&gt;</span></span>
<span id="cb204-2"><a href="datawrangling.html#cb204-2" aria-hidden="true" tabindex="-1"></a>  purrr<span class="sc">::</span><span class="fu">map</span>(summary) <span class="sc">|&gt;</span>  <span class="co"># apply the summary() function to each list element</span></span>
<span id="cb204-3"><a href="datawrangling.html#cb204-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dbl</span>(<span class="st">&quot;r.squared&quot;</span>)    <span class="co"># extract R-squared from the list generated by summary()</span></span></code></pre></div>
<pre><code>## ./data/FLX_CH-Dav_FLUXNET2015_FULLSET_DD_1997-2014_1-3.csv 
##                                                  0.4201802 
## ./data/FLX_CH-Lae_FLUXNET2015_FULLSET_DD_2004-2014_1-4.csv 
##                                                  0.5074248 
## ./data/FLX_FI-Hyy_FLUXNET2015_FULLSET_DD_1996-2014_1-3.csv 
##                                                  0.6415685 
## ./data/FLX_FR-Pue_FLUXNET2015_FULLSET_DD_2000-2014_2-3.csv 
##                                                  0.3772839</code></pre>
<p><code>map_dbl()</code> is a variant of the <code>purrr::map()</code> function that returns not a list, but a vector of numeric values of class “double” (hence, the name <code>_dbl</code>). Note further, that providing a character (<code>"r.squared"</code>) as an argument instead of an (unquoted) function name, <code>purrr::map()</code> extracts the correspondingly named list element, instead of applying a function to a list element.</p>
<p>When writing code for an analysis, it’s useful, if not essential, to understand the objects we’re working with, understand its type and shape, and make sense of the results of simple <code>print &lt;object&gt;</code> statements. Data frames are particularly handy as they provide an organisation of data that is particularly intuitive (variables along columns, observations along rows, values in cells). Here, we’re dealing with a list of linear model objects. Can such a list fit into the paradigm of <em>tidy</em> data frames?</p>
<p>Yes, they can. Think of the linear model objects as ‘values’. Values don’t necessarily have to be scalars, but they can be of any type (class).</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="datawrangling.html#cb206-1" aria-hidden="true" tabindex="-1"></a>tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb206-2"><a href="datawrangling.html#cb206-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">siteid =</span> vec_sites,</span>
<span id="cb206-3"><a href="datawrangling.html#cb206-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">linmod =</span> list_linmod</span>
<span id="cb206-4"><a href="datawrangling.html#cb206-4" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 4 × 2
##   siteid linmod      
##   &lt;chr&gt;  &lt;named list&gt;
## 1 CH-Dav &lt;lm&gt;        
## 2 CH-Lae &lt;lm&gt;        
## 3 FI-Hyy &lt;lm&gt;        
## 4 FR-Pue &lt;lm&gt;</code></pre>
<p>The fact that cells can contain any type of object offers a powerful concept. Instead of a linear model object as in the example above, each cell may even contain another data frame. In such a case, we say that the data frame is no longer <em>flat</em>, but <em>nested</em>.</p>
<p>The following creates a nested data frame, where the column <code>data</code> is defined by the list of data frames read from files above (<code>list_df</code>).</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="datawrangling.html#cb208-1" aria-hidden="true" tabindex="-1"></a>tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb208-2"><a href="datawrangling.html#cb208-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">siteid =</span> vec_sites,</span>
<span id="cb208-3"><a href="datawrangling.html#cb208-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> list_df</span>
<span id="cb208-4"><a href="datawrangling.html#cb208-4" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<pre><code>## # A tibble: 4 × 2
##   siteid data                 
##   &lt;chr&gt;  &lt;named list&gt;         
## 1 CH-Dav &lt;tibble [6,574 × 16]&gt;
## 2 CH-Lae &lt;tibble [4,018 × 18]&gt;
## 3 FI-Hyy &lt;tibble [6,940 × 20]&gt;
## 4 FR-Pue &lt;tibble [5,479 × 10]&gt;</code></pre>
<p>We can achieve the same result by directly nesting the flat data frame holding all sites’ data (<code>daily_fluxes_allsites</code>). This is done by combining the <code>group_by()</code>, which we have encountered above when aggregating using <code>summarise()</code>, with the function <code>nest()</code> from the {tidyr} package.</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="datawrangling.html#cb210-1" aria-hidden="true" tabindex="-1"></a>daily_fluxes_allsites <span class="sc">|&gt;</span></span>
<span id="cb210-2"><a href="datawrangling.html#cb210-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(siteid) <span class="sc">|&gt;</span></span>
<span id="cb210-3"><a href="datawrangling.html#cb210-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>()</span></code></pre></div>
<pre><code>## # A tibble: 4 × 2
## # Groups:   siteid [4]
##   siteid data                 
##   &lt;chr&gt;  &lt;list&gt;               
## 1 CH-Dav &lt;tibble [6,574 × 20]&gt;
## 2 CH-Lae &lt;tibble [4,018 × 20]&gt;
## 3 FI-Hyy &lt;tibble [6,940 × 20]&gt;
## 4 FR-Pue &lt;tibble [5,479 × 20]&gt;</code></pre>
<p>The function <code>nest()</code> names the nested data column automatically <code>"data"</code>.</p>
<p>This structure is very useful. For example, for applying functions over sites’ data frames separately (and not over the entire data frame). By combining <code>purrr::map()</code> and <code>mutate()</code>, we can fit linear models on each site’s data frame individually in one go.</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="datawrangling.html#cb212-1" aria-hidden="true" tabindex="-1"></a>daily_fluxes_allsites <span class="sc">|&gt;</span></span>
<span id="cb212-2"><a href="datawrangling.html#cb212-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(siteid) <span class="sc">|&gt;</span></span>
<span id="cb212-3"><a href="datawrangling.html#cb212-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">|&gt;</span></span>
<span id="cb212-4"><a href="datawrangling.html#cb212-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">linmod =</span> purrr<span class="sc">::</span><span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">lm</span>(GPP_NT_VUT_REF <span class="sc">~</span> SW_IN_F, <span class="at">data =</span> .)))</span></code></pre></div>
<p>This approach is extremely powerful and lets you stick to working with tidy data frames and use the rows-dimension flexibly. Here, rows are sites and no longer time steps, while the nested data frames in column <code>"data"</code> have time steps along their rows. The power of nesting is also to facilitate complex aggregation steps over a specified dimension (or axis of variation, here given by <code>siteid</code>), where the aggregating function is not limited to taking a vector as input and returning a scalar, as is the case for applications of <code>summarise()</code> (see above).</p>
<p>Combining the steps described above into a single workflow, we have:</p>
<div class="sourceCode" id="cb213"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb213-1"><a href="datawrangling.html#cb213-1" aria-hidden="true" tabindex="-1"></a>daily_fluxes_allsites_nested <span class="ot">&lt;-</span> daily_fluxes_allsites <span class="sc">|&gt;</span></span>
<span id="cb213-2"><a href="datawrangling.html#cb213-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(siteid) <span class="sc">|&gt;</span></span>
<span id="cb213-3"><a href="datawrangling.html#cb213-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nest</span>() <span class="sc">|&gt;</span></span>
<span id="cb213-4"><a href="datawrangling.html#cb213-4" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">linmod =</span> purrr<span class="sc">::</span><span class="fu">map</span>(data, <span class="sc">~</span><span class="fu">lm</span>(GPP_NT_VUT_REF <span class="sc">~</span> SW_IN_F, <span class="at">data =</span> .))) <span class="sc">|&gt;</span></span>
<span id="cb213-5"><a href="datawrangling.html#cb213-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">summ =</span> purrr<span class="sc">::</span><span class="fu">map</span>(linmod, <span class="sc">~</span><span class="fu">summary</span>(.))) <span class="sc">|&gt;</span></span>
<span id="cb213-6"><a href="datawrangling.html#cb213-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(<span class="at">rsq =</span> <span class="fu">map_dbl</span>(summ, <span class="st">&quot;r.squared&quot;</span>)) <span class="sc">|&gt;</span></span>
<span id="cb213-7"><a href="datawrangling.html#cb213-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(rsq))  <span class="co"># to arrange output, with highest r-squared on top</span></span>
<span id="cb213-8"><a href="datawrangling.html#cb213-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-9"><a href="datawrangling.html#cb213-9" aria-hidden="true" tabindex="-1"></a>daily_fluxes_allsites_nested</span></code></pre></div>
<pre><code>## # A tibble: 4 × 5
## # Groups:   siteid [4]
##   siteid data                  linmod summ         rsq
##   &lt;chr&gt;  &lt;list&gt;                &lt;list&gt; &lt;list&gt;     &lt;dbl&gt;
## 1 FI-Hyy &lt;tibble [6,940 × 20]&gt; &lt;lm&gt;   &lt;smmry.lm&gt; 0.642
## 2 CH-Lae &lt;tibble [4,018 × 20]&gt; &lt;lm&gt;   &lt;smmry.lm&gt; 0.507
## 3 CH-Dav &lt;tibble [6,574 × 20]&gt; &lt;lm&gt;   &lt;smmry.lm&gt; 0.420
## 4 FR-Pue &lt;tibble [5,479 × 20]&gt; &lt;lm&gt;   &lt;smmry.lm&gt; 0.377</code></pre>
<p>This code is a demonstration of the power of tidy and nested data frames and for the clarity of the {tidyverse} syntax.</p>
<p>Nesting is useful also for avoiding value duplication when joining relational data objects. Above, we nested time series data objects (where time steps and sites are both organised along rows) by sites and got a data frame where only sites are organised along rows, while time steps are nested inside the column <code>"data"</code>. This now fits the structure of a relational data object (<code>siteinfo_fluxnet2015</code>) containing site-specific meta information (also with only sites along rows).</p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="datawrangling.html#cb215-1" aria-hidden="true" tabindex="-1"></a>base<span class="sc">::</span><span class="fu">load</span>(<span class="st">&quot;data/siteinfo_fluxnet2015.rda&quot;</span>)  <span class="co"># loads siteinfo_fluxnet2015</span></span></code></pre></div>
<p>Joining the nested data frame with site meta information results in a substantially smaller and much handier data frame compared to an alternative, where the site meta information is joined into the un-nested (daily) data frame, and therefore duplicated for each day within sites.</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="datawrangling.html#cb216-1" aria-hidden="true" tabindex="-1"></a>daily_fluxes_allsites_nested_joined <span class="ot">&lt;-</span> siteinfo_fluxnet2015 <span class="sc">|&gt;</span></span>
<span id="cb216-2"><a href="datawrangling.html#cb216-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">siteid =</span> sitename) <span class="sc">|&gt;</span></span>
<span id="cb216-3"><a href="datawrangling.html#cb216-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(</span>
<span id="cb216-4"><a href="datawrangling.html#cb216-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(daily_fluxes_allsites_nested, <span class="sc">-</span>linmod, <span class="sc">-</span>summ, <span class="sc">-</span>rsq),</span>
<span id="cb216-5"><a href="datawrangling.html#cb216-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">&quot;siteid&quot;</span></span>
<span id="cb216-6"><a href="datawrangling.html#cb216-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb216-7"><a href="datawrangling.html#cb216-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-8"><a href="datawrangling.html#cb216-8" aria-hidden="true" tabindex="-1"></a>daily_fluxes_allsites_joined <span class="ot">&lt;-</span> siteinfo_fluxnet2015 <span class="sc">|&gt;</span></span>
<span id="cb216-9"><a href="datawrangling.html#cb216-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">siteid =</span> sitename) <span class="sc">|&gt;</span></span>
<span id="cb216-10"><a href="datawrangling.html#cb216-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(</span>
<span id="cb216-11"><a href="datawrangling.html#cb216-11" aria-hidden="true" tabindex="-1"></a>    daily_fluxes_allsites,</span>
<span id="cb216-12"><a href="datawrangling.html#cb216-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">&quot;siteid&quot;</span></span>
<span id="cb216-13"><a href="datawrangling.html#cb216-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb216-14"><a href="datawrangling.html#cb216-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-15"><a href="datawrangling.html#cb216-15" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&quot;Flat and joined:&quot;</span>, </span>
<span id="cb216-16"><a href="datawrangling.html#cb216-16" aria-hidden="true" tabindex="-1"></a>            <span class="fu">format</span>(<span class="fu">object.size</span>(daily_fluxes_allsites_joined),  </span>
<span id="cb216-17"><a href="datawrangling.html#cb216-17" aria-hidden="true" tabindex="-1"></a>                   <span class="at">units =</span> <span class="st">&quot;auto&quot;</span>, </span>
<span id="cb216-18"><a href="datawrangling.html#cb216-18" aria-hidden="true" tabindex="-1"></a>                   <span class="at">standard =</span> <span class="st">&quot;SI&quot;</span>)))</span></code></pre></div>
<pre><code>## [1] &quot;Flat and joined: 5.8 MB&quot;</code></pre>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="datawrangling.html#cb218-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">&quot;Nested and joined:&quot;</span>, </span>
<span id="cb218-2"><a href="datawrangling.html#cb218-2" aria-hidden="true" tabindex="-1"></a>            <span class="fu">format</span>(<span class="fu">object.size</span>(daily_fluxes_allsites_nested_joined),  </span>
<span id="cb218-3"><a href="datawrangling.html#cb218-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">units =</span> <span class="st">&quot;auto&quot;</span>, </span>
<span id="cb218-4"><a href="datawrangling.html#cb218-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">standard =</span> <span class="st">&quot;SI&quot;</span>)))</span></code></pre></div>
<pre><code>## [1] &quot;Nested and joined: 3.7 MB&quot;</code></pre>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="datawrangling.html#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="co"># save for later use</span></span>
<span id="cb220-2"><a href="datawrangling.html#cb220-2" aria-hidden="true" tabindex="-1"></a><span class="fu">write_rds</span>(</span>
<span id="cb220-3"><a href="datawrangling.html#cb220-3" aria-hidden="true" tabindex="-1"></a>  daily_fluxes_allsites_nested_joined,</span>
<span id="cb220-4"><a href="datawrangling.html#cb220-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">&quot;data/daily_fluxes_allsites_nested_joined.rds&quot;</span></span>
<span id="cb220-5"><a href="datawrangling.html#cb220-5" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
</div>
</div>
<div id="exerciseswrangling" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> Exercises<a href="datawrangling.html#exerciseswrangling" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<blockquote>
<p><em>Hint</em>: For all exercises remember the resources we provided on finding help in section <a href="programmingprimers.html#findinghelp">2.2.3</a>.</p>
</blockquote>
<div id="star-wars" class="section level3 unnumbered hasAnchor">
<h3>Star wars<a href="datawrangling.html#star-wars" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>{dplyr} comes with a toy dataset <code>dplyr::starwars</code> (just type it into the console to see its content). Have a look at the dataset with <code>View()</code>. Play around with the dataset to get familiar with the {tidyverse} coding style. Use (possibly among others) the functions <code>dplyr::filter()</code>, <code>dplyr::arrange()</code>, <code>dplyr::pull()</code>, <code>dplyr::select()</code>, <code>dplyr::desc()</code> and <code>dplyr::slice()</code> to answer the following questions:</p>
<ul>
<li>How many pale characters come from the planets Ryloth and Naboo?</li>
<li>Who is the oldest among the tallest thirty characters?</li>
<li>What is the name of the smallest character and their starship in “Return of the Jedi”</li>
</ul>
<blockquote>
<p>Hint: Use <code>unnest()</code> to expand columns that contain lists inside cells. The expansion of such columns creates additional rows in the data frame if the cell contained a list with more than one element.</p>
</blockquote>
</div>
<div id="aggregating" class="section level3 unnumbered hasAnchor">
<h3>Aggregating<a href="datawrangling.html#aggregating" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>You have learned about aggregating in the {tidyverse}. Let’s put it in practice.</p>
<ul>
<li><p>Reuse the code in the tutorial to read, reduce, and aggregate the <code>half_hourly_fluxes</code> dataset to the daily scale, calculating the following metrics across half-hourly <code>VPD_F</code> values within each day: mean, 25% quantile, and 75% quantile.</p></li>
<li><p>Retain only the daily data for which the daily mean VPD is among the upper or the lower 10% quantiles.</p></li>
<li><p>Calculate the mean of the 25% and the mean of the 75% quantiles of half-hourly VPD within the upper and lower 10% quantiles of mean daily VPD.</p></li>
</ul>
</div>
<div id="patterns-in-data-quality" class="section level3 unnumbered hasAnchor">
<h3>Patterns in data quality<a href="datawrangling.html#patterns-in-data-quality" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The uncleaned dataset <code>FLX_CH-Lae_FLUXNET2015_FULLSET_HH_2004-2006.csv</code> holds half-hourly data that is sometimes of poor quality. Investigate whether NEE data quality is randomly spread across hours in a day by calculating the proportion of (i) actually measured data, (ii) good quality gap-filled data, (iii) medium quality data, and (iv) poor quality data within each hour-of-day (24 hours per day).</p>
<blockquote>
<p>Hint: <code>summarise(total = n())</code> aggregates by counting the number of values.</p>
</blockquote>
<blockquote>
<p>Hint: <code>summarise(count_0 = sum(x == 0))</code> aggregates by counting the number of values for which the evaluation is <code>TRUE</code>.</p>
</blockquote>
<p>Interpret your findings: Are the proportions evenly spread across hours in a day?</p>
<p>Perform an aggregation of the half-hourly GPP data (variable <code>GPP_NT_VUT_REF</code>) to daily means of the unmodified data read from file <code>FLX_CH-Lae_FLUXNET2015_FULLSET_HH_2004-2006.csv</code>, and from cleaned data where only measured (not gap-filled) data is kept. This yields two data frames with daily GPP data. Calculate the overall mean GPP for the two data frames (across all days in the data frame). Are the overall mean GPP values equal? If not, why?</p>
</div>
</div>
<div id="report-exercise" class="section level2 hasAnchor" number="3.5">
<h2><span class="header-section-number">3.5</span> Report Exercise<a href="datawrangling.html#report-exercise" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="cleaning-data-from-elevated-co_2-experiments" class="section level3 unnumbered hasAnchor">
<h3>Cleaning data from elevated CO<span class="math inline">\(_2\)</span> experiments<a href="datawrangling.html#cleaning-data-from-elevated-co_2-experiments" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Open Science requires that data underlying published research articles is made available upon publication of the article. A separate aspect is the format of the shared data. Is it provided in an open-access data format? How easy is it to use the data for your own analyses? In this exercise, you will encounter data that was made freely available, but not in an open access format. Although it is “nice-looking” data, you will encounter that it is not tidy.</p>
<p>Download the data file (<code>.xlsx</code>) from the Supplementary Material of the following paper:</p>
<p><em>Groenigen, Kees Jan van, Xuan Qi, Craig W. Osenberg, Yiqi Luo, and Bruce A. Hungate. “Faster Decomposition Under Increased Atmospheric CO2 Limits Soil Carbon Storage.” Science 344, no. 6183 (May 2, 2014): 508–9. <a href="https://doi.org/10.1126/science.1249534" class="uri">https://doi.org/10.1126/science.1249534</a>.</em></p>
<p>“Database S1” contains data of soil organic carbon measurements in experiments, where ecosystems are exposed to ambient (low) and elevated (high) CO2 concentrations. The mean soil organic carbon of multiple samples (“n”) is recorded within each experiment for different sample dates. Information is provided for the time in years since the start of the experiment (“Time (years)”).</p>
<p>A log-response ratio (treatment effect on variable <span class="math inline">\(x\)</span>) can be calculated as:</p>
<p><span class="math display">\[
\text{RR} = \ln \left( \frac{x_\text{elevated}}{x_\text{ambient}} \right)
\]</span></p>
<p>Perform the following steps:</p>
<ol style="list-style-type: decimal">
<li><p>Manually clean the data in the tab “Database S1” and save it as a CSV file that can be read into R.</p></li>
<li><p>In R, aggregate data per experiment and calculate the log-response ratio within each experiment.</p></li>
<li><p>Aggregate data across all experiments for different years since the start of the experiment, distinguishing an early phase (&lt;3 years since start), a mid-phase (3-6 years since start), and a late phase (&gt;6 years since start). Calculate the log-response ratio for each phase.</p></li>
</ol>
<blockquote>
<p>Calculate the log-response ratio for each parallel observation of SOC under ambient and elevated CO2, and then aggregate log response ratios by taking their mean (and not the other way round).</p>
</blockquote>
<div id="deliverables-for-the-report" class="section level4 unnumbered hasAnchor">
<h4>Deliverables for the report<a href="datawrangling.html#deliverables-for-the-report" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Document and describe the workflow of steps 2 and 3 in an RMarkdown file. Use R code chunks to run your code and present your results as tables using the <code>knitr::kable()</code> function. Knit your RMarkdown file to HTML and ensure reproducibility of your code (more on this in later Chapters). Add the the RMarkdown as file <code>./vignettes/re_tidy.Rmd</code> to your <em>git</em> repository which you set up following instructions in Section <a href="gettingstarted.html#setupreport">1.2.8.4</a>. Make sure to add also the file that you cleaned “by hand” following step 1 to your repository. You can name it however you like (as long as you read it in correctly) - we will only look at the reproducibility of the RMarkdown notebook. For the final report, you will point us to the URL of your repository. We will fork your repository and reproduce the workflow implemented in your notebook. A reproducible and well-documented workflow is most important for our assessment. If you are unsure about methodological aspects (statistics), you may document alternative choices and their influence on the final results.</p>

</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="programmingprimers.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="datavis.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": true,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "subsection",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
